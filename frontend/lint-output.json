[{"filePath":"D:\\Advanced_Poss\\frontend\\src\\app\\dashboard\\pos\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isSyncing' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":223,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":223,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is defined but never used. Allowed unused args must match /^_/u.","line":583,"column":39,"nodeType":null,"messageId":"unusedVar","endLine":583,"endColumn":43},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'buildItemNotes', 'deliveryDetails', 'discountType', 'formatCurrency', 'guestCount', 'paymentMode', 'roomServiceBookingId', and 'roomServiceBookings'. Either include them or remove the dependency array.","line":1835,"column":6,"nodeType":"ArrayExpression","endLine":1859,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [paymentMode, orderType, roomServiceBookingId, roomServiceBookings, deliveryDetails, takeawayDetails, orderNotes, selectedWaiterName, selectedCustomerId, orderSummary.discount, orderSummary.total, selectedTable, guestCount, deliveryFeeValue, cart, customerInfo, loyaltyRedemption.pointsRedeemed, loyaltyRedemption.discount, createOrderWithRetry, refetchQueue, refetchTables, clearCart, discountMode, discountType, discountValue, formatCurrency, buildItemNotes, resetDeliveryDetails, resetTakeawayDetails]","fix":{"range":[74315,74809],"text":"[paymentMode, orderType, roomServiceBookingId, roomServiceBookings, deliveryDetails, takeawayDetails, orderNotes, selectedWaiterName, selectedCustomerId, orderSummary.discount, orderSummary.total, selectedTable, guestCount, deliveryFeeValue, cart, customerInfo, loyaltyRedemption.pointsRedeemed, loyaltyRedemption.discount, createOrderWithRetry, refetchQueue, refetchTables, clearCart, discountMode, discountType, discountValue, formatCurrency, buildItemNotes, resetDeliveryDetails, resetTakeawayDetails]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\nimport { Badge } from '@/components/ui/Badge';\nimport { Button } from '@/components/ui/Button';\nimport { Calculator } from '@/components/ui/Calculator';\nimport { Card, CardContent } from '@/components/ui/Card';\nimport { Input } from '@/components/ui/Input';\nimport { Modal } from '@/components/ui/Modal';\nimport { useFeatureAccess } from '@/hooks/useFeatureRedirect';\nimport { useFormatCurrency } from '@/hooks/useFormatCurrency';\nimport { Booking, useCreateBookingMutation, useGetBookingsQuery } from '@/lib/api/endpoints/bookingsApi';\nimport { useGetCategoriesQuery } from '@/lib/api/endpoints/categoriesApi';\nimport { useGetCustomerByIdQuery, useLazySearchCustomersQuery } from '@/lib/api/endpoints/customersApi';\nimport { useGetDeliveryZonesByBranchQuery } from '@/lib/api/endpoints/deliveryZonesApi';\nimport { useGetPaymentMethodsByBranchQuery } from '@/lib/api/endpoints/paymentMethodsApi';\nimport type { CreatePOSOrderRequest } from '@/lib/api/endpoints/posApi';\nimport {\n  posApi,\n  useCancelPOSOrderMutation,\n  useCreatePOSOrderMutation,\n  useDownloadReceiptPDFMutation,\n  useGetAvailableTablesQuery,\n  useGetPOSMenuItemsQuery,\n  useGetPOSOrderQuery,\n  useGetPOSOrdersQuery,\n  useGetPOSSettingsQuery,\n  useGetPrintersQuery,\n  useGetReceiptHTMLQuery,\n  useGetWaiterActiveOrdersCountQuery,\n  usePrintReceiptMutation,\n  usePrintReceiptPDFMutation,\n  useProcessPaymentMutation,\n  useUpdatePOSOrderMutation\n} from '@/lib/api/endpoints/posApi';\nimport { useGetRoomsQuery } from '@/lib/api/endpoints/roomsApi';\nimport { useGetStaffQuery } from '@/lib/api/endpoints/staffApi';\nimport { useUpdateTableStatusMutation } from '@/lib/api/endpoints/tablesApi';\nimport { useGetCurrentWorkPeriodQuery } from '@/lib/api/endpoints/workPeriodsApi';\nimport { useOfflineSyncManager } from '@/lib/hooks/useOfflineSyncManager';\nimport { useSocket } from '@/lib/hooks/useSocket';\nimport { cn, formatDateTime } from '@/lib/utils';\nimport { getEncryptedItemWithTTL, removeEncryptedItem, setEncryptedItemWithTTL } from '@/lib/utils/storage-encryption';\nimport {\n  ArrowPathIcon,\n  BuildingOfficeIcon,\n  CheckIcon,\n  ChevronLeftIcon,\n  ChevronRightIcon,\n  ClipboardDocumentListIcon,\n  ClockIcon,\n  CreditCardIcon,\n  CurrencyDollarIcon,\n  DocumentArrowDownIcon,\n  FunnelIcon,\n  HomeModernIcon,\n  InformationCircleIcon,\n  LockClosedIcon,\n  MagnifyingGlassIcon,\n  MinusIcon,\n  PencilSquareIcon,\n  PlusIcon,\n  PrinterIcon,\n  ShoppingBagIcon,\n  ShoppingCartIcon,\n  TableCellsIcon,\n  TrashIcon,\n  TruckIcon,\n  UserGroupIcon,\n} from '@heroicons/react/24/outline';\nimport Image from 'next/image';\nimport { useCallback, useEffect, useMemo, useState } from 'react';\nimport toast from 'react-hot-toast';\ninterface ModifierSelection {\n  group: string;\n  option: string;\n  priceModifier: number;\n}\ninterface ModifierChoice {\n  group: string;\n  options: Array<{\n    name: string;\n    price: number;\n  }>;\n}\ninterface AddonSelection {\n  name: string;\n  price: number;\n}\ninterface CartItem {\n  id: string;\n  menuItemId: string;\n  name: string;\n  basePrice: number;\n  price: number;\n  quantity: number;\n  category: string;\n  notes?: string;\n  modifiersNote?: string;\n  variantSelections?: ModifierSelection[];\n  addonSelections?: AddonSelection[];\n  selectionChoices?: ModifierChoice[];\n}\ninterface OrderSummary {\n  subtotal: number;\n  tax: number;\n  total: number;\n  itemCount: number;\n  deliveryFee: number;\n  discount: number;\n}\ntype OrderType = 'dine-in' | 'delivery' | 'takeaway' | 'room-booking' | 'room-service';\n// Order type options - room booking will be conditionally added based on feature access\nconst BASE_ORDER_TYPE_OPTIONS = [\n  { value: 'dine-in', label: 'Dine-In', icon: HomeModernIcon },\n  { value: 'delivery', label: 'Delivery', icon: TruckIcon },\n  { value: 'takeaway', label: 'Takeaway', icon: ShoppingBagIcon },\n] as const;\nconst ROOM_BOOKING_OPTION = { value: 'room-booking', label: 'Room Booking', icon: BuildingOfficeIcon } as const;\nconst ROOM_SERVICE_OPTION = { value: 'room-service', label: 'Room Service', icon: BuildingOfficeIcon } as const;\n// Order type labels - will be used dynamically\nconst getOrderTypeLabel = (orderType: OrderType): string => {\n  const labels: Record<OrderType, string> = {\n    'dine-in': 'Dine-In',\n    delivery: 'Delivery',\n    takeaway: 'Takeaway',\n    'room-booking': 'Room Booking',\n    'room-service': 'Room Service',\n  };\n  return labels[orderType] || orderType;\n};\nconst ORDER_STATUS_LABELS: Record<'pending' | 'paid' | 'cancelled', string> = {\n  pending: 'Pending',\n  paid: 'Paid',\n  cancelled: 'Cancelled',\n};\nconst ORDER_STATUS_STYLES: Record<'pending' | 'paid' | 'cancelled', string> = {\n  pending: 'bg-amber-500/10 text-amber-200 border border-amber-500/30',\n  paid: 'bg-emerald-500/10 text-emerald-200 border border-emerald-500/30',\n  cancelled: 'bg-rose-500/10 text-rose-200 border border-rose-500/30',\n};\nconst ORDER_STATUS_FILTERS = [\n  { value: 'all', label: 'All Statuses' },\n  { value: 'pending', label: 'Pending' },\n  { value: 'paid', label: 'Paid' },\n  { value: 'cancelled', label: 'Cancelled' },\n] as const;\ninterface DeliveryDetailsState {\n  [key: string]: string;\n  contactName: string;\n  contactPhone: string;\n  addressLine1: string;\n  addressLine2: string;\n  city: string;\n  state: string;\n  postalCode: string;\n  instructions: string;\n  assignedDriver: string;\n}\ninterface TakeawayDetailsState {\n  [key: string]: string;\n  contactName: string;\n  contactPhone: string;\n  instructions: string;\n  assignedDriver: string;\n}\nconst createDefaultDeliveryDetails = (): DeliveryDetailsState => ({\n  contactName: '',\n  contactPhone: '',\n  addressLine1: '',\n  addressLine2: '',\n  city: '',\n  state: '',\n  postalCode: '',\n  instructions: '',\n  assignedDriver: '',\n});\nconst createDefaultTakeawayDetails = (): TakeawayDetailsState => ({\n  contactName: '',\n  contactPhone: '',\n  instructions: '',\n  assignedDriver: '',\n});\nconst sanitizeDetails = <T extends Record<string, string>>(details: T): Partial<T> => {\n  const sanitized: Partial<T> = {};\n  Object.entries(details).forEach(([key, value]) => {\n    if (typeof value === 'string') {\n      const trimmed = value.trim();\n      if (trimmed) {\n        sanitized[key as keyof T] = trimmed as T[keyof T];\n      }\n    }\n  });\n  return sanitized;\n};\ntype ModifierConfig = {\n  quantity: number;\n  variantSelections: Record<string, string>;\n  selectionChoices: Record<string, string[]>;\n  addonSelections: Record<string, boolean>;\n};\ntype SplitPaymentRow = {\n  id: string;\n  method: string; // Payment method code from API\n  amount: string;\n};\ninterface PaymentSuccessState {\n  orderId: string;\n  orderNumber?: string;\n  totalPaid: number;\n  changeDue?: number;\n  summary: string;\n  breakdown?: Array<{ method: string; amount: number }>;\n};\nconst generateClientId = () => {\n  const cryptoRef: any = (globalThis as any)?.crypto;\n  if (cryptoRef && typeof cryptoRef.randomUUID === 'function') {\n    return cryptoRef.randomUUID();\n  }\n  return `${Date.now()}-${Math.random().toString(16).slice(2, 8)}`;\n};\nexport default function POSPage() {\n  const dispatch = useAppDispatch();\n  const { user, companyContext } = useAppSelector((state) => state.auth);\n  const { isOnline, pendingCount, isSyncing } = useOfflineSyncManager();\n  const formatCurrency = useFormatCurrency(); // Use hook to get reactive currency formatting\n  const isOwnerOrManager =\n    user?.role === 'owner' || user?.role === 'super_admin';\n  // Check if user has access to booking management feature (for room booking / room service)\n  const { hasAccess: hasBookingAccess } = useFeatureAccess('booking-management');\n  // Build order type options based on feature access\n  const ORDER_TYPE_OPTIONS = useMemo(() => {\n    if (hasBookingAccess) {\n      return [...BASE_ORDER_TYPE_OPTIONS, ROOM_BOOKING_OPTION, ROOM_SERVICE_OPTION];\n    }\n    return BASE_ORDER_TYPE_OPTIONS;\n  }, [hasBookingAccess]);\n  const {\n    data: activeWorkPeriod,\n    isLoading: workPeriodLoading,\n  } = useGetCurrentWorkPeriodQuery(undefined, {\n    skip: isOwnerOrManager,\n  });\n  // Load from localStorage on mount\n  const [orderType, setOrderType] = useState<OrderType>(() => {\n    if (typeof window !== 'undefined') {\n      const saved = localStorage.getItem('pos_orderType') as OrderType | null;\n      if (\n        saved === 'delivery' ||\n        saved === 'takeaway' ||\n        saved === 'dine-in' ||\n        saved === 'room-booking' ||\n        saved === 'room-service'\n      ) {\n        return saved;\n      }\n    }\n    return 'dine-in';\n  });\n  // Reset orderType to 'dine-in' if user loses access to hotel features and it's currently selected\n  useEffect(() => {\n    if ((orderType === 'room-booking' || orderType === 'room-service') && hasBookingAccess === false) {\n      setOrderType('dine-in');\n      if (typeof window !== 'undefined') {\n        localStorage.setItem('pos_orderType', 'dine-in');\n      }\n    }\n  }, [orderType, hasBookingAccess]);\n  const [selectedTable, setSelectedTable] = useState<string>(() => {\n    if (typeof window !== 'undefined') {\n      return localStorage.getItem('pos_selectedTable') || '';\n    }\n    return '';\n  });\n  const [selectedCategory, setSelectedCategory] = useState<string>('all');\n  const [searchQuery, setSearchQuery] = useState('');\n  const [cart, setCart] = useState<CartItem[]>(() => {\n    if (typeof window !== 'undefined') {\n      const saved = localStorage.getItem('pos_cart');\n      return saved ? JSON.parse(saved) : [];\n    }\n    return [];\n  });\n  const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false);\n  const [isCalculatorOpen, setIsCalculatorOpen] = useState(false);\n  const [customerInfo, setCustomerInfo] = useState(() => {\n    if (typeof window !== 'undefined') {\n      // Use encrypted storage with 24-hour TTL for customer PII\n      const saved = getEncryptedItemWithTTL<{ name: string; phone: string; email: string }>('pos_customerInfo');\n      return saved || { name: '', phone: '', email: '' };\n    }\n    return { name: '', phone: '', email: '' };\n  });\n  const [selectedCustomerId, setSelectedCustomerId] = useState<string>(() => {\n    if (typeof window !== 'undefined') {\n      return localStorage.getItem('pos_customerId') || '';\n    }\n    return '';\n  });\n  // Fetch customer details for loyalty points\n  const { data: selectedCustomer } = useGetCustomerByIdQuery(selectedCustomerId, {\n    skip: !selectedCustomerId,\n  });\n  // Calculate cart subtotal (before discounts) for loyalty redemption\n  const cartSubtotal = useMemo(() => {\n    return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);\n  }, [cart]);\n  // Calculate loyalty redemption based on cart subtotal\n  const loyaltyRedemption = useMemo(() => {\n    if (!selectedCustomer || !selectedCustomerId) {\n      return { pointsRedeemed: 0, discount: 0 };\n    }\n    const MIN_ORDER_AMOUNT = 1000; // Minimum order amount in TK\n    const POINTS_PER_DISCOUNT = 2000; // 2000 points = 20 TK discount\n    const DISCOUNT_AMOUNT = 20; // 20 TK discount per 2000 points\n    const availablePoints = selectedCustomer.loyaltyPoints || 0;\n    // Check if order meets minimum amount requirement\n    if (cartSubtotal < MIN_ORDER_AMOUNT) {\n      return { pointsRedeemed: 0, discount: 0 };\n    }\n    // Calculate how many discount blocks can be applied\n    const discountBlocks = Math.floor(availablePoints / POINTS_PER_DISCOUNT);\n    if (discountBlocks > 0) {\n      // Apply maximum discount blocks (can be limited by order total)\n      const maxDiscount = discountBlocks * DISCOUNT_AMOUNT;\n      // Discount cannot exceed cart subtotal\n      const discount = Math.min(maxDiscount, cartSubtotal);\n      // Calculate points to redeem (in full blocks of 2000)\n      const blocksToRedeem = Math.floor(discount / DISCOUNT_AMOUNT);\n      const pointsRedeemed = blocksToRedeem * POINTS_PER_DISCOUNT;\n      return { pointsRedeemed, discount };\n    }\n    return { pointsRedeemed: 0, discount: 0 };\n  }, [selectedCustomer, selectedCustomerId, cartSubtotal]);\n  const [deliveryDetails, setDeliveryDetails] = useState<DeliveryDetailsState>(() => {\n    if (typeof window !== 'undefined') {\n      // Use encrypted storage with 24-hour TTL for delivery PII\n      const saved = getEncryptedItemWithTTL<DeliveryDetailsState>('pos_deliveryDetails');\n      if (saved) {\n        return { ...createDefaultDeliveryDetails(), ...saved };\n      }\n    }\n    return createDefaultDeliveryDetails();\n  });\n  const [deliveryFee, setDeliveryFee] = useState<string>(() => {\n    if (typeof window !== 'undefined') {\n      const saved = localStorage.getItem('pos_deliveryFee');\n      if (saved !== null) {\n        return saved;\n      }\n    }\n    return '0';\n  });\n  const [takeawayDetails, setTakeawayDetails] = useState<TakeawayDetailsState>(() => {\n    if (typeof window !== 'undefined') {\n      const saved = localStorage.getItem('pos_takeawayDetails');\n      if (saved) {\n        try {\n          const parsed = JSON.parse(saved);\n          return { ...createDefaultTakeawayDetails(), ...parsed };\n        } catch (error) {\n          console.warn('Failed to parse saved takeaway details:', error);\n        }\n      }\n    }\n    return createDefaultTakeawayDetails();\n  });\n  const [showKeyboardShortcuts, setShowKeyboardShortcuts] = useState(false);\n  const [isReceiptModalOpen, setIsReceiptModalOpen] = useState(false);\n  const [currentOrderId, setCurrentOrderId] = useState<string>('');\n  const [roomServiceBookingId, setRoomServiceBookingId] = useState<string>('');\n  const [selectedPrinter, setSelectedPrinter] = useState<string>('');\n  const [hasStartedOrder, setHasStartedOrder] = useState<boolean>(() => {\n    if (typeof window !== 'undefined') {\n      return localStorage.getItem('pos_orderStarted') === 'true';\n    }\n    return false;\n  });\n  const [isCartModalOpen, setIsCartModalOpen] = useState(false);\n  const [orderNotes, setOrderNotes] = useState('');\n  const [selectedWaiterId, setSelectedWaiterId] = useState<string>('');\n  const [discountMode, setDiscountMode] = useState<'full' | 'item'>('full');\n  const [discountType, setDiscountType] = useState<'percent' | 'amount'>('percent');\n  const [discountValue, setDiscountValue] = useState('0');\n  const [itemDiscounts, setItemDiscounts] = useState<Record<string, { type: 'percent' | 'amount'; value: string }>>({});\n  const [isItemDiscountModalOpen, setIsItemDiscountModalOpen] = useState(false);\n  const [noteEditor, setNoteEditor] = useState<{ itemId: string; value: string } | null>(null);\n  const [guestCount, setGuestCount] = useState<number>(() => {\n    if (typeof window !== 'undefined') {\n      const saved = localStorage.getItem('pos_guestCount');\n      return saved ? parseInt(saved, 10) || 1 : 1;\n    }\n    return 1;\n  });\n  const [isCustomerLookupOpen, setIsCustomerLookupOpen] = useState(false);\n  const [customerSearchTerm, setCustomerSearchTerm] = useState('');\n  const [modifierEditor, setModifierEditor] = useState<{\n    item: any;\n    quantity: number;\n    variantSelections: Record<string, string>;\n    selectionChoices: Record<string, string[]>;\n    addonSelections: Record<string, boolean>;\n  } | null>(null);\n  // Room booking state\n  const [selectedRoomId, setSelectedRoomId] = useState<string>('');\n  const [checkInDate, setCheckInDate] = useState<string>(() => {\n    const today = new Date();\n    return today.toISOString().split('T')[0];\n  });\n  const [checkOutDate, setCheckOutDate] = useState<string>(() => {\n    const tomorrow = new Date();\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    return tomorrow.toISOString().split('T')[0];\n  });\n  const [numberOfGuests, setNumberOfGuests] = useState<number>(1);\n  const [specialRequests, setSpecialRequests] = useState<string>('');\n  const [paymentTab, setPaymentTab] = useState<'full' | 'multi'>('full');\n  const [fullPaymentMethod, setFullPaymentMethod] = useState<string>('cash'); // Payment method code\n  const [fullPaymentReceived, setFullPaymentReceived] = useState<string>('0');\n  const [multiPayments, setMultiPayments] = useState<SplitPaymentRow[]>([]);\n  const [paymentSuccessOrder, setPaymentSuccessOrder] = useState<PaymentSuccessState | null>(null);\n  const [isQueueCollapsed, setIsQueueCollapsed] = useState(true);\n  const [queueTab, setQueueTab] = useState<'active' | 'history'>('active');\n  const [queueStatusFilter, setQueueStatusFilter] = useState<'all' | 'pending' | 'paid' | 'cancelled'>('pending');\n  const [queueOrderTypeFilter, setQueueOrderTypeFilter] = useState<'all' | 'dine-in' | 'delivery' | 'takeaway'>('all');\n  const [queueSearchInput, setQueueSearchInput] = useState('');\n  const [queueSearchTerm, setQueueSearchTerm] = useState('');\n  const [queueDetailId, setQueueDetailId] = useState<string | null>(null);\n  const [queueActionOrderId, setQueueActionOrderId] = useState<string | null>(null);\n  // Payment modal for pending orders\n  const [isPendingOrderPaymentModalOpen, setIsPendingOrderPaymentModalOpen] = useState(false);\n  const [pendingOrderPaymentMethod, setPendingOrderPaymentMethod] = useState<string>('cash');\n  const [pendingOrderPaymentReceived, setPendingOrderPaymentReceived] = useState<string>('0');\n  // Delivery zones for POS (branch-based)\n  // Use same branch resolution logic as Bookings page so POS + Bookings see the same branch\n  const currentBranchId =\n    (user as any)?.branchId\n    || (companyContext as any)?.branchId\n    || (companyContext as any)?.branches?.[0]?._id\n    || (companyContext as any)?.branches?.[0]?.id\n    || '';\n  const currentCompanyId =\n    (user as any)?.companyId\n    || (companyContext as any)?.companyId\n    || '';\n  const { data: deliveryZones = [], isLoading: zonesLoading } = useGetDeliveryZonesByBranchQuery(\n    { branchId: currentBranchId },\n    { skip: !currentBranchId }\n  );\n  // Payment methods for POS (branch-based, includes system + company + branch methods)\n  const { data: paymentMethods = [], isLoading: paymentMethodsLoading } = useGetPaymentMethodsByBranchQuery(\n    { companyId: currentCompanyId, branchId: currentBranchId },\n    { skip: !currentCompanyId || !currentBranchId }\n  );\n  const resetDeliveryDetails = useCallback(() => {\n    const defaults = createDefaultDeliveryDetails();\n    setDeliveryDetails(defaults);\n    setDeliveryFee('0');\n    if (typeof window !== 'undefined') {\n      removeEncryptedItem('pos_deliveryDetails');\n      localStorage.removeItem('pos_deliveryFee');\n    }\n  }, []);\n  const resetTakeawayDetails = useCallback(() => {\n    const defaults = createDefaultTakeawayDetails();\n    setTakeawayDetails(defaults);\n    if (typeof window !== 'undefined') {\n      localStorage.removeItem('pos_takeawayDetails');\n    }\n  }, []);\n  const requiresTable = orderType === 'dine-in';\n  const requiresDeliveryDetails = orderType === 'delivery';\n  const requiresTakeawayDetails = orderType === 'takeaway';\n  const requiresRoomBooking = orderType === 'room-booking';\n  const requiresRoomService = orderType === 'room-service';\n  const orderTypeLabel = ORDER_TYPE_OPTIONS.find(option => option.value === orderType)?.label ?? 'Dine-In';\n  const activeOrderTypeOption = useMemo(() => ORDER_TYPE_OPTIONS.find(option => option.value === orderType), [orderType, ORDER_TYPE_OPTIONS]);\n  const ActiveOrderIcon = activeOrderTypeOption?.icon ?? HomeModernIcon;\n  // Room booking queries\n  const { data: roomsData, isLoading: roomsLoading } = useGetRoomsQuery(\n    { branchId: currentBranchId, status: 'available' },\n    { skip: !currentBranchId || !requiresRoomBooking }\n  );\n  const [createBooking] = useCreateBookingMutation();\n  const rooms = useMemo(() => {\n    if (!roomsData) return [];\n    const response = roomsData as any;\n    if (Array.isArray(response)) return response;\n    if (response.rooms) return response.rooms;\n    if (response.data) return Array.isArray(response.data) ? response.data : response.data.rooms || [];\n    return [];\n  }, [roomsData]);\n  // Room service bookings - confirmed or checked-in bookings for current branch\n  const {\n    data: roomServiceBookingsResponse,\n    isLoading: roomServiceBookingsLoading,\n  } = useGetBookingsQuery(\n    { branchId: currentBranchId },\n    { skip: !currentBranchId || !requiresRoomService },\n  );\n  const roomServiceBookings: Booking[] = useMemo(() => {\n    if (!roomServiceBookingsResponse) return [];\n    const response = roomServiceBookingsResponse as any;\n    let items: Booking[] = [];\n    if (Array.isArray(response.bookings)) items = response.bookings;\n    else if (Array.isArray(response)) items = response;\n    else if (response.data && Array.isArray(response.data.bookings)) {\n      items = response.data.bookings;\n    }\n    // Only allow room service for confirmed or checked-in bookings\n    return items.filter(\n      (b: Booking) => b.status === 'confirmed' || b.status === 'checked_in',\n    );\n  }, [roomServiceBookingsResponse]);\n  const selectedRoomServiceBooking = useMemo(\n    () => roomServiceBookings.find((b) => b.id === roomServiceBookingId) || null,\n    [roomServiceBookings, roomServiceBookingId],\n  );\n  // Auto-select the first available booking for room service when none is selected\n  useEffect(() => {\n    if (orderType === 'room-service' && !roomServiceBookingId && roomServiceBookings.length > 0) {\n      setRoomServiceBookingId(roomServiceBookings[0].id);\n    }\n  }, [orderType, roomServiceBookingId, roomServiceBookings]);\n  const deliveryFeeValue = useMemo(() => {\n    if (!requiresDeliveryDetails) {\n      return 0;\n    }\n    const parsed = parseFloat(deliveryFee);\n    if (Number.isNaN(parsed) || parsed < 0) {\n      return 0;\n    }\n    return parsed;\n  }, [deliveryFee, requiresDeliveryDetails]);\n  const deliveryIsValid = !requiresDeliveryDetails\n    || (\n      deliveryDetails.addressLine1.trim() !== ''\n      && deliveryDetails.city.trim() !== ''\n      && deliveryDetails.contactPhone.trim() !== ''\n    );\n  const takeawayIsValid = !requiresTakeawayDetails\n    || (\n      takeawayDetails.contactName.trim() !== ''\n      && takeawayDetails.contactPhone.trim() !== ''\n    );\n  const roomBookingIsValid = !requiresRoomBooking || (\n    selectedRoomId !== '' &&\n    checkInDate !== '' &&\n    checkOutDate !== '' &&\n    new Date(checkOutDate) > new Date(checkInDate) &&\n    numberOfGuests > 0\n  );\n  const roomServiceIsValid = !requiresRoomService || roomServiceBookingId !== '';\n  const checkoutBlocked = (requiresTable && !selectedTable)\n    || (requiresDeliveryDetails && !deliveryIsValid)\n    || (requiresTakeawayDetails && !takeawayIsValid)\n    || (requiresRoomBooking && !roomBookingIsValid)\n    || (requiresRoomService && !roomServiceIsValid);\n  const missingDeliveryFields = useMemo(() => {\n    if (!requiresDeliveryDetails) return [] as string[];\n    const missing: string[] = [];\n    if (!deliveryDetails.contactName.trim()) missing.push('contact name');\n    if (!deliveryDetails.contactPhone.trim()) missing.push('contact phone');\n    if (!deliveryDetails.addressLine1.trim()) missing.push('address line 1');\n    if (!deliveryDetails.city.trim()) missing.push('city');\n    return missing;\n  }, [requiresDeliveryDetails, deliveryDetails]);\n  const missingTakeawayFields = useMemo(() => {\n    if (!requiresTakeawayDetails) return [] as string[];\n    const missing: string[] = [];\n    if (!takeawayDetails.contactName.trim()) missing.push('contact name');\n    if (!takeawayDetails.contactPhone.trim()) missing.push('contact phone');\n    return missing;\n  }, [requiresTakeawayDetails, takeawayDetails]);\n  // Socket.IO for real-time updates\n  const { socket, isConnected } = useSocket();\n  // API calls\n  // Note: branchId is extracted from JWT token in backend, no need to pass it\n  const { data: tablesData, isLoading: tablesLoading, error: _tablesError, refetch: refetchTables } = useGetAvailableTablesQuery();\n  // Listen for table status changes via Socket.IO\n  useEffect(() => {\n    if (!socket || !isConnected) {\n      return;\n    }\n    const handleTableStatusChanged = (data: any) => {\n      // Refetch tables when status changes\n      refetchTables();\n    };\n    socket.on('table:status-changed', handleTableStatusChanged);\n    socket.on('table:available', handleTableStatusChanged);\n    socket.on('table:occupied', handleTableStatusChanged);\n    return () => {\n      socket.off('table:status-changed', handleTableStatusChanged);\n      socket.off('table:available', handleTableStatusChanged);\n      socket.off('table:occupied', handleTableStatusChanged);\n    };\n  }, [socket, isConnected, refetchTables]);\n  const { data: categoriesData } = useGetCategoriesQuery({\n    branchId: user?.branchId || undefined,\n  });\n  // Fetch all menu items (no category filter) so we can do client-side filtering\n  // This provides better UX with instant filtering\n  const { data: menuItemsData, isLoading: menuItemsLoading } = useGetPOSMenuItemsQuery({\n    branchId: user?.branchId || undefined,\n    categoryId: undefined, // Always fetch all, filter client-side\n    search: undefined, // Search is done client-side for better UX\n    isAvailable: true,\n  });\n  // Get POS settings for tax rate\n  const { data: posSettings } = useGetPOSSettingsQuery({\n    branchId: user?.branchId || undefined,\n  });\n  // Use nullish coalescing (??) instead of || to allow 0 as a valid tax rate\n  const taxRate = posSettings?.taxRate ?? 10; // Default 10% only if undefined/null\n  // Payment mode: 'pay-first' = pay before creating order, 'pay-later' = create order then pay\n  const [paymentMode, setPaymentMode] = useState<'pay-first' | 'pay-later'>(() => {\n    if (typeof window !== 'undefined') {\n      const saved = localStorage.getItem('pos_paymentMode');\n      if (saved === 'pay-first' || saved === 'pay-later') {\n        return saved;\n      }\n    }\n    return (posSettings?.defaultPaymentMode as 'pay-first' | 'pay-later') || 'pay-later';\n  });\n  // Sync payment mode with settings when they load (only if user hasn't set a preference)\n  useEffect(() => {\n    if (posSettings?.defaultPaymentMode && typeof window !== 'undefined') {\n      const saved = localStorage.getItem('pos_paymentMode');\n      if (!saved) {\n        const defaultMode = posSettings.defaultPaymentMode as 'pay-first' | 'pay-later';\n        setPaymentMode(defaultMode);\n        localStorage.setItem('pos_paymentMode', defaultMode);\n      }\n    }\n  }, [posSettings?.defaultPaymentMode]);\n  // Save payment mode preference when user changes it\n  useEffect(() => {\n    if (typeof window !== 'undefined' && paymentMode) {\n      localStorage.setItem('pos_paymentMode', paymentMode);\n    }\n  }, [paymentMode]);\n  // Extract tables array from response (already transformed by API)\n  const tables = useMemo(() => {\n    if (!tablesData) return [];\n    // Response is already transformed by API transformResponse\n    // Format: Array<{id, number, capacity, status, ...}>\n    return Array.isArray(tablesData) ? tablesData : [];\n  }, [tablesData]);\n  const activeTable = useMemo(() => {\n    return tables.find((t: any) => t.id === selectedTable);\n  }, [tables, selectedTable]);\n  // Extract categories array from response (already transformed by API)\n  const categories = useMemo(() => {\n    return categoriesData?.categories || [];\n  }, [categoriesData]);\n  const [createOrder] = useCreatePOSOrderMutation();\n  const [processPayment] = useProcessPaymentMutation();\n  const [printReceipt] = usePrintReceiptMutation();\n  const [printReceiptPDF] = usePrintReceiptPDFMutation();\n  const [downloadReceiptPDF] = useDownloadReceiptPDFMutation();\n  const [updateOrder] = useUpdatePOSOrderMutation();\n  const { data: printers } = useGetPrintersQuery();\n  const {\n    data: receiptHTML,\n    isFetching: receiptLoading,\n    isError: receiptError,\n    refetch: refetchReceipt,\n    error: receiptErrorDetails,\n  } = useGetReceiptHTMLQuery(currentOrderId, {\n    skip: !currentOrderId,\n  });\n  const queueQueryParams = useMemo(() => {\n    const params: {\n      branchId?: string;\n      status?: string;\n      orderType?: 'dine-in' | 'delivery' | 'takeaway';\n      limit: number;\n      page: number;\n      search?: string;\n    } = {\n      limit: queueTab === 'active' ? 25 : 50,\n      page: 1,\n    };\n    if (user?.branchId) {\n      params.branchId = user.branchId;\n    }\n    if (queueTab === 'active') {\n      params.status = 'pending';\n    } else if (queueStatusFilter !== 'all') {\n      params.status = queueStatusFilter;\n    }\n    if (queueOrderTypeFilter !== 'all') {\n      params.orderType = queueOrderTypeFilter;\n    }\n    if (queueSearchTerm) {\n      params.search = queueSearchTerm;\n    }\n    return params;\n  }, [queueTab, queueStatusFilter, queueOrderTypeFilter, queueSearchTerm, user?.branchId]);\n  const {\n    data: queueData,\n    isFetching: queueLoading,\n    refetch: refetchQueue,\n  } = useGetPOSOrdersQuery(queueQueryParams, {\n    skip: !user,\n  });\n  const { data: queueDetailData, isFetching: queueDetailLoading } = useGetPOSOrderQuery(queueDetailId as string, {\n    skip: !queueDetailId,\n  });\n  const [cancelOrder] = useCancelPOSOrderMutation();\n  const queueOrders = useMemo(() => {\n    if (queueData?.orders && Array.isArray(queueData.orders)) {\n      return queueData.orders;\n    }\n    return [] as any[];\n  }, [queueData]);\n  const queueDetail = queueDetailId\n    ? queueDetailData ?? queueOrders.find((order: any) => order.id === queueDetailId)\n    : null;\n  const queueTotalAmount = useMemo(() => {\n    return queueOrders.reduce((sum, order) => {\n      const amount = Number(order?.totalAmount ?? 0);\n      if (Number.isFinite(amount)) {\n        return sum + amount;\n      }\n      return sum;\n    }, 0);\n  }, [queueOrders]);\n  const createOrderWithRetry = useCallback(\n    async (payload: CreatePOSOrderRequest, attempts = 2): Promise<any> => {\n      try {\n        return await createOrder(payload).unwrap();\n      } catch (error: any) {\n        const message = error?.data?.message || error?.message || '';\n        if (attempts > 1 && typeof message === 'string' && message.includes('duplicate key')) {\n          await new Promise((resolve) => setTimeout(resolve, 150));\n          return createOrderWithRetry(payload, attempts - 1);\n        }\n        throw error;\n      }\n    },\n    [createOrder]\n  );\n  const branchId = (user as any)?.branchId || \n                   (user as any)?.branch?.id || \n                   (user as any)?.branch?._id;\n  const companyId = (user as any)?.companyId || (companyContext as any)?.companyId;\n  const { data: staffData, isLoading: staffLoading, error: staffError } = useGetStaffQuery(\n    { \n      companyId: companyId || undefined,\n      branchId: branchId || undefined,\n      limit: 200, \n      isActive: true \n    },\n    { \n      skip: !branchId,\n      refetchOnMountOrArgChange: false \n    }\n  );\n  const [triggerCustomerSearch, { data: customerSearchResults, isFetching: isCustomerSearchLoading }]\n    = useLazySearchCustomersQuery();\n  const resolvedCustomerResults = useMemo(() => {\n    if (Array.isArray(customerSearchResults)) return customerSearchResults;\n    if (!customerSearchResults) return [] as any[];\n    if (Array.isArray((customerSearchResults as any).customers)) {\n      return (customerSearchResults as any).customers;\n    }\n    return [] as any[];\n  }, [customerSearchResults]);\n  // Fetch waiter active orders count for busy indicator\n  const { data: waiterActiveOrdersCount = {} } = useGetWaiterActiveOrdersCountQuery(undefined, {\n    skip: !branchId,\n    pollingInterval: 60000, // Refresh every 60 seconds (reduced from 30s to reduce load)\n  });\n  const waiterOptions = useMemo<Array<{ id: string; name: string; activeOrdersCount: number }>>(() => {\n    const staffList = staffData?.staff || [];\n    const currentBranchId = user?.branchId || branchId;\n    return staffList\n      .filter((staffMember: any) => {\n        // CRITICAL: Only show employees with \"waiter\" role (or \"server\" as alias)\n        const role = (staffMember.role || '').toLowerCase();\n        const isWaiter = role === 'waiter' || role === 'server';\n        if (!isWaiter) {\n          return false; // Only waiter/server roles allowed\n        }\n        // CRITICAL: Filter by branch assignment - only show waiters assigned to current branch\n        const staffBranchId = staffMember.branchId || (staffMember.branch as any)?.id;\n        const isAssignedToBranch = currentBranchId && staffBranchId && \n          (staffBranchId.toString() === currentBranchId.toString() || \n           staffBranchId === currentBranchId);\n        return isAssignedToBranch;\n      })\n      .map((staffMember: any) => {\n        const waiterId = staffMember.id;\n        const activeOrdersCount = waiterActiveOrdersCount[waiterId] || 0;\n        return {\n          id: waiterId,\n          name:\n            `${staffMember.firstName || ''} ${staffMember.lastName || ''}`.trim() ||\n            staffMember.email ||\n            staffMember.id,\n          activeOrdersCount,\n        };\n      });\n  }, [staffData, user?.branchId, branchId, waiterActiveOrdersCount]);\n  const selectedWaiterName = useMemo(() => {\n    return waiterOptions.find((option) => option.id === selectedWaiterId)?.name || '';\n  }, [waiterOptions, selectedWaiterId]);\n  useEffect(() => {\n    if (!selectedWaiterId && waiterOptions.length > 0) {\n      setSelectedWaiterId(waiterOptions[0].id);\n    }\n  }, [selectedWaiterId, waiterOptions]);\n  // Extract menu items array from response (already transformed by API)\n  const menuItemsArray = useMemo(() => {\n    // Response is already transformed by API transformResponse\n    return Array.isArray(menuItemsData) ? menuItemsData : [];\n  }, [menuItemsData]);\n  const menuItemNameById = useMemo(() => {\n    const map = new Map<string, { name?: string; price?: number }>();\n    if (Array.isArray(menuItemsArray)) {\n      menuItemsArray.forEach((item: any) => {\n        if (item?.id) {\n          map.set(item.id, { name: item.name, price: item.price });\n        }\n      });\n    }\n    return map;\n  }, [menuItemsArray]);\n  // Filter menu items based on search and category (client-side filter for better UX)\n  const filteredMenuItems = useMemo(() => {\n    if (!Array.isArray(menuItemsArray)) return [];\n    let filtered = menuItemsArray;\n    // Filter by category if not 'all'\n    if (selectedCategory !== 'all') {\n      filtered = filtered.filter(item => {\n        const categoryId = item.category?.id || item.category;\n        return categoryId === selectedCategory || item.category?.name === selectedCategory;\n      });\n    }\n    // Filter by search query\n    if (searchQuery) {\n      filtered = filtered.filter(item =>\n        item.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        item.description?.toLowerCase().includes(searchQuery.toLowerCase())\n      );\n    }\n    return filtered;\n  }, [menuItemsArray, searchQuery, selectedCategory]);\n  const getItemDiscountAmount = useCallback(\n    (item: CartItem) => {\n      const entry = itemDiscounts[item.id];\n      if (!entry) return 0;\n      const lineSubtotal = item.price * item.quantity;\n      const raw = parseFloat(entry.value || '0');\n      if (!Number.isFinite(raw) || raw <= 0) {\n        return 0;\n      }\n      if (entry.type === 'percent') {\n        return Math.min(lineSubtotal, (lineSubtotal * raw) / 100);\n      }\n      return Math.min(lineSubtotal, raw);\n    },\n    [itemDiscounts]\n  );\n  // Calculate room booking total if room booking is selected\n  const roomBookingTotal = useMemo(() => {\n    if (orderType !== 'room-booking' || !selectedRoomId || !checkInDate || !checkOutDate) {\n      return 0;\n    }\n    const selectedRoom = rooms.find((r: any) => r.id === selectedRoomId);\n    if (!selectedRoom) return 0;\n    const checkIn = new Date(checkInDate);\n    const checkOut = new Date(checkOutDate);\n    const nights = Math.ceil((checkOut.getTime() - checkIn.getTime()) / (1000 * 60 * 60 * 24));\n    const roomRate = selectedRoom.basePrice || 0;\n    return roomRate * nights;\n  }, [orderType, selectedRoomId, checkInDate, checkOutDate, rooms]);\n  const orderSummary: OrderSummary = useMemo(() => {\n    const base = cart.reduce(\n      (acc, item) => {\n        const lineTotal = item.price * item.quantity;\n        return {\n          subtotal: acc.subtotal + lineTotal,\n          itemCount: acc.itemCount + item.quantity,\n        };\n      },\n      { subtotal: 0, itemCount: 0 }\n    );\n    // Add room booking total to subtotal if it's a room booking\n    const baseSubtotal = base.subtotal + (orderType === 'room-booking' ? roomBookingTotal : 0);\n    let discountAmount = 0;\n    if (discountMode === 'full') {\n      const parsed = parseFloat(discountValue || '0');\n      if (Number.isFinite(parsed) && parsed > 0) {\n        discountAmount =\n          discountType === 'percent'\n            ? Math.min(baseSubtotal, (baseSubtotal * parsed) / 100)\n            : Math.min(baseSubtotal, parsed);\n      }\n    } else {\n      // Item-wise discounts (only apply to cart items, not room booking)\n      discountAmount = cart.reduce((sum, item) => sum + getItemDiscountAmount(item), 0);\n      discountAmount = Math.min(discountAmount, base.subtotal);\n    }\n    // Add loyalty discount\n    const loyaltyDiscount = loyaltyRedemption.discount || 0;\n    const totalDiscount = discountAmount + loyaltyDiscount;\n    const taxableSubtotal = Math.max(baseSubtotal - totalDiscount, 0);\n    const taxAmount = (taxableSubtotal * taxRate) / 100;\n    const total = taxableSubtotal + taxAmount + deliveryFeeValue;\n    return {\n      subtotal: baseSubtotal,\n      discount: totalDiscount,\n      tax: taxAmount,\n      total,\n      itemCount: base.itemCount,\n      deliveryFee: deliveryFeeValue,\n    };\n  }, [\n    cart,\n    taxRate,\n    deliveryFeeValue,\n    discountMode,\n    discountType,\n    discountValue,\n    getItemDiscountAmount,\n    loyaltyRedemption.discount,\n    orderType,\n    roomBookingTotal,\n  ]);\n  // Initialize payment method when payment methods load\n  useEffect(() => {\n    if (paymentMethods.length > 0 && !fullPaymentMethod) {\n      const firstMethod = paymentMethods.find(m => m.code === 'cash')?.code || paymentMethods[0]?.code || 'cash';\n      setFullPaymentMethod(firstMethod);\n    }\n  }, [paymentMethods, fullPaymentMethod]);\n  useEffect(() => {\n    const formattedTotal = orderSummary.total.toFixed(2);\n    setFullPaymentReceived(formattedTotal);\n    setMultiPayments((prev) => {\n      if (prev.length === 0) {\n        const firstMethod = paymentMethods.find(m => m.allowsPartialPayment !== false)?.code || paymentMethods[0]?.code || 'cash';\n        return [{ id: generateClientId(), method: firstMethod, amount: formattedTotal }];\n      }\n      return prev;\n    });\n  }, [orderSummary.total, paymentMethods]);\n  // Save to localStorage whenever cart, selectedTable, or customerInfo changes\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      localStorage.setItem('pos_cart', JSON.stringify(cart));\n    }\n  }, [cart]);\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      if (selectedTable) {\n        localStorage.setItem('pos_selectedTable', selectedTable);\n      } else {\n        localStorage.removeItem('pos_selectedTable');\n      }\n    }\n  }, [selectedTable]);\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      const hasCustomerInfo = customerInfo.name || customerInfo.phone || customerInfo.email;\n      if (hasCustomerInfo) {\n        // Encrypt customer PII with 24-hour TTL\n        const CUSTOMER_DATA_TTL = 24 * 60 * 60 * 1000; // 24 hours\n        setEncryptedItemWithTTL('pos_customerInfo', customerInfo, CUSTOMER_DATA_TTL);\n      } else {\n        removeEncryptedItem('pos_customerInfo');\n      }\n    }\n  }, [customerInfo]);\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      if (selectedCustomerId) {\n        localStorage.setItem('pos_customerId', selectedCustomerId);\n      } else {\n        localStorage.removeItem('pos_customerId');\n      }\n    }\n  }, [selectedCustomerId]);\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      localStorage.setItem('pos_orderType', orderType);\n    }\n  }, [orderType]);\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      if (hasStartedOrder) {\n        localStorage.setItem('pos_orderStarted', 'true');\n      } else {\n        localStorage.removeItem('pos_orderStarted');\n      }\n    }\n  }, [hasStartedOrder]);\n  useEffect(() => {\n    if (orderType === 'dine-in') {\n      if (selectedTable) {\n        setHasStartedOrder(true);\n      } else {\n        setHasStartedOrder(false);\n      }\n    }\n  }, [orderType, selectedTable]);\n  // Save delivery details to encrypted storage\n  useEffect(() => {\n    if (typeof window !== 'undefined' && orderType === 'delivery') {\n      const hasDeliveryDetails = Object.values(deliveryDetails).some(v => v.trim() !== '') || deliveryFee !== '0';\n      if (hasDeliveryDetails) {\n        // Encrypt delivery PII with 24-hour TTL\n        const DELIVERY_DATA_TTL = 24 * 60 * 60 * 1000; // 24 hours\n        setEncryptedItemWithTTL('pos_deliveryDetails', deliveryDetails, DELIVERY_DATA_TTL);\n      } else {\n        removeEncryptedItem('pos_deliveryDetails');\n      }\n    }\n  }, [deliveryDetails, deliveryFee, orderType]);\n  // Save takeaway details to localStorage\n  useEffect(() => {\n    if (typeof window !== 'undefined' && orderType === 'takeaway') {\n      const hasTakeawayDetails = Object.values(takeawayDetails).some(v => v.trim() !== '');\n      if (hasTakeawayDetails) {\n        localStorage.setItem('pos_takeawayDetails', JSON.stringify(takeawayDetails));\n      } else {\n        localStorage.removeItem('pos_takeawayDetails');\n      }\n    }\n  }, [takeawayDetails, orderType]);\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return;\n    }\n    const hasDeliveryDetails = Object.values(deliveryDetails).some((value) => value.trim() !== '');\n    if (hasDeliveryDetails) {\n      // Encrypt delivery PII with 24-hour TTL\n      const DELIVERY_DATA_TTL = 24 * 60 * 60 * 1000; // 24 hours\n      setEncryptedItemWithTTL('pos_deliveryDetails', deliveryDetails, DELIVERY_DATA_TTL);\n    } else {\n      removeEncryptedItem('pos_deliveryDetails');\n    }\n    const parsedFee = parseFloat(deliveryFee);\n    if (!Number.isNaN(parsedFee) && parsedFee > 0) {\n      localStorage.setItem('pos_deliveryFee', deliveryFee);\n    } else {\n      localStorage.removeItem('pos_deliveryFee');\n    }\n  }, [deliveryDetails, deliveryFee]);\n  useEffect(() => {\n    if (typeof window === 'undefined') {\n      return;\n    }\n    const hasTakeawayDetails = Object.values(takeawayDetails).some((value) => value.trim() !== '');\n    if (hasTakeawayDetails) {\n      localStorage.setItem('pos_takeawayDetails', JSON.stringify(takeawayDetails));\n    } else {\n      localStorage.removeItem('pos_takeawayDetails');\n    }\n  }, [takeawayDetails]);\n  useEffect(() => {\n    if (!isCustomerLookupOpen) {\n      return;\n    }\n    const term = customerSearchTerm.trim();\n    if (term.length < 2) {\n      return;\n    }\n    const handle = window.setTimeout(() => {\n      const companyId = (user as any)?.companyId || (companyContext as any)?.companyId;\n      triggerCustomerSearch({ \n        query: term, \n        branchId: user?.branchId || undefined,\n        companyId: companyId || undefined\n      });\n    }, 250);\n    return () => window.clearTimeout(handle);\n  }, [customerSearchTerm, isCustomerLookupOpen, triggerCustomerSearch, user, companyContext]);\n  useEffect(() => {\n    const handle = window.setTimeout(() => {\n      setQueueSearchTerm(queueSearchInput.trim());\n    }, 300);\n    return () => window.clearTimeout(handle);\n  }, [queueSearchInput]);\n  useEffect(() => {\n    if (queueTab === 'active' && queueStatusFilter !== 'pending') {\n      setQueueStatusFilter('pending');\n    }\n    if (queueTab === 'history' && queueStatusFilter === 'pending') {\n      setQueueStatusFilter('all');\n    }\n  }, [queueTab, queueStatusFilter]);\n  const buildItemNotes = useCallback((item: CartItem) => {\n    const segments: string[] = [];\n    if (item.modifiersNote) {\n      segments.push(item.modifiersNote);\n    }\n    if (item.notes) {\n      segments.push(item.notes);\n    }\n    return segments.length > 0 ? segments.join('\\n') : undefined;\n  }, []);\n  const hasMenuItemModifiers = useCallback((menuItem: any) => {\n    const hasVariants = Array.isArray(menuItem?.variants) && menuItem.variants.length > 0;\n    const hasAddons = Array.isArray(menuItem?.addons) && menuItem.addons.some((addon: any) => addon?.isAvailable !== false);\n    const hasSelections = Array.isArray(menuItem?.selections) && menuItem.selections.length > 0;\n    return hasVariants || hasAddons || hasSelections;\n  }, []);\n  const getDefaultModifierConfig = useCallback((menuItem: any): ModifierConfig => {\n    const variantSelections: Record<string, string> = {};\n    const selectionChoices: Record<string, string[]> = {};\n    const addonSelections: Record<string, boolean> = {};\n    if (Array.isArray(menuItem?.variants)) {\n      menuItem.variants.forEach((variant: any) => {\n        if (!variant?.name || !Array.isArray(variant.options) || variant.options.length === 0) {\n          return;\n        }\n        const defaultOption = variant.options[0];\n        if (defaultOption?.name) {\n          variantSelections[variant.name] = defaultOption.name;\n        }\n      });\n    }\n    if (Array.isArray(menuItem?.selections)) {\n      menuItem.selections.forEach((selection: any) => {\n        if (!selection?.name || !Array.isArray(selection.options) || selection.options.length === 0) {\n          selectionChoices[selection?.name ?? ''] = [];\n          return;\n        }\n        if (selection.type === 'single') {\n          selectionChoices[selection.name] = [selection.options[0].name];\n        } else {\n          selectionChoices[selection.name] = [];\n        }\n      });\n    }\n    if (Array.isArray(menuItem?.addons)) {\n      menuItem.addons.forEach((addon: any) => {\n        if (!addon?.name) return;\n        if (addon?.isAvailable === false) {\n          addonSelections[addon.name] = false;\n          return;\n        }\n        addonSelections[addon.name] = false;\n      });\n    }\n    return {\n      quantity: 1,\n      variantSelections,\n      selectionChoices,\n      addonSelections,\n    };\n  }, []);\n  const buildCartItemFromMenuItem = useCallback((menuItem: any, overrides?: Partial<ModifierConfig>): CartItem => {\n    const defaults = getDefaultModifierConfig(menuItem);\n    const config: ModifierConfig = {\n      quantity: overrides?.quantity ?? defaults.quantity,\n      variantSelections: { ...defaults.variantSelections, ...(overrides?.variantSelections ?? {}) },\n      selectionChoices: { ...defaults.selectionChoices, ...(overrides?.selectionChoices ?? {}) },\n      addonSelections: { ...defaults.addonSelections, ...(overrides?.addonSelections ?? {}) },\n    };\n    const basePrice = Number(menuItem?.price) || 0;\n    let unitPrice = basePrice;\n    const variantSelections: ModifierSelection[] = [];\n    const addonSelections: AddonSelection[] = [];\n    const selectionChoices: ModifierChoice[] = [];\n    const summaryParts: string[] = [];\n    if (Array.isArray(menuItem?.variants)) {\n      menuItem.variants.forEach((variant: any) => {\n        if (!variant?.name || !Array.isArray(variant.options) || variant.options.length === 0) {\n          return;\n        }\n        const requestedOptionName = config.variantSelections[variant.name];\n        const option = variant.options.find((opt: any) => opt?.name === requestedOptionName) || variant.options[0];\n        if (!option) {\n          return;\n        }\n        const modifierAmount = Number(option.priceModifier) || 0;\n        unitPrice += modifierAmount;\n        variantSelections.push({\n          group: variant.name,\n          option: option.name,\n          priceModifier: modifierAmount,\n        });\n        const label = modifierAmount\n          ? `${variant.name}: ${option.name} (+${formatCurrency(modifierAmount)})`\n          : `${variant.name}: ${option.name}`;\n        summaryParts.push(label);\n      });\n    }\n    if (Array.isArray(menuItem?.selections)) {\n      menuItem.selections.forEach((selection: any) => {\n        if (!selection?.name || !Array.isArray(selection.options) || selection.options.length === 0) {\n          return;\n        }\n        const chosen = config.selectionChoices[selection.name] ?? [];\n        const normalized = Array.isArray(chosen) ? chosen : [chosen];\n        const applied: ModifierChoice['options'] = [];\n        normalized.forEach((choiceName) => {\n          if (!choiceName) return;\n          const option = selection.options.find((opt: any) => opt?.name === choiceName);\n          if (!option) return;\n          const priceToAdd = Number(option.price) || 0;\n          unitPrice += priceToAdd;\n          applied.push({ name: option.name, price: priceToAdd });\n        });\n        if (applied.length > 0) {\n          selectionChoices.push({\n            group: selection.name,\n            options: applied,\n          });\n          const label = `${selection.name}: ${applied\n            .map((opt) => (opt.price ? `${opt.name} (+${formatCurrency(opt.price)})` : opt.name))\n            .join(', ')}`;\n          summaryParts.push(label);\n        }\n      });\n    }\n    if (Array.isArray(menuItem?.addons)) {\n      const chosenAddons = menuItem.addons.filter((addon: any) => {\n        if (!addon?.name || addon?.isAvailable === false) return false;\n        return Boolean(config.addonSelections[addon.name]);\n      });\n      if (chosenAddons.length > 0) {\n        const addonLabels: string[] = [];\n        chosenAddons.forEach((addon: any) => {\n          const addonPrice = Number(addon.price) || 0;\n          unitPrice += addonPrice;\n          addonSelections.push({ name: addon.name, price: addonPrice });\n          addonLabels.push(addonPrice ? `${addon.name} (+${formatCurrency(addonPrice)})` : addon.name);\n        });\n        summaryParts.push(`Add-ons: ${addonLabels.join(', ')}`);\n      }\n    }\n    return {\n      id: overrides && 'id' in overrides && overrides.id ? String((overrides as any).id) : generateClientId(),\n            menuItemId: menuItem.id,\n            name: menuItem.name,\n      basePrice,\n      price: Number(unitPrice.toFixed(2)),\n      quantity: config.quantity,\n            category: menuItem.category?.name || 'Uncategorized',\n      modifiersNote: summaryParts.length > 0 ? summaryParts.join('; ') : undefined,\n      variantSelections: variantSelections.length > 0 ? variantSelections : undefined,\n      addonSelections: addonSelections.length > 0 ? addonSelections : undefined,\n      selectionChoices: selectionChoices.length > 0 ? selectionChoices : undefined,\n    };\n  }, [getDefaultModifierConfig, formatCurrency]);\n  const areModifiersEqual = useCallback((first: CartItem, second: CartItem) => {\n    if (first.menuItemId !== second.menuItemId) {\n      return false;\n    }\n    const serializeVariants = (item: CartItem) =>\n      JSON.stringify((item.variantSelections || [])\n        .map((entry) => `${entry.group}:${entry.option}`)\n        .sort());\n    const serializeAddons = (item: CartItem) =>\n      JSON.stringify((item.addonSelections || [])\n        .map((entry) => entry.name)\n        .sort());\n    const serializeChoices = (item: CartItem) =>\n      JSON.stringify((item.selectionChoices || [])\n        .map((entry) => ({\n          group: entry.group,\n          options: entry.options.map((option) => option.name).sort(),\n        }))\n        .sort((a, b) => a.group.localeCompare(b.group)));\n    return (\n      serializeVariants(first) === serializeVariants(second) &&\n      serializeAddons(first) === serializeAddons(second) &&\n      serializeChoices(first) === serializeChoices(second) &&\n      (first.modifiersNote || '') === (second.modifiersNote || '')\n    );\n  }, []);\n  const appendCartItem = useCallback((newItem: CartItem, silent = false) => {\n    setCart((prev) => {\n      const existingIndex = prev.findIndex((item) => areModifiersEqual(item, newItem));\n      if (existingIndex >= 0) {\n        const next = [...prev];\n        next[existingIndex] = {\n          ...next[existingIndex],\n          quantity: next[existingIndex].quantity + newItem.quantity,\n        };\n        return next;\n      }\n      return [...prev, newItem];\n    });\n    if (!silent) {\n      toast.success(`${newItem.name} added to cart`);\n    }\n    setHasStartedOrder(true);\n  }, [areModifiersEqual]);\n  const addMultiPaymentRow = useCallback(() => {\n    const firstMethod = paymentMethods.find(m => m.allowsPartialPayment !== false)?.code || paymentMethods[0]?.code || 'cash';\n    setMultiPayments((prev) => [...prev, { id: generateClientId(), method: firstMethod, amount: '0' }]);\n  }, [paymentMethods]);\n  const updateMultiPaymentRow = useCallback((id: string, patch: Partial<{ method: string; amount: string }>) => {\n    setMultiPayments((prev) => prev.map((payment) => (payment.id === id ? { ...payment, ...patch } : payment)));\n  }, []);\n  const removeMultiPaymentRow = useCallback((id: string) => {\n    setMultiPayments((prev) => prev.filter((payment) => payment.id !== id));\n  }, []);\n  const applyCustomerSelection = useCallback((customer: any) => {\n    if (!customer) {\n      return;\n    }\n    const firstName = customer.firstName || customer.name || '';\n    const lastName = customer.lastName || '';\n    const composedName =\n      `${firstName} ${lastName}`.trim() ||\n      customer.email ||\n      customer.phoneNumber ||\n      customer.phone ||\n      'Customer';\n    const phone = customer.phoneNumber || customer.phone || '';\n    const email = customer.email || '';\n    setCustomerInfo({\n      name: composedName,\n      phone,\n      email,\n    });\n    setSelectedCustomerId(customer.id || customer._id || '');\n    setIsCustomerLookupOpen(false);\n    toast.success(`Linked customer ${composedName}`);\n  }, []);\n  const clearCustomerSelection = useCallback(() => {\n    setSelectedCustomerId('');\n    setCustomerInfo({ name: '', phone: '', email: '' });\n    toast.success('Customer cleared');\n  }, []);\n  const closeModifierEditor = useCallback(() => setModifierEditor(null), []);\n  const handleModifierConfirm = useCallback(() => {\n    if (!modifierEditor) {\n      return;\n    }\n    const cartItem = buildCartItemFromMenuItem(modifierEditor.item, modifierEditor);\n    appendCartItem(cartItem);\n    setModifierEditor(null);\n  }, [appendCartItem, buildCartItemFromMenuItem, modifierEditor]);\n  // Cart functions\n  const addToCart = useCallback((menuItem: any) => {\n    if (hasMenuItemModifiers(menuItem)) {\n      const defaults = getDefaultModifierConfig(menuItem);\n      setModifierEditor({\n        item: menuItem,\n        quantity: defaults.quantity,\n        variantSelections: defaults.variantSelections,\n        selectionChoices: defaults.selectionChoices,\n        addonSelections: defaults.addonSelections,\n      });\n      return;\n    }\n    const cartItem = buildCartItemFromMenuItem(menuItem, { quantity: 1 });\n    appendCartItem(cartItem);\n  }, [appendCartItem, buildCartItemFromMenuItem, getDefaultModifierConfig, hasMenuItemModifiers]);\n  const updateQuantity = (itemId: string, quantity: number) => {\n    if (quantity <= 0) {\n      removeFromCart(itemId);\n    } else {\n      setCart(cart.map(item =>\n        item.id === itemId ? { ...item, quantity } : item\n      ));\n    }\n  };\n  const updateItemNote = useCallback((itemId: string, note: string) => {\n    setCart((prev) =>\n      prev.map((item) => (item.id === itemId ? { ...item, notes: note.trim() || undefined } : item))\n    );\n  }, []);\n  const removeFromCart = (itemId: string) => {\n    setCart(cart.filter(item => item.id !== itemId));\n    setItemDiscounts((prev) => {\n      if (!prev[itemId]) return prev;\n      const next = { ...prev };\n      delete next[itemId];\n      return next;\n    });\n    toast.success('Item removed from cart');\n  };\n  const updateItemDiscountEntry = useCallback(\n    (itemId: string, nextValue: { type: 'percent' | 'amount'; value: string }) => {\n      setItemDiscounts((prev) => ({\n        ...prev,\n        [itemId]: nextValue,\n      }));\n    },\n    []\n  );\n  const clearCart = useCallback(() => {\n    setCart([]);\n    setItemDiscounts({});\n    setDiscountValue('0');\n    setDiscountMode('full');\n    setOrderNotes('');\n    setSelectedCustomerId('');\n    setCustomerInfo({ name: '', phone: '', email: '' });\n    setPaymentTab('full');\n    setFullPaymentMethod('cash');\n    setFullPaymentReceived('0');\n    setMultiPayments([]);\n    if (typeof window !== 'undefined') {\n      localStorage.removeItem('pos_cart');\n      localStorage.removeItem('pos_customerId');\n      removeEncryptedItem('pos_customerInfo');\n    }\n    toast.success('Cart cleared');\n  }, []);\n  const resetFilters = () => {\n    setSelectedCategory('all');\n    setSearchQuery('');\n    toast.success('Filters reset');\n  };\n  const handleOrderTypeChange = useCallback(\n    (type: OrderType) => {\n      setOrderType(type);\n      if (type === 'dine-in') {\n        setHasStartedOrder(Boolean(selectedTable));\n      } else if (type === 'room-booking') {\n        setHasStartedOrder(Boolean(selectedRoomId));\n      } else {\n        setHasStartedOrder(false);\n      }\n    },\n    [selectedTable, selectedRoomId]\n  );\n  const [occupiedTableModal, setOccupiedTableModal] = useState<{ tableId: string; orderDetails: any } | null>(null);\n  // Context menu state for table quick actions\n  const [contextMenu, setContextMenu] = useState<{ tableId: string; x: number; y: number } | null>(null);\n  const [notifiedTables, setNotifiedTables] = useState<Set<string>>(new Set()); // Track tables we've already notified\n  const [updateTableStatus] = useUpdateTableStatusMutation();\n  // Show notification for tables paid > 15 minutes using Socket.IO events\n  // Instead of polling with setInterval, we listen for payment events and set timeouts\n  useEffect(() => {\n    if (!socket || !isConnected) return;\n    // Store active timeouts to clean them up\n    const activeTimeouts = new Map<string, NodeJS.Timeout>();\n    const showReleaseNotification = (tableId: string, tableNumber: string) => {\n      if (notifiedTables.has(tableId)) return; // Already notified\n      toast(\n        (t) => (\n          <div className=\"flex items-center gap-3\">\n            <div className=\"flex-1\">\n              <p className=\"font-semibold text-sm\">Table {tableNumber} - Ready to Release</p>\n              <p className=\"text-xs text-gray-600 dark:text-gray-400\">\n                Payment received 15 minutes ago\n              </p>\n            </div>\n            <button\n              onClick={async () => {\n                try {\n                  await updateTableStatus({\n                    id: tableId,\n                    status: 'available'\n                  }).unwrap();\n                  toast.dismiss(t.id);\n                  toast.success('Table released successfully');\n                  setNotifiedTables(prev => {\n                    const newSet = new Set(prev);\n                    newSet.delete(tableId);\n                    return newSet;\n                  });\n                  // Clear timeout if exists\n                  const timeout = activeTimeouts.get(tableId);\n                  if (timeout) {\n                    clearTimeout(timeout);\n                    activeTimeouts.delete(tableId);\n                  }\n                  refetchTables();\n                } catch (error: any) {\n                  toast.error(error?.data?.message || 'Failed to release table');\n                }\n              }}\n              className=\"px-3 py-1.5 bg-green-600 hover:bg-green-500 text-white text-xs font-medium rounded-lg transition-colors\"\n            >\n              Release\n            </button>\n          </div>\n        ),\n        {\n          duration: 10000, // Show for 10 seconds\n          icon: '',\n        }\n      );\n      setNotifiedTables(prev => new Set(prev).add(tableId));\n    };\n    // Listen for payment received events\n    const handlePaymentReceived = (data: any) => {\n      const order = data.order || data;\n      const tableId = order.tableId?.toString() || order.tableId;\n      if (!tableId) return;\n      // Find table number from current tables data\n      const table = tables?.find((t: any) => t.id === tableId);\n      if (!table) return;\n      // Clear any existing timeout for this table\n      const existingTimeout = activeTimeouts.get(tableId);\n      if (existingTimeout) {\n        clearTimeout(existingTimeout);\n      }\n      // Set timeout to show notification after 15 minutes\n      const timeout = setTimeout(() => {\n        showReleaseNotification(tableId, table.number || table.tableNumber || 'Unknown');\n        activeTimeouts.delete(tableId);\n      }, 15 * 60 * 1000); // 15 minutes\n      activeTimeouts.set(tableId, timeout);\n      };\n    // Also check existing paid tables on mount (one-time check for tables already paid)\n    const checkExistingPaidTables = () => {\n      if (!tables || tables.length === 0) return;\n      const now = new Date();\n      const fifteenMinutesAgo = new Date(now.getTime() - 15 * 60 * 1000);\n      tables.forEach((table: any) => {\n        if (table.status !== 'occupied' || !table.orderDetails) return;\n        const orderStatus = table.orderDetails.orderStatus \n          || table.orderDetails.status \n          || table.orderDetails.allOrders?.[0]?.status \n          || 'pending';\n        if (orderStatus === 'paid') {\n          const paymentTime = table.orderDetails.completedAt \n            || table.orderDetails.allOrders?.[0]?.completedAt\n            || table.orderDetails.paidAt;\n          if (paymentTime) {\n            const paidAt = new Date(paymentTime);\n            const timeSincePayment = now.getTime() - paidAt.getTime();\n            if (paidAt < fifteenMinutesAgo && !notifiedTables.has(table.id)) {\n              // Already past 15 minutes, show immediately\n              showReleaseNotification(table.id, table.number || table.tableNumber || 'Unknown');\n            } else if (timeSincePayment > 0 && timeSincePayment < 15 * 60 * 1000) {\n              // Paid less than 15 minutes ago, schedule notification\n              const remainingTime = 15 * 60 * 1000 - timeSincePayment;\n              const timeout = setTimeout(() => {\n                showReleaseNotification(table.id, table.number || table.tableNumber || 'Unknown');\n                activeTimeouts.delete(table.id);\n              }, remainingTime);\n              activeTimeouts.set(table.id, timeout);\n            }\n          }\n        }\n      });\n    };\n    // Listen to Socket.IO events\n    socket.on('order:payment-received', handlePaymentReceived);\n    socket.on('table:payment-received', handlePaymentReceived);\n    socket.on('order:status-changed', (data: any) => {\n      // If order status changed to 'paid', treat it as payment received\n      if (data.status === 'paid' && data.order) {\n        handlePaymentReceived(data.order);\n      }\n    });\n    // Check existing paid tables on mount\n    checkExistingPaidTables();\n    // Cleanup\n    return () => {\n      socket.off('order:payment-received', handlePaymentReceived);\n      socket.off('table:payment-received', handlePaymentReceived);\n      socket.off('order:status-changed', handlePaymentReceived);\n      // Clear all active timeouts\n      activeTimeouts.forEach(timeout => clearTimeout(timeout));\n      activeTimeouts.clear();\n    };\n  }, [socket, isConnected, tables, notifiedTables, updateTableStatus, refetchTables]);\n  // Close context menu when clicking outside\n  useEffect(() => {\n    const handleClickOutside = () => setContextMenu(null);\n    if (contextMenu) {\n      document.addEventListener('click', handleClickOutside);\n      return () => document.removeEventListener('click', handleClickOutside);\n    }\n  }, [contextMenu]);\n  const handleTableSelection = useCallback(\n    (tableId: string) => {\n      if (!tableId) {\n        setSelectedTable('');\n        setHasStartedOrder(false);\n        return;\n      }\n      const table = tables.find((entry: any) => entry.id === tableId);\n      // If table has an order (pending or paid), show modal with options\n      if (table?.orderDetails) {\n        setOccupiedTableModal({ tableId, orderDetails: table.orderDetails });\n        return;\n      }\n      // If table is reserved, show error\n      if (table?.status === 'reserved') {\n        toast.error('This table is reserved. Please choose another table.');\n        return;\n      }\n      setSelectedTable(tableId);\n      setHasStartedOrder(true);\n    },\n    [tables]\n  );\n  const handleResumeOrder = useCallback(async () => {\n    if (!occupiedTableModal) return;\n    // Try to get orderId from multiple sources\n    const orderId = occupiedTableModal.orderDetails?.currentOrderId \n      || occupiedTableModal.orderDetails?.allOrders?.[0]?.id\n      || tables.find((t: any) => t.id === occupiedTableModal.tableId)?.orderDetails?.currentOrderId;\n    if (!orderId) {\n      toast.error('Order ID not found. Please try selecting the table again.');\n      return;\n    }\n    try {\n      // Fetch order using RTK Query - get the order data from the API\n      const baseUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000';\n      const apiUrl = baseUrl.endsWith('/api/v1') ? baseUrl : `${baseUrl}/api/v1`;\n      const orderResponse = await fetch(`${apiUrl}/pos/orders/${orderId}`, {\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('accessToken') || localStorage.getItem('token')}`,\n          'Content-Type': 'application/json',\n        },\n      });\n      if (!orderResponse.ok) {\n        const errorData = await orderResponse.json().catch(() => ({}));\n        throw new Error(errorData.message || 'Failed to fetch order');\n      }\n      const orderData = await orderResponse.json();\n      const order = orderData.data || orderData;\n      if (!order || !order.items) {\n        throw new Error('Invalid order data received');\n      }\n      // Check if order is paid - don't allow editing paid orders\n      if (order.status === 'paid') {\n        toast.error('Cannot edit a paid order. Please create a new order or process a refund.');\n        return;\n      }\n      // Load order items into cart\n      if (order.items && Array.isArray(order.items)) {\n        const cartItems: CartItem[] = [];\n        for (const item of order.items) {\n          const menuItemId = item.menuItemId?.toString() || item.menuItemId?._id?.toString() || '';\n          const menuItem = menuItemsArray.find((mi: any) => \n            mi.id === menuItemId || \n            mi._id?.toString() === menuItemId ||\n            mi.id === item.menuItemId ||\n            mi._id === item.menuItemId\n          );\n          cartItems.push({\n            id: generateClientId(),\n            menuItemId: menuItemId,\n            name: menuItem?.name || item.menuItemId?.name || 'Unknown Item',\n            basePrice: item.price || 0,\n            price: item.price || 0,\n            quantity: item.quantity || 1,\n            category: typeof menuItem?.category === 'string' ? menuItem.category : (menuItem?.category?.name || ''),\n            notes: item.notes || '',\n          });\n        }\n        setCart(cartItems);\n      }\n      // Set table and guest count\n      setSelectedTable(occupiedTableModal.tableId);\n      if (order.guestCount) {\n        setGuestCount(order.guestCount);\n        if (typeof window !== 'undefined') {\n          localStorage.setItem('pos_guestCount', order.guestCount.toString());\n        }\n      }\n      setHasStartedOrder(true);\n      setIsCartModalOpen(true);\n      setOccupiedTableModal(null);\n      toast.success('Order loaded. You can now edit items.');\n    } catch (error: any) {\n      console.error('Error resuming order:', error);\n      toast.error(error?.message || 'Failed to load order. Please try again.');\n    }\n  }, [occupiedTableModal, menuItemsArray, tables]);\n  const handleStartNewOrderOnTable = useCallback(() => {\n    if (!occupiedTableModal) return;\n    const table = tables.find((t: any) => t.id === occupiedTableModal.tableId);\n    if (table?.orderDetails?.remainingSeats && table.orderDetails.remainingSeats > 0) {\n      setSelectedTable(occupiedTableModal.tableId);\n      setGuestCount(Math.min(guestCount, table.orderDetails.remainingSeats));\n      setHasStartedOrder(true);\n      setIsCartModalOpen(true);\n      setOccupiedTableModal(null);\n      toast.success(`Starting new order for ${table.orderDetails.remainingSeats} remaining seats`);\n    } else {\n      toast.error('No remaining seats available on this table');\n    }\n  }, [occupiedTableModal, tables, guestCount]);\n  const handleCancelOccupiedOrder = useCallback(async () => {\n    if (!occupiedTableModal?.orderDetails?.currentOrderId) return;\n    if (typeof window !== 'undefined') {\n      const confirmed = window.confirm('Are you sure you want to cancel this order? This will free up the table.');\n      if (!confirmed) {\n        return;\n      }\n    }\n    try {\n      // Cancel order with reason\n      const orderId = occupiedTableModal.orderDetails.currentOrderId;\n      await cancelOrder({ \n        id: orderId,\n        reason: 'Cancelled from POS terminal'\n      }).unwrap();\n      toast.success('Order cancelled successfully. Table is now available.');\n      setOccupiedTableModal(null);\n      refetchTables();\n      refetchQueue();\n    } catch (error: any) {\n      console.error('Error cancelling order:', error);\n      toast.error(error?.data?.message || 'Failed to cancel order');\n    }\n  }, [occupiedTableModal, cancelOrder, refetchTables, refetchQueue]);\n  // Order functions\n  const handleCreateOrder = useCallback(async () => {\n    // In pay-first mode, orders cannot be created without payment\n    if (paymentMode === 'pay-first') {\n      toast.error('Pay-first mode is enabled. Please use \"Checkout\" to process payment before creating the order.');\n      setIsPaymentModalOpen(true); // Open payment modal instead\n      return;\n    }\n    const requiresTable = orderType === 'dine-in';\n    const isDelivery = orderType === 'delivery';\n    const isTakeaway = orderType === 'takeaway';\n    const isRoomBooking = orderType === 'room-booking';\n    const isRoomService = orderType === 'room-service';\n    // For room bookings we only go through the dedicated booking flow\n    if (isRoomBooking) {\n      toast.error('For room bookings, please use the Room Booking flow instead of Create Order.');\n      return;\n    }\n    // For room service pending charges we require a linked booking\n    let roomServiceBookingIdToUse = roomServiceBookingId;\n    if (isRoomService && !roomServiceBookingIdToUse && roomServiceBookings.length > 0) {\n      roomServiceBookingIdToUse = roomServiceBookings[0].id;\n      setRoomServiceBookingId(roomServiceBookingIdToUse);\n    }\n    if (isRoomService && !roomServiceBookingIdToUse) {\n      toast.error('Please select a checked-in booking / room before creating a room service order.');\n      return;\n    }\n    const roomServiceBookingForOrder = isRoomService\n      ? roomServiceBookings.find((b) => b.id === roomServiceBookingIdToUse) || roomServiceBookings[0]\n      : null;\n    try {\n      const deliveryPayload = isDelivery\n        ? (sanitizeDetails(deliveryDetails) as CreatePOSOrderRequest['deliveryDetails'])\n        : undefined;\n      const takeawayPayload = isTakeaway\n        ? (sanitizeDetails(takeawayDetails) as CreatePOSOrderRequest['takeawayDetails'])\n        : undefined;\n      const noteSegments: string[] = [];\n      if (orderNotes.trim()) {\n        noteSegments.push(orderNotes.trim());\n      }\n      if (selectedWaiterName) {\n        noteSegments.push(`Waiter: ${selectedWaiterName}`);\n      }\n      if (selectedCustomerId) {\n        noteSegments.push(`Customer ID: ${selectedCustomerId}`);\n      }\n      if (orderSummary.discount > 0) {\n        if (discountMode === 'full') {\n          noteSegments.push(\n            `Discount applied: ${discountType === 'percent' ? `${discountValue}%` : formatCurrency(Number(discountValue || '0'))} on full order`,\n          );\n        } else {\n          noteSegments.push('Item-wise discounts applied.');\n        }\n      }\n      const orderTypeForBackend: CreatePOSOrderRequest['orderType'] =\n        isRoomService ? 'room_service' : (orderType as 'dine-in' | 'delivery' | 'takeaway');\n      const orderData: CreatePOSOrderRequest = {\n        orderType: orderTypeForBackend,\n        ...(requiresTable && selectedTable ? { tableId: selectedTable } : {}),\n        ...(requiresTable && selectedTable ? { guestCount: guestCount || 1 } : {}),\n        ...(isDelivery\n          ? {\n              deliveryFee: deliveryFeeValue,\n              deliveryDetails: deliveryPayload,\n            }\n          : {}),\n        ...(isTakeaway\n          ? {\n              takeawayDetails: takeawayPayload,\n            }\n          : {}),\n        ...(isRoomService && roomServiceBookingIdToUse\n          ? {\n              bookingId: roomServiceBookingIdToUse,\n              roomId: roomServiceBookingForOrder?.roomId,\n              roomNumber: roomServiceBookingForOrder?.roomNumber,\n            }\n          : {}),\n        items: cart.map((item) => ({\n          menuItemId: item.menuItemId,\n          quantity: item.quantity,\n          price: item.price,\n          notes: buildItemNotes(item),\n        })),\n        customerInfo: customerInfo,\n        totalAmount: Number(orderSummary.total.toFixed(2)),\n        status: 'pending' as const,\n        notes: noteSegments.length > 0 ? noteSegments.join('\\n') : undefined,\n        ...(selectedCustomerId && loyaltyRedemption.pointsRedeemed > 0\n          ? {\n              customerId: selectedCustomerId,\n              loyaltyPointsRedeemed: loyaltyRedemption.pointsRedeemed,\n              loyaltyDiscount: loyaltyRedemption.discount,\n            }\n          : selectedCustomerId\n          ? { customerId: selectedCustomerId }\n          : {}),\n      };\n      const orderResponse = await createOrderWithRetry(orderData);\n      const order = (orderResponse as any).data || orderResponse;\n      toast.success(`Order created successfully! Order #${order.orderNumber || order.id}`);\n      refetchQueue();\n      refetchTables(); // Refetch tables to update status\n      clearCart();\n      if (requiresTable) {\n        setSelectedTable('');\n        setGuestCount(1);\n        if (typeof window !== 'undefined') {\n          localStorage.removeItem('pos_selectedTable');\n          localStorage.removeItem('pos_guestCount');\n        }\n      }\n      if (isDelivery) {\n        resetDeliveryDetails();\n      }\n      if (isTakeaway) {\n        resetTakeawayDetails();\n      }\n      if (typeof window !== 'undefined') {\n        removeEncryptedItem('pos_customerInfo');\n      }\n      setCustomerInfo({ name: '', phone: '', email: '' });\n      setHasStartedOrder(false);\n      setIsCartModalOpen(false);\n    } catch (error: any) {\n      toast.error(error?.data?.message || 'Failed to create order');\n    }\n  }, [\n    orderType,\n    selectedTable,\n    takeawayDetails,\n    cart,\n    customerInfo,\n    orderSummary.total,\n    orderSummary.discount,\n    orderSummary.tax,\n    orderSummary.subtotal,\n    orderSummary.deliveryFee,\n    createOrderWithRetry,\n    resetDeliveryDetails,\n    resetTakeawayDetails,\n    orderNotes,\n    selectedWaiterName,\n    deliveryFeeValue,\n    discountMode,\n    discountValue,\n    loyaltyRedemption,\n    selectedCustomerId,\n    refetchQueue,\n    refetchTables,\n    clearCart,\n  ]);\n  const handlePayment = async () => {\n    const requiresTable = orderType === 'dine-in';\n    const isDelivery = orderType === 'delivery';\n    const isTakeaway = orderType === 'takeaway';\n    const isRoomBooking = orderType === 'room-booking';\n    const isRoomService = orderType === 'room-service';\n    if (requiresTable && !selectedTable) {\n      toast.error('Please select a table for dine-in orders');\n      return;\n    }\n    if (isDelivery) {\n      const hasAddress = deliveryDetails.addressLine1.trim() && deliveryDetails.city.trim();\n      const hasPhone = deliveryDetails.contactPhone.trim();\n      if (!hasAddress || !hasPhone) {\n        toast.error('Please complete the delivery address and contact phone');\n        return;\n      }\n    }\n    if (isTakeaway) {\n      const hasContact = takeawayDetails.contactName.trim() && takeawayDetails.contactPhone.trim();\n      if (!hasContact) {\n        toast.error('Please provide contact name and phone for takeaway orders');\n        return;\n      }\n    }\n    if (isRoomBooking) {\n      if (!selectedRoomId) {\n        toast.error('Please select a room for booking');\n        return;\n      }\n      if (!checkInDate || !checkOutDate) {\n        toast.error('Please select check-in and check-out dates');\n        return;\n      }\n      if (new Date(checkOutDate) <= new Date(checkInDate)) {\n        toast.error('Check-out date must be after check-in date');\n        return;\n      }\n      if (numberOfGuests < 1) {\n        toast.error('Number of guests must be at least 1');\n        return;\n      }\n      if (!customerInfo.name || !customerInfo.name.trim()) {\n        toast.error('Please enter guest name');\n        return;\n      }\n      if (!customerInfo.phone || !customerInfo.phone.trim()) {\n        toast.error('Please enter phone number');\n        return;\n      }\n    }\n    if (!isRoomBooking && cart.length === 0) {\n      toast.error('Cart is empty');\n      return;\n    }\n    const totalDue = Number(orderSummary.total.toFixed(2));\n    if (!Number.isFinite(totalDue) || totalDue <= 0) {\n      toast.error('Total due must be greater than zero before processing payment');\n      return;\n    }\n    try {\n      const deliveryPayload = isDelivery\n        ? (sanitizeDetails(deliveryDetails) as CreatePOSOrderRequest['deliveryDetails'])\n        : undefined;\n      const takeawayPayload = isTakeaway\n        ? (sanitizeDetails(takeawayDetails) as CreatePOSOrderRequest['takeawayDetails'])\n        : undefined;\n      const paymentNotes: string[] = [];\n      let paymentMethodForBackend: string = 'cash';\n      let transactionReference: string | undefined;\n      let changeDue = 0;\n      let paymentBreakdown: Array<{ method: string; amount: number }> = [];\n      // For room service in pay-later mode, we don't take payment now.\n      const skipFullPaymentValidation = isRoomService && paymentMode === 'pay-later';\n      if (paymentTab === 'full' && !skipFullPaymentValidation) {\n        const received = parseFloat(fullPaymentReceived || '0');\n        if (!Number.isFinite(received) || received <= 0) {\n          toast.error('Enter the amount received before completing payment');\n          return;\n        }\n        const selectedMethod = paymentMethods.find(m => m.code === fullPaymentMethod);\n        const allowsChange = selectedMethod?.allowsChangeDue ?? (fullPaymentMethod === 'cash');\n        if (allowsChange && received + 0.009 < totalDue) {\n          toast.error('Received amount is less than the total due');\n          return;\n        }\n        paymentMethodForBackend = fullPaymentMethod as any; // Pass the actual method code (bkash, nagad, cash, card, etc.)\n        paymentBreakdown = [{ method: fullPaymentMethod, amount: totalDue }];\n        const methodName = selectedMethod?.displayName || selectedMethod?.name || fullPaymentMethod;\n        if (allowsChange) {\n          changeDue = Math.max(0, received - totalDue);\n          paymentNotes.push(\n            `${methodName} payment received ${formatCurrency(received)}  Change ${formatCurrency(changeDue)}`\n          );\n          transactionReference = `${fullPaymentMethod}:${received.toFixed(2)}|change:${changeDue.toFixed(2)}`;\n        } else {\n          paymentNotes.push(`${methodName} payment processed for ${formatCurrency(totalDue)}`);\n        }\n      } else if (!skipFullPaymentValidation) {\n        const activeRows = multiPayments.filter((row) => parseFloat(row.amount || '0') > 0);\n        if (activeRows.length === 0) {\n          toast.error('Add at least one payment row with an amount to process a split payment');\n          return;\n        }\n        const totalApplied = activeRows.reduce((sum, row) => sum + (parseFloat(row.amount || '0') || 0), 0);\n        if (totalApplied + 0.009 < totalDue) {\n          toast.error('The split payments do not cover the total due yet');\n          return;\n        }\n        paymentMethodForBackend = 'split';\n        paymentBreakdown = activeRows.map((row) => ({\n          method: row.method,\n          amount: parseFloat(row.amount || '0') || 0,\n        }));\n        const breakdownSummary = activeRows\n          .map((row) => `${row.method}: ${formatCurrency(parseFloat(row.amount || '0') || 0)}`)\n          .join(', ');\n        paymentNotes.push(`Split payment applied  ${breakdownSummary}`);\n        transactionReference = activeRows\n          .map((row) => `${row.method}:${(parseFloat(row.amount || '0') || 0).toFixed(2)}`)\n          .join('|');\n        const cashPortion = activeRows\n          .filter((row) => row.method === 'cash')\n          .reduce((sum, row) => sum + (parseFloat(row.amount || '0') || 0), 0);\n        if (cashPortion > 0 && totalApplied > totalDue) {\n          changeDue = totalApplied - totalDue;\n          paymentNotes.push(`Change due: ${formatCurrency(changeDue)}`);\n        }\n      }\n      const noteSegments: string[] = [];\n      if (orderNotes.trim()) {\n        noteSegments.push(orderNotes.trim());\n      }\n      if (selectedWaiterName) {\n        noteSegments.push(`Waiter: ${selectedWaiterName}`);\n      }\n      if (selectedCustomerId) {\n        noteSegments.push(`Customer ID: ${selectedCustomerId}`);\n      }\n      if (orderSummary.discount > 0) {\n        if (discountMode === 'full') {\n          noteSegments.push(\n            `Discount applied: ${\n              discountType === 'percent'\n                ? `${discountValue}%`\n                : formatCurrency(Number(discountValue || '0'))\n            } on full order`\n          );\n        } else {\n          noteSegments.push('Item-wise discounts applied.');\n        }\n      }\n      noteSegments.push(...paymentNotes);\n      // Handle room booking separately\n      if (isRoomBooking) {\n        const selectedRoom = rooms.find((r: any) => r.id === selectedRoomId);\n        if (!selectedRoom) {\n          toast.error('Selected room not found');\n          return;\n        }\n        const checkIn = new Date(checkInDate);\n        const checkOut = new Date(checkOutDate);\n        const nights = Math.ceil((checkOut.getTime() - checkIn.getTime()) / (1000 * 60 * 60 * 24));\n        const roomRate = selectedRoom.basePrice || 0;\n        const totalRoomCharges = roomRate * nights;\n        // Calculate booking total (room charges + tax/service if applicable)\n        const bookingTotal = totalRoomCharges; // You can add tax/service charge here if needed\n        // Calculate actual payment received\n        let actualDepositAmount = 0;\n        if (paymentMode === 'pay-first') {\n          if (paymentTab === 'full') {\n            // For full payment, use the amount received (may be partial)\n            const received = parseFloat(fullPaymentReceived || '0');\n            actualDepositAmount = Number.isFinite(received) && received > 0 ? received : bookingTotal;\n          } else {\n            // For split payment, sum all payment rows\n            const totalReceived = multiPayments.reduce(\n              (sum, row) => sum + (parseFloat(row.amount || '0') || 0),\n              0\n            );\n            actualDepositAmount = totalReceived > 0 ? totalReceived : bookingTotal;\n          }\n        } else {\n          // Pay-later mode: no deposit\n          actualDepositAmount = 0;\n        }\n        // Determine payment status\n        let paymentStatus: 'paid' | 'partial' | 'pending' = 'pending';\n        if (paymentMode === 'pay-first') {\n          if (actualDepositAmount >= bookingTotal) {\n            paymentStatus = 'paid';\n          } else if (actualDepositAmount > 0) {\n            paymentStatus = 'partial';\n          } else {\n            paymentStatus = 'pending';\n          }\n        }\n        try {\n          const bookingData = {\n            branchId: currentBranchId,\n            roomId: selectedRoomId,\n            guestId: selectedCustomerId || undefined,\n            guestName: customerInfo.name || 'Guest',\n            guestEmail: customerInfo.email || undefined,\n            guestPhone: customerInfo.phone || '',\n            numberOfGuests: numberOfGuests,\n            checkInDate: checkInDate,\n            checkOutDate: checkOutDate,\n            roomRate: roomRate,\n            paymentStatus: paymentStatus,\n            paymentMethod: paymentTab === 'full' ? fullPaymentMethod : 'split',\n            depositAmount: actualDepositAmount > 0 ? actualDepositAmount : undefined,\n            specialRequests: specialRequests || undefined,\n            notes: noteSegments.length > 0 ? noteSegments.join('\\n') : undefined,\n          };\n          const bookingResponse = await createBooking(bookingData).unwrap();\n          const booking = (bookingResponse as any).data || bookingResponse;\n          const bookingId = booking.id || booking._id;\n          const bookingNumber = booking.bookingNumber || booking.booking_number || bookingId;\n          setCurrentOrderId(bookingId);\n          setPaymentSuccessOrder({\n            orderId: bookingId,\n            orderNumber: bookingNumber,\n            totalPaid: actualDepositAmount,\n            changeDue: changeDue > 0 ? changeDue : undefined,\n            summary: `Room Booking: ${selectedRoom.roomNumber} | ${nights} night(s) | ${paymentNotes.join(' | ')}`,\n            breakdown: paymentBreakdown,\n          });\n          if (paymentStatus === 'paid') {\n            toast.success('Room booking created and fully paid');\n          } else if (paymentStatus === 'partial') {\n            toast.success(`Room booking created with partial payment of ${formatCurrency(actualDepositAmount)}`);\n          } else {\n            toast.success('Room booking created (payment pending)');\n          }\n          // Reset form\n          setSelectedRoomId('');\n          setCheckInDate(new Date().toISOString().split('T')[0]);\n          const tomorrow = new Date();\n          tomorrow.setDate(tomorrow.getDate() + 1);\n          setCheckOutDate(tomorrow.toISOString().split('T')[0]);\n          setNumberOfGuests(1);\n          setSpecialRequests('');\n          setCustomerInfo({ name: '', phone: '', email: '' });\n          setHasStartedOrder(false);\n          setIsPaymentModalOpen(false);\n          setIsCartModalOpen(false);\n          return;\n        } catch (error: any) {\n          toast.error(error?.data?.message || 'Failed to create booking');\n          return;\n        }\n      }\n      // At this point, isRoomBooking is false (we returned early if true)\n      if (isRoomBooking) {\n        return;\n      }\n      // Determine the actual payment method to store in order\n      // For full payment, use the actual method code (bkash, nagad, etc.)\n      // For split payment, use the primary method or 'split' with breakdown\n      const actualPaymentMethod = paymentTab === 'full' \n        ? fullPaymentMethod  // Store actual method code (bkash, nagad, cash, etc.)\n        : paymentMethodForBackend; // For split, keep as 'split'\n      const orderTypeForBackend: CreatePOSOrderRequest['orderType'] =\n        isRoomService ? 'room_service' : (orderType as 'dine-in' | 'delivery' | 'takeaway');\n      const orderData: CreatePOSOrderRequest = {\n        orderType: orderTypeForBackend,\n        ...(requiresTable && selectedTable ? { tableId: selectedTable } : {}),\n        ...(requiresTable && selectedTable ? { guestCount: guestCount || 1 } : {}),\n        ...(isDelivery\n          ? {\n              deliveryFee: deliveryFeeValue,\n              deliveryDetails: deliveryPayload,\n            }\n          : {}),\n        ...(isTakeaway\n          ? {\n              takeawayDetails: takeawayPayload,\n            }\n          : {}),\n        ...(isRoomService && roomServiceBookingId && selectedRoomServiceBooking\n          ? {\n              bookingId: roomServiceBookingId,\n              roomId: selectedRoomServiceBooking.roomId,\n              roomNumber: selectedRoomServiceBooking.roomNumber,\n            }\n          : {}),\n        items: cart.map((item) => ({\n          menuItemId: item.menuItemId,\n          quantity: item.quantity,\n          price: item.price,\n          notes: buildItemNotes(item),\n        })),\n        customerInfo: customerInfo,\n        totalAmount: totalDue,\n        // In \"pay-first\" mode, create order as 'paid' (payment happens before order creation)\n        // In \"pay-later\" mode, create order as 'pending' then process payment (except room service)\n        status: paymentMode === 'pay-first' ? 'paid' as const : 'pending' as const,\n        paymentMethod: actualPaymentMethod, // Store actual method code (bkash, nagad, etc.)\n        transactionId: transactionReference, // Passed to backend for split payment breakdown parsing\n        notes: noteSegments.length > 0 ? noteSegments.join('\\n') : undefined,\n        ...(selectedWaiterId ? { waiterId: selectedWaiterId } : {}),\n        ...(selectedCustomerId && loyaltyRedemption.pointsRedeemed > 0\n          ? {\n              customerId: selectedCustomerId,\n              loyaltyPointsRedeemed: loyaltyRedemption.pointsRedeemed,\n              loyaltyDiscount: loyaltyRedemption.discount,\n            }\n          : selectedCustomerId\n          ? { customerId: selectedCustomerId }\n          : {}),\n      };\n      const orderResponse = await createOrderWithRetry(orderData);\n      const order = (orderResponse as any).data || orderResponse;\n      const orderId = order.id || order._id;\n      const orderNumber = order.orderNumber || order.order_number || orderId;\n      // Only process payment separately if order was created as 'pending' (pay-later mode)\n      // In pay-first mode, order is already created as 'paid', so we don't need to process payment again.\n      // For room service in pay-later mode, we intentionally do NOT process payment here so that\n      // charges remain pending on the booking and are settled at hotel checkout.\n      if (paymentMode === 'pay-later' && !isRoomService) {\n        await processPayment({\n          orderId,\n          amount: totalDue,\n          method: paymentTab === 'full' ? fullPaymentMethod : paymentMethodForBackend,\n          transactionId: transactionReference,\n        }).unwrap();\n      }\n      setCurrentOrderId(orderId);\n      setPaymentSuccessOrder({\n          orderId,\n        orderNumber,\n        totalPaid: totalDue,\n        changeDue: changeDue > 0 ? changeDue : undefined,\n        summary: paymentNotes.join(' | '),\n        breakdown: paymentBreakdown,\n      });\n      toast.success('Payment completed successfully');\n      refetchQueue();\n      // Invalidate cache and refetch tables to update status after payment\n      dispatch(posApi.util.invalidateTags(['Table', 'POS']));\n      // Use a longer delay to ensure backend has fully processed the payment,\n      // updated order status, and cleared table associations if needed\n      // Increased from 300ms to 1000ms to avoid race conditions\n      setTimeout(() => {\n        refetchTables(); // Refetch tables to update status after payment\n      }, 1000);\n      clearCart();\n      if (requiresTable) {\n        setSelectedTable('');\n        setGuestCount(1);\n        if (typeof window !== 'undefined') {\n          localStorage.removeItem('pos_selectedTable');\n          localStorage.removeItem('pos_guestCount');\n        }\n      }\n      if (isDelivery) {\n        resetDeliveryDetails();\n      }\n      if (isTakeaway) {\n        resetTakeawayDetails();\n      }\n      if (typeof window !== 'undefined') {\n        removeEncryptedItem('pos_customerInfo');\n      }\n      setCustomerInfo({ name: '', phone: '', email: '' });\n      setHasStartedOrder(false);\n      setIsPaymentModalOpen(false);\n      setIsCartModalOpen(false);\n    } catch (error: any) {\n      console.error('Payment flow failed:', error);\n      toast.error(error?.data?.message || 'Failed to process payment');\n    }\n  };\n  const handlePrintReceipt = async (orderId: string, usePDF = false) => {\n    try {\n      if (usePDF) {\n        const result = await printReceiptPDF({\n          orderId,\n          printerId: selectedPrinter || undefined,\n        }).unwrap();\n        toast.success(result.message);\n      } else {\n        const result = await printReceipt({\n          orderId,\n          printerId: selectedPrinter || undefined,\n        }).unwrap();\n        toast.success(result.message);\n      }\n    } catch (error) {\n      console.error('Error printing receipt:', error);\n      toast.error('Failed to print receipt. Please try again.');\n    }\n  };\n  const handleDownloadReceiptPDF = async (orderId: string) => {\n    try {\n      const blob = await downloadReceiptPDF(orderId).unwrap();\n      const url = window.URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `receipt-${orderId}.pdf`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      window.URL.revokeObjectURL(url);\n      toast.success('Receipt PDF downloaded successfully');\n    } catch (error) {\n      console.error('Error downloading receipt PDF:', error);\n      toast.error('Failed to download receipt PDF. Please try again.');\n    }\n  };\n  const handleViewReceipt = useCallback(\n    (orderId: string) => {\n      if (!orderId) {\n        toast.error('Receipt is not available for this order yet.');\n        return;\n      }\n      setQueueDetailId(null);\n    setCurrentOrderId(orderId);\n    setIsReceiptModalOpen(true);\n    },\n    []\n  );\n  useEffect(() => {\n    if (isReceiptModalOpen && currentOrderId) {\n      refetchReceipt();\n    }\n  }, [isReceiptModalOpen, currentOrderId, refetchReceipt]);\n  const handleQueueRefresh = useCallback(() => {\n    refetchQueue();\n  }, [refetchQueue]);\n  const handleQueueViewDetails = useCallback((orderId: string) => {\n    setQueueDetailId(orderId);\n  }, []);\n  const resolveOrderId = useCallback((order: any) => {\n    if (!order) return '';\n    return order.id || order._id || '';\n  }, []);\n  const handleQueueCancel = useCallback(\n    async (orderId: string) => {\n      if (typeof window !== 'undefined') {\n        const confirmed = window.confirm('Are you sure you want to cancel this order?');\n        if (!confirmed) {\n          return;\n        }\n      }\n      try {\n        setQueueActionOrderId(orderId);\n        await cancelOrder({ id: orderId, reason: 'Cancelled from queue' }).unwrap();\n        toast.success('Order cancelled successfully');\n        if (queueDetailId === orderId) {\n          setQueueDetailId(null);\n        }\n        refetchQueue();\n      } catch (error: any) {\n        console.error('Error cancelling order:', error);\n        toast.error(error?.data?.message || 'Failed to cancel order');\n      } finally {\n        setQueueActionOrderId(null);\n      }\n    },\n    [cancelOrder, queueDetailId, refetchQueue]\n  );\n  const getTableStatus = (table: any) => {\n    if (table.status === 'reserved') return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-200 border-2 border-yellow-500/50';\n    if (table.status === 'available') return 'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-200 border-2 border-green-500/50';\n    // For occupied tables, check order status for visual indicators\n    if (table.status === 'occupied' && table.orderDetails) {\n      const orderStatus = table.orderDetails.orderStatus \n        || table.orderDetails.status \n        || table.orderDetails.allOrders?.[0]?.status \n        || 'pending';\n      if (orderStatus === 'paid') {\n        // In pay-first mode: Paid orders mean customer is still using table (orange/yellow)\n        // In pay-later mode: Paid orders mean table is ready to release (green)\n        return paymentMode === 'pay-first'\n          ? 'bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-200 border-2 border-amber-500/50'\n          : 'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-200 border-2 border-green-500/50';\n      } else if (orderStatus === 'pending') {\n        // Yellow badge: Pending Payment\n        return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-200 border-2 border-yellow-500/50';\n      } else {\n        // Red badge: Needs Attention (cancelled or other status)\n        return 'bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-200 border-2 border-red-500/50';\n      }\n    }\n    // Default for occupied without order details\n    return 'bg-orange-100 text-orange-800 dark:bg-orange-900/40 dark:text-orange-200 border-2 border-orange-500/50';\n  };\n  const getTableStatusText = (table: any) => {\n    if (table.status === 'reserved') return 'Reserved';\n    if (table.status === 'available') return 'Available';\n    // For occupied tables, show payment status\n    if (table.status === 'occupied' && table.orderDetails) {\n      const orderStatus = table.orderDetails.orderStatus \n        || table.orderDetails.status \n        || table.orderDetails.allOrders?.[0]?.status \n        || 'pending';\n      if (orderStatus === 'paid') {\n        // In pay-first mode, paid orders mean customer is still using the table\n        // In pay-later mode, paid orders mean table is ready to release\n        return paymentMode === 'pay-first' \n          ? 'Paid - In Use' \n          : 'Paid - Ready to Release';\n      } else if (orderStatus === 'pending') {\n        return 'Pending Payment';\n      } else {\n        return 'Needs Attention';\n      }\n    }\n    return 'Occupied';\n  };\n  const isOrderingActive = useMemo(() => {\n    if (orderType === 'dine-in') {\n      return hasStartedOrder && Boolean(selectedTable);\n    }\n    // For room-booking and room-service, show the ordering workspace immediately\n    // (no gateway screen). Checkout is still blocked until required fields are valid.\n    if (orderType === 'room-booking' || orderType === 'room-service') {\n      return true;\n    }\n    return hasStartedOrder;\n  }, [orderType, hasStartedOrder, selectedTable]);\n  const modifierPreview = useMemo(() => {\n    if (!modifierEditor) return null;\n    const previewItem = buildCartItemFromMenuItem(modifierEditor.item, {\n      ...modifierEditor,\n      quantity: 1,\n      id: 'preview',\n    } as Partial<ModifierConfig> & { id: string });\n    return previewItem;\n  }, [buildCartItemFromMenuItem, modifierEditor]);\n  const quickCashSuggestions = useMemo(() => {\n    if (orderSummary.total <= 0) {\n      return [] as number[];\n    }\n    const base = Number(orderSummary.total.toFixed(2));\n    const suggestions = new Set<number>();\n    suggestions.add(base);\n    suggestions.add(Math.ceil(base / 5) * 5);\n    suggestions.add(Math.ceil(base / 10) * 10);\n    suggestions.add(base + 5);\n    suggestions.add(base + 10);\n    return Array.from(suggestions)\n      .filter((value) => Number.isFinite(value) && value > 0)\n      .map((value) => Number(value.toFixed(2)))\n      .sort((a, b) => a - b);\n  }, [orderSummary.total]);\n  const fullPaymentChange = useMemo(() => {\n    if (paymentTab !== 'full' || fullPaymentMethod !== 'cash') {\n      return 0;\n    }\n    const received = parseFloat(fullPaymentReceived || '0');\n    if (!Number.isFinite(received)) {\n      return 0;\n    }\n    return Math.max(0, received - orderSummary.total);\n  }, [fullPaymentMethod, fullPaymentReceived, orderSummary.total, paymentTab]);\n  const splitTotals = useMemo(() => {\n    const applied = multiPayments.reduce((sum, row) => sum + (parseFloat(row.amount || '0') || 0), 0);\n    return {\n      applied,\n      remaining: Number((orderSummary.total - applied).toFixed(2)),\n    };\n  }, [multiPayments, orderSummary.total]);\n  const receiptErrorMessage = useMemo(() => {\n    if (!receiptErrorDetails || typeof receiptErrorDetails !== 'object') {\n      return '';\n    }\n    const maybeData = (receiptErrorDetails as Record<string, unknown>)?.data as Record<string, unknown> | undefined;\n    if (maybeData && typeof maybeData === 'object' && 'message' in maybeData) {\n      return String(maybeData.message);\n    }\n    return '';\n  }, [receiptErrorDetails]);\n  const renderPreOrderView = () => {\n    if (orderType === 'dine-in') {\n      return (\n        <div className=\"flex-1 overflow-y-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6 md:py-10 min-h-0\">\n          <div className=\"mx-auto max-w-5xl space-y-4 sm:space-y-6 md:space-y-8\">\n            <div className=\"text-center space-y-2\">\n              <h2 className=\"text-lg sm:text-xl md:text-2xl font-semibold text-gray-900 dark:text-slate-100\">Select a table to start a dine-in order</h2>\n              <p className=\"text-sm sm:text-base text-gray-600 dark:text-slate-400\">Tap an available table below to launch the ordering workspace.</p>\n            </div>\n            <div className=\"grid gap-3 sm:gap-4 grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4\">\n              {tablesLoading ? (\n                [...Array(8)].map((_, index) => (\n                  <div key={index} className=\"h-40 rounded-2xl border border-gray-200 dark:border-slate-800 bg-gray-100 dark:bg-slate-900/40 animate-pulse\" />\n                ))\n              ) : tables.length > 0 ? (\n                tables.map((table: any) => {\n                  const statusClass = getTableStatus(table);\n                  const isSelected = selectedTable === table.id;\n                  const hasOrderDetails = table.orderDetails !== null && table.orderDetails !== undefined;\n                  const orderStatus = table.orderDetails?.orderStatus \n                    || table.orderDetails?.status \n                    || table.orderDetails?.allOrders?.[0]?.status \n                    || 'pending';\n                  const isPaid = orderStatus === 'paid' && table.status === 'occupied';\n                  const handleContextMenu = (e: React.MouseEvent) => {\n                    e.preventDefault();\n                    if (isPaid) {\n                      setContextMenu({ tableId: table.id, x: e.clientX, y: e.clientY });\n                    }\n                  };\n                  const handleTouchStart = (e: React.TouchEvent) => {\n                    if (!isPaid) return;\n                    const touch = e.touches[0];\n                    const timer = setTimeout(() => {\n                      setContextMenu({ tableId: table.id, x: touch.clientX, y: touch.clientY });\n                    }, 500);\n                    const handleTouchEnd = () => {\n                      clearTimeout(timer);\n                      document.removeEventListener('touchend', handleTouchEnd);\n                    };\n                    document.addEventListener('touchend', handleTouchEnd, { once: true });\n                  };\n                  return (\n                    <div key={table.id} className=\"relative\">\n                      <button\n                        onClick={() => {\n                          if (contextMenu?.tableId !== table.id) {\n                            handleTableSelection(table.id);\n                          }\n                        }}\n                        onContextMenu={handleContextMenu}\n                        onTouchStart={handleTouchStart}\n                        className={`rounded-2xl border-2 p-6 text-left transition-all w-full h-full flex flex-col justify-between ${\n                          isSelected\n                            ? 'border-sky-500 bg-sky-500/10 shadow-lg shadow-sky-500/20'\n                            : hasOrderDetails || table.status === 'occupied'\n                            ? 'border-orange-500/50 bg-orange-500/5 hover:border-orange-400/60'\n                            : 'border-gray-300 dark:border-slate-900 bg-white dark:bg-slate-950/60 hover:border-sky-600/60 hover:shadow-lg hover:shadow-sky-900/20'\n                        }`}\n                      >\n                      <div className=\"space-y-4\">\n                        <div className=\"flex items-start justify-between\">\n                          <div>\n                            <p className=\"text-xs uppercase tracking-[0.3em] text-gray-500 dark:text-slate-500\">Table No.</p>\n                            <p className=\"text-xl font-semibold text-gray-900 dark:text-slate-100 truncate\">\n                              {table.number || table.tableNumber || table.name || table.id}\n                            </p>\n                          </div>\n                          {table.location && (\n                            <Badge variant=\"secondary\" className=\"text-xs bg-slate-800 text-slate-300\">\n                              {table.location}\n                            </Badge>\n                          )}\n                        </div>\n                        <Badge className={`${statusClass} border border-white/10`}>\n                          {getTableStatusText(table)}\n                        </Badge>\n                        {/* Always show capacity */}\n                        <div className=\"flex items-center justify-between text-xs pt-1\">\n                          <span className=\"text-slate-400\">Capacity:</span>\n                          <span className=\"font-semibold text-slate-300\">{table.capacity || 0} seats</span>\n                        </div>\n                        {hasOrderDetails ? (\n                          <div className=\"space-y-2 text-xs pt-2 border-t border-slate-800\">\n                            {/* Order Status - Only show for pending orders (paid orders don't show orderDetails) */}\n                            {table.orderDetails.orderStatus && table.orderDetails.orderStatus === 'pending' && (\n                              <div className=\"flex items-center justify-between\">\n                                <span className=\"text-slate-400\">Order Status:</span>\n                                <Badge className=\"bg-amber-500/10 text-amber-200 border border-amber-500/30 text-xs\">\n                                  Pending Payment\n                                </Badge>\n                              </div>\n                            )}\n                            {/* Token/Order Number */}\n                            <div className=\"flex items-center justify-between text-slate-300\">\n                              <span className=\"text-slate-400\">Token:</span>\n                              <span className=\"font-semibold\">{table.orderDetails.tokenNumber || table.orderDetails.orderNumber}</span>\n                            </div>\n                            {/* Amount */}\n                            <div className=\"flex items-center justify-between text-slate-300\">\n                              <span className=\"text-slate-400\">Amount:</span>\n                              <span className=\"font-semibold text-emerald-400\">{formatCurrency(table.orderDetails.totalAmount || 0)}</span>\n                            </div>\n                            {/* Waiter - Always show if available */}\n                            {table.orderDetails.waiterName && (\n                              <div className=\"flex items-center justify-between text-slate-300\">\n                                <span className=\"text-slate-400\">Waiter:</span>\n                                <span className=\"font-semibold text-sky-300\">{table.orderDetails.waiterName}</span>\n                              </div>\n                            )}\n                            {/* Used Seats */}\n                            {table.orderDetails.usedSeats !== undefined && (\n                              <div className=\"flex items-center justify-between text-slate-300\">\n                                <span className=\"text-slate-400\">Used Seats:</span>\n                                <span className=\"font-semibold\">{table.orderDetails.usedSeats} / {table.capacity || 0}</span>\n                              </div>\n                            )}\n                            {/* Remaining Seats - Show prominently */}\n                            {table.orderDetails.remainingSeats !== undefined && (\n                              <div className={`flex items-center justify-between mt-2 pt-2 border-t ${\n                                table.orderDetails.remainingSeats > 0 \n                                  ? 'border-sky-800' \n                                  : 'border-slate-800'\n                              }`}>\n                                <span className={`font-medium ${\n                                  table.orderDetails.remainingSeats > 0 \n                                    ? 'text-sky-400' \n                                    : 'text-slate-400'\n                                }`}>\n                                  {table.orderDetails.remainingSeats > 0 ? 'Available Seats:' : 'Fully Occupied'}\n                                </span>\n                                <span className={`font-bold ${\n                                  table.orderDetails.remainingSeats > 0 \n                                    ? 'text-sky-300' \n                                    : 'text-orange-300'\n                                }`}>\n                                  {table.orderDetails.remainingSeats > 0 ? `${table.orderDetails.remainingSeats} seats` : ''}\n                                </span>\n                              </div>\n                            )}\n                            {/* Hold Count */}\n                            {table.orderDetails.holdCount > 0 && (\n                              <div className=\"flex items-center justify-between text-orange-300 mt-1\">\n                                <span className=\"text-xs\">Held:</span>\n                                <span className=\"font-semibold text-xs\">{table.orderDetails.holdCount}x</span>\n                              </div>\n                            )}\n                          </div>\n                        ) : (\n                          /* Show status for tables without order details */\n                          <div className=\"pt-2 border-t border-slate-800\">\n                            <div className=\"flex items-center justify-between text-xs\">\n                              <span className=\"text-slate-400\">Status:</span>\n                              <span className={`font-semibold ${\n                                table.status === 'available' \n                                  ? 'text-green-400' \n                                  : table.status === 'reserved'\n                                  ? 'text-yellow-400'\n                                  : 'text-orange-400'\n                              }`}>\n                                {table.status === 'available' \n                                  ? 'Available' \n                                  : table.status === 'reserved'\n                                  ? 'Reserved'\n                                  : 'Occupied'}\n                              </span>\n                            </div>\n                          </div>\n                        )}\n                      </div>\n                    </button>\n                    {contextMenu && contextMenu.tableId === table.id && (\n                      <div\n                        className=\"fixed z-50 min-w-[200px] rounded-lg border border-gray-300 dark:border-slate-700 bg-white dark:bg-slate-900 shadow-xl py-2\"\n                        style={{\n                          left: `${contextMenu.x}px`,\n                          top: `${contextMenu.y}px`,\n                        }}\n                        onClick={(e) => e.stopPropagation()}\n                      >\n                        {isPaid && (\n                          <button\n                            onClick={async () => {\n                              try {\n                                await updateTableStatus({\n                                  id: table.id,\n                                  status: 'available'\n                                }).unwrap();\n                                toast.success('Table released successfully');\n                                setContextMenu(null);\n                                refetchTables();\n                              } catch (error: any) {\n                                toast.error(error?.data?.message || 'Failed to release table');\n                              }\n                            }}\n                            className=\"w-full px-4 py-2 text-left text-sm text-green-600 dark:text-green-400 hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors flex items-center gap-2\"\n                          >\n                            <span></span>\n                            <span>Release Table</span>\n                          </button>\n                        )}\n                        <button\n                          onClick={() => {\n                            handleTableSelection(table.id);\n                            setContextMenu(null);\n                          }}\n                          className=\"w-full px-4 py-2 text-left text-sm text-gray-900 dark:text-slate-200 hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors flex items-center gap-2\"\n                        >\n                          <span></span>\n                          <span>View Details</span>\n                        </button>\n                      </div>\n                    )}\n                  </div>\n                  );\n                })\n              ) : (\n                <div className=\"col-span-full rounded-2xl border border-gray-200 dark:border-slate-900 bg-gray-50 dark:bg-slate-950/60 p-10 text-center\">\n                  <p className=\"text-gray-700 dark:text-slate-300 font-medium\">No tables configured for this branch yet.</p>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      );\n    }\n    // For room-booking and room-service, show the main ordering workspace directly\n    // (no delivery/takeaway pre-order card). The UI for these modes already lives\n    // inside renderOrderingWorkspace.\n    if (orderType === 'room-booking' || orderType === 'room-service') {\n      return null;\n    }\n    const isDelivery = orderType === 'delivery';\n    const IconComponent = isDelivery ? TruckIcon : ShoppingBagIcon;\n    const label = isDelivery ? 'Create Delivery Order' : 'Create Takeaway Order';\n    const helper =\n      orderType === 'delivery'\n        ? 'Capture customer address, driver assignment, and delivery fee details.'\n        : 'Collect pickup contact info and prep instructions before adding items.';\n    return (\n      <div className=\"flex flex-1 items-center justify-center px-6 py-12\">\n        <button\n          onClick={() => setHasStartedOrder(true)}\n          className=\"w-full max-w-sm rounded-3xl border-2 border-sky-500/40 bg-gray-50 dark:bg-slate-950/60 p-10 text-center transition hover:border-sky-400 hover:bg-gray-100 dark:hover:bg-slate-900/70 shadow-xl shadow-sky-950/20 space-y-6\"\n        >\n          <div className=\"mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-sky-500/15 text-sky-200\">\n            <IconComponent className=\"h-8 w-8\" />\n          </div>\n          <div className=\"space-y-2\">\n            <p className=\"text-lg font-semibold text-gray-900 dark:text-slate-100\">{label}</p>\n            <p className=\"text-sm text-gray-600 dark:text-slate-400\">{helper}</p>\n          </div>\n        </button>\n      </div>\n    );\n  };\n  const renderOrderingWorkspace = () => (\n    <div className=\"flex-1 flex flex-col overflow-hidden min-h-0\">\n      <div className=\"bg-gray-50 dark:bg-slate-900/80 backdrop-blur border-b border-gray-200 dark:border-slate-800 px-3 sm:px-4 lg:px-6 py-3 sm:py-4\">\n        <div className=\"flex flex-col gap-3 sm:gap-4 lg:flex-row lg:items-end lg:justify-between\">\n          <div className=\"flex-1 min-w-0\">\n            <label className=\"text-xs font-semibold uppercase text-slate-400 tracking-[0.2em] block mb-2\">\n              Search menu items\n            </label>\n            <div className=\"relative\">\n              <MagnifyingGlassIcon className=\"h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-500\" />\n              <Input\n                placeholder='Try \"salmon\", \"latte\", or scan a barcode'\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-11 h-10 sm:h-11 bg-white dark:bg-slate-950/90 border border-gray-300 dark:border-slate-800 text-gray-900 dark:text-slate-100 placeholder:text-gray-400 dark:placeholder:text-slate-500 focus:border-sky-600 focus:ring-sky-600/40 text-sm sm:text-base\"\n              />\n            </div>\n          </div>\n          <div className=\"flex flex-col gap-2 sm:gap-3 items-stretch lg:items-end\">\n            <div className=\"flex flex-wrap items-center gap-2 sm:gap-3 justify-between sm:justify-end\">\n              <div className=\"flex items-center gap-2 rounded-xl border border-gray-300 dark:border-slate-800 bg-white dark:bg-slate-950/80 px-4 py-2\">\n                <UserGroupIcon className=\"h-4 w-4 text-gray-500 dark:text-slate-400\" />\n                <select\n                  value={selectedCategory}\n                  onChange={(e) => setSelectedCategory(e.target.value)}\n                  className=\"bg-transparent text-sm text-gray-900 dark:text-slate-100 focus:outline-none\"\n                >\n                  <option value=\"all\" className=\"bg-white dark:bg-slate-900\">All Categories</option>\n                  {categories.map((category: any) => (\n                    <option key={category.id} value={category.id} className=\"bg-white dark:bg-slate-900\">\n                      {category.name}\n                    </option>\n                  ))}\n                </select>\n              </div>\n              <Button\n                variant=\"secondary\"\n                className=\"flex items-center gap-2 rounded-xl bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80 disabled:opacity-40\"\n                onClick={resetFilters}\n                disabled={selectedCategory === 'all' && !searchQuery}\n              >\n                <FunnelIcon className=\"h-4 w-4\" />\n                Reset Filters\n              </Button>\n              <Button\n                variant=\"secondary\"\n                onClick={() => setIsCalculatorOpen(true)}\n                className=\"flex items-center gap-2 rounded-xl bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80\"\n                title=\"Calculator (F5)\"\n              >\n                <CurrencyDollarIcon className=\"h-4 w-4\" />\n                Calculator\n              </Button>\n            </div>\n            <div className=\"flex flex-wrap items-center gap-2 justify-between sm:justify-end relative w-full sm:w-auto\">\n              <Button\n                variant=\"secondary\"\n                onClick={() => setIsCartModalOpen(true)}\n                className=\"flex items-center gap-1 sm:gap-2 rounded-xl bg-gray-100 dark:bg-slate-900/80 text-gray-900 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80 relative z-10 text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2\"\n              >\n                <ShoppingCartIcon className=\"h-4 w-4\" />\n                <span className=\"hidden sm:inline\">Open Order Cart</span>\n                <span className=\"sm:hidden\">Cart</span>\n              </Button>\n              {/* Payment Mode Toggle - In the middle */}\n              <div className=\"flex items-center gap-1 sm:gap-2 rounded-xl border border-gray-300 dark:border-slate-800 bg-white dark:bg-slate-950/80 px-2 sm:px-3 py-1.5 sm:py-2 relative overflow-visible\">\n                <span className=\"text-xs font-medium text-gray-600 dark:text-slate-400 whitespace-nowrap hidden sm:inline\">\n                  {paymentMode === 'pay-first' ? 'Pay First' : 'Pay Later'}\n                </span>\n                <span className=\"text-xs font-medium text-gray-600 dark:text-slate-400 whitespace-nowrap sm:hidden\">\n                  {paymentMode === 'pay-first' ? 'Pay 1st' : 'Pay Later'}\n                </span>\n                <button\n                  onClick={() => setPaymentMode(prev => prev === 'pay-first' ? 'pay-later' : 'pay-first')}\n                  className=\"relative inline-flex h-5 w-10 items-center rounded-full bg-gray-300 dark:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2\"\n                  title={`Switch to ${paymentMode === 'pay-first' ? 'Pay Later' : 'Pay First'} mode`}\n                >\n                  <span\n                    className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n                      paymentMode === 'pay-first' ? 'translate-x-5' : 'translate-x-0.5'\n                    }`}\n                  />\n                </button>\n                <div className=\"relative group\" style={{ zIndex: 99999 }}>\n                  <InformationCircleIcon className=\"h-4 w-4 text-gray-400 dark:text-slate-500 cursor-help\" />\n                  <div className=\"absolute right-0 top-6 w-72 p-3 bg-white dark:bg-slate-800 text-gray-900 dark:text-white text-xs rounded-lg shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 border border-gray-300 dark:border-slate-700 pointer-events-none group-hover:pointer-events-auto whitespace-normal\" style={{ zIndex: 999999 }}>\n                    <div className=\"space-y-2\">\n                      <p className=\"font-semibold text-sky-300\">Payment Mode Info:</p>\n                      <div className=\"space-y-1.5\">\n                        <p className=\"leading-relaxed\">\n                          <strong className=\"text-emerald-300\">Pay First:</strong> Customer pays before sitting. Tables with paid orders remain occupied until customer leaves.\n                        </p>\n                        <p className=\"leading-relaxed\">\n                          <strong className=\"text-amber-300\">Pay Later:</strong> Customer orders first, pays after. Only pending orders keep tables occupied.\n                        </p>\n                      </div>\n                    </div>\n                    <div className=\"absolute -top-1 right-4 w-2 h-2 bg-white dark:bg-slate-800 border-l border-t border-gray-300 dark:border-slate-700 transform rotate-45\"></div>\n                  </div>\n                </div>\n              </div>\n              <Button\n                variant=\"primary\"\n                onClick={() => setIsPaymentModalOpen(true)}\n                disabled={\n                  (orderType !== 'room-booking' && orderType !== 'room-service' && cart.length === 0) \n                  || (orderType === 'room-booking' && checkoutBlocked)\n                  || (orderType !== 'room-booking' && checkoutBlocked)\n                }\n                className=\"flex items-center gap-1 sm:gap-2 bg-emerald-600 hover:bg-emerald-500 disabled:opacity-40 text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2 flex-1 sm:flex-initial\"\n              >\n                <CreditCardIcon className=\"h-4 w-4\" />\n                <span>\n                  {requiresRoomBooking\n                    ? 'Book Room'\n                    : requiresRoomService\n                    ? 'Charge to Room'\n                    : 'Checkout'}\n                </span>\n              </Button>\n            </div>\n          </div>\n        </div>\n      </div>\n          <div className=\"flex-1 overflow-y-auto p-2 sm:p-3 md:p-4 min-h-0\">\n        {/* Room service booking summary */}\n        {requiresRoomService && selectedRoomServiceBooking && (\n          <div className=\"mb-4 rounded-2xl border border-emerald-500/40 bg-emerald-500/5 px-4 py-3 sm:px-5 sm:py-4 shadow-sm flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\">\n            <div className=\"space-y-1\">\n              <div className=\"flex flex-wrap items-center gap-2 text-sm sm:text-base\">\n                <span className=\"inline-flex items-center gap-1 rounded-full bg-emerald-600/10 px-2.5 py-1 text-emerald-700 dark:text-emerald-200 text-xs sm:text-sm font-semibold\">\n                  <BuildingOfficeIcon className=\"h-4 w-4\" />\n                  Room Service for Room {selectedRoomServiceBooking.roomNumber || ''}\n                </span>\n                <span className=\"text-gray-800 dark:text-slate-100 font-medium\">\n                  {selectedRoomServiceBooking.guestName}\n                </span>\n                <span className=\"text-xs text-gray-500 dark:text-slate-400\">\n                  #{selectedRoomServiceBooking.bookingNumber}\n                </span>\n              </div>\n              <div className=\"flex flex-wrap items-center gap-3 text-xs sm:text-sm text-gray-600 dark:text-slate-300\">\n                <span>\n                  Stay:{' '}\n                  {new Date(selectedRoomServiceBooking.checkInDate).toLocaleDateString()}\n                  {'  '}\n                  {new Date(selectedRoomServiceBooking.checkOutDate).toLocaleDateString()}\n                  {' '}\n                  ({selectedRoomServiceBooking.numberOfNights || 1} night\n                  {selectedRoomServiceBooking.numberOfNights === 1 ? '' : 's'})\n                </span>\n                <span className=\"hidden sm:inline\"></span>\n                <span>\n                  Current total:{' '}\n                  <span className=\"font-semibold text-emerald-600 dark:text-emerald-300\">\n                    {formatCurrency(selectedRoomServiceBooking.totalAmount || 0)}\n                  </span>\n                </span>\n                {selectedRoomServiceBooking.additionalCharges &&\n                  selectedRoomServiceBooking.additionalCharges.length > 0 && (\n                    <span>\n                      Room service charges so far:{' '}\n                      <span className=\"font-semibold\">\n                        {formatCurrency(\n                          selectedRoomServiceBooking.additionalCharges.reduce(\n                            (sum, charge) => sum + (charge.amount || 0),\n                            0,\n                          ),\n                        )}\n                      </span>\n                    </span>\n                  )}\n              </div>\n            </div>\n            <div className=\"text-xs sm:text-sm text-gray-600 dark:text-slate-300\">\n              <div>Status:&nbsp;\n                <span className=\"inline-flex items-center rounded-full bg-emerald-600/15 px-2 py-0.5 text-emerald-700 dark:text-emerald-200 text-[11px] sm:text-xs font-semibold capitalize\">\n                  {selectedRoomServiceBooking.status.replace('_', ' ')}\n                </span>\n              </div>\n              <div className=\"mt-1\">\n                Payment:&nbsp;\n                <span className=\"capitalize\">{selectedRoomServiceBooking.paymentStatus}</span>\n              </div>\n            </div>\n          </div>\n        )}\n        {requiresRoomBooking ? (\n          <div className=\"space-y-6\">\n            {/* Date Selection */}\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium mb-2 text-gray-700 dark:text-slate-300\">\n                  Check-in Date\n                </label>\n                <Input\n                  type=\"date\"\n                  value={checkInDate}\n                  onChange={(e) => setCheckInDate(e.target.value)}\n                  min={new Date().toISOString().split('T')[0]}\n                  className=\"w-full\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium mb-2 text-gray-700 dark:text-slate-300\">\n                  Check-out Date\n                </label>\n                <Input\n                  type=\"date\"\n                  value={checkOutDate}\n                  onChange={(e) => setCheckOutDate(e.target.value)}\n                  min={checkInDate || new Date().toISOString().split('T')[0]}\n                  className=\"w-full\"\n                />\n              </div>\n            </div>\n            {/* Number of Guests */}\n            <div>\n              <label className=\"block text-sm font-medium mb-2 text-gray-700 dark:text-slate-300\">\n                Number of Guests\n              </label>\n              <Input\n                type=\"number\"\n                value={numberOfGuests}\n                onChange={(e) => setNumberOfGuests(Math.max(1, parseInt(e.target.value) || 1))}\n                min=\"1\"\n                className=\"w-full max-w-xs\"\n              />\n            </div>\n            {/* Room Selection */}\n            <div>\n              <label className=\"block text-sm font-medium mb-3 text-gray-700 dark:text-slate-300\">\n                Select Room\n              </label>\n              {roomsLoading ? (\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\n                  {[...Array(6)].map((_, i) => (\n                    <Card key={i} className=\"animate-pulse bg-gray-100 dark:bg-slate-900/40\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"h-32 bg-gray-200 dark:bg-slate-800 rounded-lg mb-3\"></div>\n                        <div className=\"h-4 bg-gray-200 dark:bg-slate-800 rounded mb-2\"></div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              ) : rooms.length > 0 ? (\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\n                  {rooms.map((room: any) => {\n                    const isSelected = selectedRoomId === room.id;\n                    const nights = checkInDate && checkOutDate \n                      ? Math.ceil((new Date(checkOutDate).getTime() - new Date(checkInDate).getTime()) / (1000 * 60 * 60 * 24))\n                      : 1;\n                    const totalPrice = (room.basePrice || 0) * nights;\n                    return (\n                      <Card\n                        key={room.id}\n                        className={`cursor-pointer transition-all ${\n                          isSelected\n                            ? 'border-2 border-sky-500 bg-sky-50 dark:bg-sky-900/20'\n                            : 'border border-gray-200 dark:border-slate-800 hover:border-sky-300'\n                        }`}\n                        onClick={() => {\n                          setSelectedRoomId(room.id);\n                          setHasStartedOrder(true);\n                        }}\n                      >\n                        <CardContent className=\"p-4\">\n                          <div className=\"space-y-2\">\n                            <div className=\"flex items-center justify-between\">\n                              <h3 className=\"font-semibold text-lg text-gray-900 dark:text-slate-100\">\n                                Room {room.roomNumber}\n                              </h3>\n                              {isSelected && (\n                                <Badge variant=\"success\">Selected</Badge>\n                              )}\n                            </div>\n                            <p className=\"text-sm text-gray-600 dark:text-slate-400 capitalize\">\n                              {room.roomType}  Max {room.maxOccupancy} guests\n                            </p>\n                            {room.floor && (\n                              <p className=\"text-xs text-gray-500 dark:text-slate-500\">\n                                Floor {room.floor}\n                              </p>\n                            )}\n                            <div className=\"pt-2 border-t border-gray-200 dark:border-slate-700\">\n                              <div className=\"flex items-center justify-between\">\n                                <span className=\"text-sm text-gray-600 dark:text-slate-400\">\n                                  {nights} night{nights !== 1 ? 's' : ''}\n                                </span>\n                                <span className=\"text-lg font-bold text-emerald-600 dark:text-emerald-400\">\n                                  {formatCurrency(totalPrice)}\n                                </span>\n                              </div>\n                              <p className=\"text-xs text-gray-500 dark:text-slate-500 mt-1\">\n                                {formatCurrency(room.basePrice)}/night\n                              </p>\n                            </div>\n                          </div>\n                        </CardContent>\n                      </Card>\n                    );\n                  })}\n                </div>\n              ) : (\n                <div className=\"text-center py-12 text-gray-600 dark:text-slate-400\">\n                  <p>No available rooms found</p>\n                </div>\n              )}\n            </div>\n            {/* Customer Information */}\n            <div className=\"border-t border-gray-200 dark:border-slate-700 pt-6\">\n              <h3 className=\"text-lg font-semibold mb-4 text-gray-900 dark:text-slate-100\">\n                Guest Information\n              </h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium mb-2 text-gray-700 dark:text-slate-300\">\n                    Guest Name *\n                  </label>\n                  <Input\n                    value={customerInfo.name}\n                    onChange={(e) => setCustomerInfo({ ...customerInfo, name: e.target.value })}\n                    placeholder=\"Enter guest name\"\n                    className=\"w-full\"\n                    required\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium mb-2 text-gray-700 dark:text-slate-300\">\n                    Phone Number *\n                  </label>\n                  <Input\n                    value={customerInfo.phone}\n                    onChange={(e) => setCustomerInfo({ ...customerInfo, phone: e.target.value })}\n                    placeholder=\"Enter phone number\"\n                    className=\"w-full\"\n                    required\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium mb-2 text-gray-700 dark:text-slate-300\">\n                    Email Address\n                  </label>\n                  <Input\n                    type=\"email\"\n                    value={customerInfo.email}\n                    onChange={(e) => setCustomerInfo({ ...customerInfo, email: e.target.value })}\n                    placeholder=\"Enter email (optional)\"\n                    className=\"w-full\"\n                  />\n                </div>\n              </div>\n            </div>\n            {/* Special Requests */}\n            {selectedRoomId && (\n              <div>\n                <label className=\"block text-sm font-medium mb-2 text-gray-700 dark:text-slate-300\">\n                  Special Requests\n                </label>\n                <textarea\n                  value={specialRequests}\n                  onChange={(e) => setSpecialRequests(e.target.value)}\n                  rows={3}\n                  className=\"w-full px-3 py-2 border border-gray-300 dark:border-slate-700 rounded-md bg-white dark:bg-slate-900 text-gray-900 dark:text-slate-100\"\n                  placeholder=\"Any special requests or notes...\"\n                />\n              </div>\n            )}\n          </div>\n        ) : menuItemsLoading ? (\n          <div className=\"grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-2 sm:gap-3 md:gap-4\">\n            {[...Array(8)].map((_, i) => (\n              <Card key={i} className=\"animate-pulse bg-gray-100 dark:bg-slate-900/40 border border-gray-200 dark:border-slate-800\">\n                <CardContent className=\"p-4\">\n                  <div className=\"h-32 bg-gray-200 dark:bg-slate-800 rounded-lg mb-3\"></div>\n                  <div className=\"h-4 bg-gray-200 dark:bg-slate-800 rounded mb-2\"></div>\n                  <div className=\"h-4 bg-gray-200 dark:bg-slate-800 rounded w-2/3\"></div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        ) : filteredMenuItems.length > 0 ? (\n          <div className=\"grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-2 sm:gap-3 md:gap-4\">\n            {filteredMenuItems.map((item) => (\n              <Card\n                key={item.id}\n                className=\"group relative overflow-hidden border border-gray-200 dark:border-slate-800/80 bg-white dark:bg-slate-900/60 backdrop-blur-sm transition-all duration-200 hover:-translate-y-1 hover:border-sky-500/50 hover:shadow-lg hover:shadow-sky-700/20\"\n              >\n                <CardContent className=\"p-2 sm:p-3 md:p-4 space-y-2 sm:space-y-3\">\n                  <div className=\"relative aspect-square rounded-lg sm:rounded-xl bg-gray-100 dark:bg-slate-950/60 flex items-center justify-center border border-gray-200 dark:border-slate-800/80 overflow-hidden\">\n                    {item.image ? (\n                      <Image\n                        src={item.image}\n                        alt={item.name}\n                        width={240}\n                        height={240}\n                        className=\"h-full w-full rounded-xl object-cover\"\n                      />\n                    ) : (\n                      <div className=\"text-4xl\"></div>\n                    )}\n                    {/* Stock overlay in the middle of the image */}\n                    {(item.isOutOfStock || item.isLowStock) && (\n                      <div\n                        className={cn(\n                          'absolute inset-0 flex items-center justify-center backdrop-blur-[1px]',\n                          item.isOutOfStock\n                            ? 'bg-red-900/55'\n                            : 'bg-amber-900/45',\n                        )}\n                      >\n                        <div\n                          className=\"px-4 py-1 rounded-full text-xs font-semibold uppercase tracking-wide border border-white/70 text-red-500 shadow-lg shadow-black/40 bg-white\"\n                        >\n                          {item.isOutOfStock ? 'Out of stock' : 'Low stock'}\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                  <div>\n                    <div className=\"flex items-center justify-between gap-1 sm:gap-2\">\n                      <h3 className=\"font-semibold text-sm sm:text-base text-gray-900 dark:text-slate-100 truncate\">\n                        {item.name}\n                      </h3>\n                      {item.category?.name && (\n                        <Badge className=\"bg-sky-500/10 dark:text-sky-200 text-gray-900 border border-sky-500/20 text-[10px] sm:text-xs\">\n                          {item.category.name}\n                        </Badge>\n                      )}\n                    </div>\n                    <p className=\"mt-1 text-[10px] sm:text-xs text-gray-600 dark:text-slate-400 line-clamp-2 min-h-[24px] sm:min-h-[32px]\">\n                      {item.description || \"Perfect for today's menu.\"}\n                    </p>\n                  </div>\n                  <div className=\"flex items-center justify-between pt-1 sm:pt-2 gap-2\">\n                    <span className=\"text-base sm:text-lg md:text-xl font-bold text-emerald-400\">\n                      {formatCurrency(item.price)}\n                    </span>\n                    <Button\n                      size=\"sm\"\n                      onClick={() => {\n                        if (item.isOutOfStock) {\n                          toast.error('This item is out of stock. Please restock before selling.');\n                          return;\n                        }\n                        if (item.isLowStock) {\n                          toast.error('This item is low on stock and cannot be sold for safety.');\n                          return;\n                        }\n                        addToCart(item);\n                      }}\n                      disabled={item.isOutOfStock || item.isLowStock}\n                      className=\"flex items-center gap-1 rounded-full bg-sky-600 hover:bg-sky-500 disabled:bg-gray-600 disabled:text-gray-200 disabled:cursor-not-allowed disabled:hover:bg-gray-600 text-xs sm:text-sm px-2 sm:px-3 py-1 sm:py-1.5\"\n                    >\n                      <PlusIcon className=\"h-3 w-3 sm:h-4 sm:w-4\" />\n                      <span className=\"hidden sm:inline\">Add</span>\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        ) : (\n          <div className=\"flex flex-col items-center justify-center h-full min-h-[400px] text-center rounded-3xl border border-gray-200 dark:border-slate-800 bg-gray-50 dark:bg-slate-950/50 backdrop-blur-sm\">\n            <div className=\"text-6xl mb-4\"></div>\n            <h3 className=\"text-xl font-semibold text-gray-900 dark:text-slate-100 mb-2\">\n              No menu items found\n            </h3>\n            <p className=\"text-gray-600 dark:text-slate-400 max-w-md\">\n              {searchQuery\n                ? 'No results match your search. Try adjusting the keywords or filters.'\n                : 'Menu items will show up here once they have been added for this branch.'}\n            </p>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n  const renderQueuePanel = () => {\n    if (isQueueCollapsed) {\n      return (\n        <>\n          {/* Mobile: Floating button to open queue */}\n          <button\n            onClick={() => setIsQueueCollapsed(false)}\n            className=\"fixed bottom-4 right-4 z-50 xl:hidden flex items-center justify-center w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-sky-600 hover:bg-sky-500 text-white shadow-lg shadow-sky-600/50 transition-all\"\n            aria-label=\"Open Orders Queue\"\n          >\n            <ClipboardDocumentListIcon className=\"h-6 w-6\" />\n          </button>\n          {/* Desktop: Side collapsed panel */}\n          <aside className=\"hidden xl:flex xl:w-16 xl:flex-col xl:items-center xl:justify-center border-l border-gray-200 dark:border-slate-900/50 bg-white dark:bg-slate-950/60\">\n            <Button\n              variant=\"ghost\"\n              onClick={() => setIsQueueCollapsed(false)}\n              className=\"flex flex-col items-center gap-2 text-gray-600 dark:text-slate-300 hover:text-gray-900 dark:hover:text-white\"\n            >\n              <ChevronLeftIcon className=\"h-5 w-5\" />\n              <span className=\"text-xs font-medium\">Queue</span>\n            </Button>\n          </aside>\n        </>\n      );\n    }\n    return (\n      <>\n        <div\n          className=\"fixed inset-0 z-30 bg-black/50 dark:bg-slate-950/70 backdrop-blur-sm xl:hidden\"\n          onClick={(e) => {\n            e.preventDefault();\n            e.stopPropagation();\n            setIsQueueCollapsed(true);\n          }}\n        />\n        <aside className=\"fixed inset-y-0 right-0 z-40 flex h-full w-full max-w-sm sm:max-w-md flex-col border-l border-gray-200 dark:border-slate-900 bg-white dark:bg-slate-950/95 shadow-xl xl:static xl:z-auto xl:max-w-xs xl:bg-white xl:dark:bg-slate-950/80 min-h-0\">\n          <div className=\"flex items-center justify-between border-b border-gray-200 dark:border-slate-900/70 px-4 py-3\">\n            <div>\n              <p className=\"text-sm font-semibold text-gray-900 dark:text-slate-100\">Orders</p>\n              <p className=\"text-xs text-gray-600 dark:text-slate-400\">\n                {queueTab === 'active' ? 'Active queue' : 'Completed orders'}\n              </p>\n            </div>\n            <div className=\"flex items-center gap-1\">\n              <Button\n                size=\"sm\"\n                variant=\"ghost\"\n                onClick={handleQueueRefresh}\n                disabled={queueLoading}\n                className=\"h-9 w-9 rounded-full border border-gray-300 dark:border-slate-800 bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-200 hover:bg-gray-200 dark:hover:bg-slate-800/80 disabled:opacity-40\"\n                title=\"Refresh\"\n              >\n                <ArrowPathIcon className={`h-4 w-4 ${queueLoading ? 'animate-spin' : ''}`} />\n              </Button>\n              <Button\n                size=\"sm\"\n                variant=\"ghost\"\n                onClick={(e) => {\n                  e.preventDefault();\n                  e.stopPropagation();\n                  setIsQueueCollapsed(true);\n                }}\n                className=\"h-9 w-9 rounded-full border border-gray-300 dark:border-slate-800 bg-gray-100 dark:bg-slate-900/80 text-gray-900 dark:text-slate-200 hover:bg-gray-200 dark:hover:bg-slate-800/80\"\n                title=\"Collapse queue\"\n                type=\"button\"\n              >\n                <ChevronRightIcon className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n          <div className=\"border-b border-gray-300 dark:border-slate-900/70 px-4 py-3 space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              {(['active', 'history'] as const).map((tab) => {\n                const isActive = queueTab === tab;\n                return (\n                  <Button\n                    key={tab}\n                    variant={isActive ? 'primary' : 'secondary'}\n                    size=\"sm\"\n                    onClick={() => setQueueTab(tab)}\n                    className={`rounded-full px-4 py-1.5 text-xs uppercase tracking-wide ${\n                      isActive\n                        ? 'bg-sky-600 hover:bg-sky-500 text-white'\n                        : 'bg-gray-100 dark:bg-slate-900/70 text-gray-700 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-800/70'\n                    }`}\n                  >\n                    {tab === 'active' ? 'Active' : 'History'}\n                  </Button>\n                );\n              })}\n            </div>\n            <div className=\"grid gap-2\">\n              <div className=\"flex items-center gap-2\">\n                <label className=\"text-xs uppercase tracking-[0.3em] text-gray-600 dark:text-slate-500\">Type</label>\n                <select\n                  value={queueOrderTypeFilter}\n                  onChange={(event) => setQueueOrderTypeFilter(event.target.value as typeof queueOrderTypeFilter)}\n                  className=\"flex-1 rounded-lg border border-gray-300 dark:border-slate-800 bg-white dark:bg-slate-950/70 px-3 py-2 text-sm text-gray-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500/40\"\n                >\n                  <option value=\"all\">All Types</option>\n                  {ORDER_TYPE_OPTIONS.map(({ value, label }) => (\n                    <option key={value} value={value}>\n                      {label}\n                    </option>\n                  ))}\n                </select>\n              </div>\n              {queueTab === 'history' && (\n                <div className=\"flex items-center gap-2\">\n                  <label className=\"text-xs uppercase tracking-[0.3em] text-gray-600 dark:text-slate-500\">Status</label>\n                  <select\n                    value={queueStatusFilter}\n                    onChange={(event) => setQueueStatusFilter(event.target.value as typeof queueStatusFilter)}\n                    className=\"flex-1 rounded-lg border border-gray-300 dark:border-slate-800 bg-white dark:bg-slate-950/70 px-3 py-2 text-sm text-gray-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500/40\"\n                  >\n                    {ORDER_STATUS_FILTERS.map((option) => (\n                      <option key={option.value} value={option.value}>\n                        {option.label}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n              )}\n              <div className=\"relative\">\n                <MagnifyingGlassIcon className=\"h-4 w-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-slate-500\" />\n                <Input\n                  value={queueSearchInput}\n                  onChange={(event) => setQueueSearchInput(event.target.value)}\n                  placeholder=\"Search order # or customer\"\n                  className=\"pl-9 pr-3 py-2 text-sm h-10 bg-white dark:bg-slate-950/80 border border-gray-300 dark:border-slate-800 text-gray-900 dark:text-slate-100 placeholder:text-gray-400 dark:placeholder:text-slate-500 focus:border-sky-600 focus:ring-sky-600/40\"\n                />\n              </div>\n              <div className=\"flex items-center justify-between rounded-lg border border-gray-300 dark:border-slate-900 bg-gray-50 dark:bg-slate-950/70 px-3 py-2 text-xs text-gray-700 dark:text-slate-300\">\n                <span>{queueOrders.length} order{queueOrders.length === 1 ? '' : 's'} listed</span>\n                <span className=\"font-semibold text-emerald-600 dark:text-emerald-300\">{formatCurrency(queueTotalAmount)}</span>\n              </div>\n            </div>\n          </div>\n          <div className=\"flex-1 overflow-y-auto px-4 py-4 space-y-3\">\n            {queueLoading ? (\n              [...Array(5)].map((_, index) => (\n                <div key={index} className=\"h-24 rounded-2xl border border-gray-300 dark:border-slate-900/60 bg-gray-100 dark:bg-slate-900/40 animate-pulse\" />\n              ))\n            ) : queueOrders.length === 0 ? (\n              <div className=\"rounded-2xl border border-gray-300 dark:border-slate-900/60 bg-gray-50 dark:bg-slate-950/70 p-6 text-center text-sm text-gray-600 dark:text-slate-400\">\n                No orders found with the selected filters.\n              </div>\n            ) : (\n              queueOrders.map((order: any, index: number) => {\n                const orderId = resolveOrderId(order);\n                const derivedKey = orderId || order.orderNumber || `order-${index}`;\n                const canAct = Boolean(orderId);\n                return (\n                <div\n                  key={derivedKey}\n                  className=\"rounded-2xl border border-gray-300 dark:border-slate-900/60 bg-white dark:bg-slate-950/70 p-4 shadow-sm transition hover:border-sky-800/50 hover:shadow-sky-900/20\"\n                >\n                  <div className=\"flex items-start justify-between gap-3\">\n                    <div>\n                      <p className=\"text-sm font-semibold text-gray-900 dark:text-slate-100\">\n                        {order.orderNumber || (orderId ? `Order ${orderId?.slice(-6)}` : 'Order')}\n                      </p>\n                      <p className=\"text-xs text-gray-600 dark:text-slate-500\">{order.createdAt ? formatDateTime(order.createdAt) : 'N/A'}</p>\n                    </div>\n                    <Badge className={ORDER_STATUS_STYLES[order.status as 'pending' | 'paid' | 'cancelled'] || ORDER_STATUS_STYLES.pending}>\n                      {ORDER_STATUS_LABELS[order.status as 'pending' | 'paid' | 'cancelled'] || order.status}\n                    </Badge>\n                  </div>\n                  <div className=\"mt-3 flex flex-wrap items-center gap-2 text-xs text-gray-700 dark:text-slate-300\">\n                    <span className=\"rounded-full border border-gray-300 dark:border-slate-800 bg-gray-100 dark:bg-slate-900/70 px-3 py-1 text-gray-900 dark:text-slate-200\">\n                      {getOrderTypeLabel(order.orderType as OrderType)}\n                    </span>\n                    <span className=\"rounded-full border border-gray-300 dark:border-slate-800 bg-gray-100 dark:bg-slate-900/70 px-3 py-1 text-gray-900 dark:text-slate-200\">\n                      {formatCurrency(Number(order.totalAmount || 0))}\n                    </span>\n                    {order.paymentMethod && (\n                      <span className=\"rounded-full border border-gray-300 dark:border-slate-800 bg-gray-100 dark:bg-slate-900/70 px-3 py-1 text-gray-900 dark:text-slate-200\">\n                        Payment: {order.paymentMethod}\n                      </span>\n                    )}\n                    {order?.customerInfo?.name && (\n                      <span className=\"rounded-full border border-gray-300 dark:border-slate-800 bg-gray-100 dark:bg-slate-900/70 px-3 py-1 text-gray-900 dark:text-slate-200\">\n                        {order.customerInfo.name}\n                      </span>\n                    )}\n                  </div>\n                  {order.notes && (\n                    <p className=\"mt-2 rounded-lg border border-gray-300 dark:border-slate-900 bg-gray-50 dark:bg-slate-950/80 px-3 py-2 text-xs text-gray-600 dark:text-slate-400\">\n                      {order.notes}\n                    </p>\n                  )}\n                  <div className=\"mt-4 flex flex-wrap items-center gap-2\">\n                    <Button\n                      size=\"sm\"\n                      variant=\"secondary\"\n                      onClick={() => canAct && handleQueueViewDetails(orderId)}\n                      disabled={!canAct}\n                      className=\"rounded-lg bg-gray-100 dark:bg-slate-900/80 text-gray-900 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80 disabled:opacity-40\"\n                    >\n                      View\n                    </Button>\n                    <Button\n                      size=\"sm\"\n                      variant=\"secondary\"\n                      onClick={() => canAct && handleViewReceipt(orderId)}\n                      disabled={!canAct}\n                      className=\"rounded-lg bg-gray-100 dark:bg-slate-900/80 text-gray-900 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80 disabled:opacity-40\"\n                    >\n                      Receipt\n                    </Button>\n                    <Button\n                      size=\"sm\"\n                      variant=\"secondary\"\n                      onClick={() => canAct && handlePrintReceipt(orderId, false)}\n                      disabled={!canAct}\n                      className=\"rounded-lg bg-gray-100 dark:bg-slate-900/80 text-gray-900 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80 disabled:opacity-40\"\n                    >\n                      Print\n                    </Button>\n                    {order.status === 'pending' && (\n                      <>\n                        <Button\n                          size=\"sm\"\n                          variant=\"secondary\"\n                          onClick={async () => {\n                            if (!canAct) return;\n                            try {\n                              await updateOrder({\n                                id: orderId,\n                                data: { status: 'paid' }\n                              }).unwrap();\n                              toast.success('Order marked as paid');\n                              refetchQueue();\n                            } catch (error: any) {\n                              toast.error(error?.data?.message || 'Failed to update order status');\n                            }\n                          }}\n                          disabled={!canAct}\n                          className=\"rounded-lg bg-emerald-500/15 text-emerald-700 dark:text-emerald-200 hover:bg-emerald-500/25 disabled:opacity-60\"\n                        >\n                          Mark Paid\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          variant=\"secondary\"\n                          onClick={() => canAct && handleQueueCancel(orderId)}\n                          disabled={!canAct || queueActionOrderId === orderId}\n                          className=\"rounded-lg bg-rose-500/15 text-rose-700 dark:text-rose-200 hover:bg-rose-500/25 disabled:opacity-60\"\n                        >\n                          {queueActionOrderId === orderId ? 'Cancelling...' : 'Cancel'}\n                        </Button>\n                      </>\n                    )}\n                    {order.status === 'paid' && (\n                      <Button\n                        size=\"sm\"\n                        variant=\"secondary\"\n                        onClick={async () => {\n                          if (!canAct) return;\n                          try {\n                            await updateOrder({\n                              id: orderId,\n                              data: { status: 'pending' }\n                            }).unwrap();\n                            toast.success('Order marked as pending');\n                            refetchQueue();\n                          } catch (error: any) {\n                            toast.error(error?.data?.message || 'Failed to update order status');\n                          }\n                        }}\n                        disabled={!canAct}\n                        className=\"rounded-lg bg-amber-500/15 text-amber-700 dark:text-amber-200 hover:bg-amber-500/25 disabled:opacity-60\"\n                      >\n                        Mark Pending\n                      </Button>\n                    )}\n                  </div>\n                </div>\n              );})\n            )}\n          </div>\n        </aside>\n      </>\n    );\n  };\n  // Keyboard shortcuts\n  useEffect(() => {\n    const handleKeyPress = (event: KeyboardEvent) => {\n      // Only handle shortcuts when not typing in input fields\n      if (event.target instanceof HTMLInputElement || event.target instanceof HTMLTextAreaElement) {\n        return;\n      }\n      switch (event.key) {\n        case 'F1':\n          event.preventDefault();\n          setIsQueueCollapsed((prev) => !prev);\n          break;\n        case 'F2':\n          event.preventDefault();\n          if (cart.length > 0) {\n            setIsPaymentModalOpen(true);\n          }\n          break;\n        case 'F3':\n          event.preventDefault();\n          clearCart();\n          break;\n        case 'F4':\n          event.preventDefault();\n          setShowKeyboardShortcuts(!showKeyboardShortcuts);\n          break;\n        case 'F5':\n          event.preventDefault();\n          setIsCalculatorOpen(true);\n          break;\n        case 'Escape':\n          event.preventDefault();\n          setIsPaymentModalOpen(false);\n          setShowKeyboardShortcuts(false);\n          setIsCalculatorOpen(false);\n          setIsQueueCollapsed(true);\n          break;\n        case 'Enter':\n          event.preventDefault();\n          if (cart.length > 0 && !checkoutBlocked) {\n            // In pay-first mode, Enter should open payment modal instead of creating pending order\n            if (paymentMode === 'pay-first') {\n              setIsPaymentModalOpen(true);\n            } else {\n              handleCreateOrder();\n            }\n          }\n          break;\n      }\n    };\n    window.addEventListener('keydown', handleKeyPress);\n    return () => window.removeEventListener('keydown', handleKeyPress);\n  }, [cart.length, selectedTable, showKeyboardShortcuts, handleCreateOrder, requiresTable, checkoutBlocked, paymentMode, setIsPaymentModalOpen, clearCart]);\n  return (\n    !isOwnerOrManager && !workPeriodLoading && !activeWorkPeriod ? (\n      <div className=\"flex items-center justify-center min-h-screen bg-gray-50 dark:bg-slate-950\">\n        <Card className=\"max-w-md w-full mx-4\">\n          <CardContent className=\"p-8 text-center space-y-4\">\n            <LockClosedIcon className=\"w-16 h-16 text-red-500 mx-auto\" />\n            <h2 className=\"text-2xl font-bold text-gray-900 dark:text-white\">\n              POS Terminal Locked\n            </h2>\n            <p className=\"text-gray-600 dark:text-gray-400\">\n              No active work period found. Please ask an owner to start a work period\n              from the Work Periods page before using the POS terminal.\n            </p>\n            <Button\n              className=\"w-full\"\n              onClick={() => (window.location.href = '/dashboard/work-periods')}\n            >\n              Go to Work Periods\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    ) : (\n    <div className=\"h-screen flex flex-col bg-white dark:bg-slate-950 text-gray-900 dark:text-slate-100\">\n      {/* Offline Status Banner */}\n      {!isOnline && (\n        <div className=\"bg-amber-100 dark:bg-amber-900/40 text-amber-800 dark:text-amber-200 px-4 py-2 text-sm flex justify-center items-center gap-2 border-b border-amber-200 dark:border-amber-800/50 shadow-sm z-50 transition-all\">\n          <svg className=\"w-5 h-5 flex-shrink-0\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3\" />\n          </svg>\n          <span className=\"font-semibold\">Offline Mode Active.</span>\n          <span className=\"hidden sm:inline\">Orders will be saved locally.</span>\n          {pendingCount > 0 && (\n            <span className=\"font-bold ml-1 sm:ml-2\">({pendingCount} pending order{pendingCount !== 1 ? 's' : ''} to sync)</span>\n          )}\n        </div>\n      )}\n      {/* Header */}\n      <div className=\"bg-gradient-to-b from-gray-50 via-white to-gray-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950 border-b border-gray-200 dark:border-slate-800 px-3 sm:px-4 md:px-6 py-3 sm:py-4 md:py-5 shadow-lg\">\n        <div className=\"flex flex-col gap-3 sm:gap-4 lg:flex-row lg:items-start lg:justify-between\">\n          <div className=\"flex flex-col gap-2 sm:gap-3\">\n            <div className=\"flex items-center gap-2 sm:gap-3 flex-wrap\">\n              <h1 className=\"text-xl sm:text-2xl font-bold text-gray-900 dark:text-white tracking-tight\">POS System</h1>\n              <Badge className=\"bg-sky-500/15 text-sky-700 dark:text-sky-200 border border-sky-500/30 dark:border-sky-500/50 text-xs sm:text-sm\">\n              {orderTypeLabel}\n            </Badge>\n            </div>\n            <div className=\"flex items-center gap-2 sm:gap-3 flex-wrap text-xs sm:text-sm text-gray-600 dark:text-slate-300\">\n              <TableCellsIcon className=\"h-3 w-3 sm:h-4 sm:w-4 text-slate-400 flex-shrink-0\" />\n              {requiresTable ? (\n                <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                  <select\n                    value={selectedTable}\n                    onChange={(event) => handleTableSelection(event.target.value)}\n                    disabled={tablesLoading || tables.length === 0}\n                    className=\"flex-1 min-w-0 rounded-lg border border-gray-300 dark:border-slate-800 bg-white dark:bg-slate-950/80 px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm text-gray-900 dark:text-slate-100 focus:border-sky-500 focus:outline-none disabled:opacity-60 disabled:cursor-not-allowed\"\n                  >\n                    <option value=\"\">\n                      {tablesLoading ? 'Loading tables' : 'Select a table'}\n                    </option>\n                    {tables.map((table: any) => (\n                      <option\n                        key={table.id}\n                        value={table.id}\n                        disabled={table.status === 'occupied' || table.status === 'reserved'}\n                      >\n                        {table.number || table.tableNumber || table.name || table.id}\n                        {table.status ? `  ${getTableStatusText(table)}` : ''}\n                      </option>\n                    ))}\n                  </select>\n                  {selectedTable && activeTable ? (\n                    <Badge className={`${getTableStatus(activeTable)} border border-white/10`}>\n                      {getTableStatusText(activeTable)}\n                    </Badge>\n                  ) : null}\n                </div>\n              ) : requiresRoomService ? (\n                <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                  <select\n                    value={roomServiceBookingId}\n                    onChange={(event) => setRoomServiceBookingId(event.target.value)}\n                    disabled={roomServiceBookingsLoading || roomServiceBookings.length === 0}\n                    className=\"flex-1 min-w-0 rounded-lg border border-gray-300 dark:border-slate-800 bg-white dark:bg-slate-950/80 px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm text-gray-900 dark:text-slate-100 focus:border-sky-500 focus:outline-none disabled:opacity-60 disabled:cursor-not-allowed\"\n                  >\n                    <option value=\"\">\n                      {roomServiceBookingsLoading\n                        ? 'Loading room bookings'\n                        : roomServiceBookings.length === 0\n                        ? 'No confirmed or checked-in bookings'\n                        : 'Select booking / room'}\n                    </option>\n                    {roomServiceBookings.map((booking: Booking) => (\n                      <option key={booking.id} value={booking.id}>\n                        {booking.roomNumber\n                          ? `Room ${booking.roomNumber}`\n                          : 'Room'}{' '}\n                         {booking.guestName}  {booking.bookingNumber}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n              ) : (\n                <span className=\"text-gray-600 dark:text-slate-200\">\n                  Table not required for this order\n                </span>\n              )}\n            </div>\n            <div className=\"flex flex-wrap items-center gap-2 text-xs text-gray-700 dark:text-slate-200\">\n              <div className=\"flex items-center gap-2 rounded-full border border-gray-300 dark:border-slate-800 bg-gray-50 dark:bg-slate-900/70 px-3 py-1.5 shadow-sm\">\n                <ActiveOrderIcon className=\"h-4 w-4 text-sky-600 dark:text-sky-300\" />\n                <span className=\"font-medium tracking-wide text-gray-900 dark:text-slate-100\">{orderTypeLabel} mode</span>\n          </div>\n              <div className=\"flex items-center gap-1 sm:gap-2 rounded-full border border-gray-300 dark:border-slate-800 bg-gray-50 dark:bg-slate-900/70 px-2 sm:px-3 py-1 sm:py-1.5\">\n                <ClipboardDocumentListIcon className=\"h-3 w-3 sm:h-4 sm:w-4 text-emerald-600 dark:text-emerald-300 flex-shrink-0\" />\n                <span className=\"text-xs sm:text-sm text-gray-900 dark:text-slate-100 whitespace-nowrap\">{orderSummary.itemCount} item{orderSummary.itemCount === 1 ? '' : 's'} in cart</span>\n              </div>\n              <div className=\"flex items-center gap-1 sm:gap-2 rounded-full border border-gray-300 dark:border-slate-800 bg-gray-50 dark:bg-slate-900/70 px-2 sm:px-3 py-1 sm:py-1.5\">\n                <CurrencyDollarIcon className=\"h-3 w-3 sm:h-4 sm:w-4 text-amber-600 dark:text-amber-300 flex-shrink-0\" />\n                <span className=\"text-xs sm:text-sm text-gray-900 dark:text-slate-100 whitespace-nowrap\">Total {formatCurrency(orderSummary.total)}</span>\n              </div>\n              {requiresDeliveryDetails && (\n                <div className={`flex items-center gap-1 sm:gap-2 rounded-full px-2 sm:px-3 py-1 sm:py-1.5 border text-xs sm:text-sm ${deliveryIsValid ? 'border-emerald-500/40 bg-emerald-500/10 dark:text-emerald-200 text-gray-900' : 'border-amber-500/40 bg-amber-500/10 dark:text-amber-100 text-gray-900'}`}>\n                  <TruckIcon className=\"h-3 w-3 sm:h-4 sm:w-4 flex-shrink-0\" />\n                  <span className=\"whitespace-nowrap\">{deliveryIsValid ? 'Delivery details complete' : `Missing ${missingDeliveryFields.length} field${missingDeliveryFields.length === 1 ? '' : 's'}`}</span>\n                </div>\n              )}\n              {requiresTakeawayDetails && (\n                <div className={`flex items-center gap-1 sm:gap-2 rounded-full px-2 sm:px-3 py-1 sm:py-1.5 border text-xs sm:text-sm ${takeawayIsValid ? 'border-emerald-500/40 bg-emerald-500/10 text-emerald-200' : 'border-amber-500/40 bg-amber-500/10 text-amber-100'}`}>\n                  <ShoppingBagIcon className=\"h-3 w-3 sm:h-4 sm:w-4 flex-shrink-0\" />\n                  <span className=\"whitespace-nowrap\">{takeawayIsValid ? 'Takeaway ready' : `Missing ${missingTakeawayFields.length} detail${missingTakeawayFields.length === 1 ? '' : 's'}`}</span>\n                </div>\n              )}\n            </div>\n          </div>\n          <div className=\"flex flex-col gap-2 sm:gap-3 lg:items-end\">\n            <div className=\"flex items-center gap-1 sm:gap-2 flex-wrap justify-start lg:justify-end\">\n                {ORDER_TYPE_OPTIONS.map(({ value, label, icon: Icon }) => {\n                  const isActive = orderType === value;\n                  return (\n                    <Button\n                      key={value}\n                      size=\"sm\"\n                      variant={isActive ? 'primary' : 'secondary'}\n                      onClick={() => handleOrderTypeChange(value)}\n                    className={`flex items-center gap-1 rounded-full px-2 sm:px-3 py-1 sm:py-1.5 text-xs sm:text-sm transition ${isActive ? 'bg-sky-600 hover:bg-sky-500 text-white shadow-lg shadow-sky-600/25' : 'bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-200 hover:bg-gray-200 dark:hover:bg-slate-800/80'}`}\n                    >\n                      <Icon className=\"h-3 w-3 sm:h-4 sm:w-4\" />\n                      <span className=\"hidden sm:inline\">{label}</span>\n                    </Button>\n                  );\n                })}\n              </div>\n            <div className=\"flex items-center gap-1 sm:gap-2 flex-wrap justify-start lg:justify-end w-full lg:w-auto\">\n              <Button\n                variant={isQueueCollapsed ? 'secondary' : 'primary'}\n                onClick={(e) => {\n                  e.preventDefault();\n                  e.stopPropagation();\n                  setIsQueueCollapsed((prev) => !prev);\n                }}\n                className={`flex items-center gap-1 sm:gap-2 rounded-xl text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2 ${\n                  isQueueCollapsed\n                    ? 'bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80'\n                    : 'bg-sky-600 hover:bg-sky-500 text-white shadow-lg shadow-sky-600/25'\n                }`}\n                type=\"button\"\n              >\n                <ClipboardDocumentListIcon className=\"h-3 w-3 sm:h-4 sm:w-4\" />\n                <span className=\"hidden sm:inline\">Orders Queue (F1)</span>\n                <span className=\"sm:hidden\">Queue</span>\n              </Button>\n              <Button\n                variant=\"secondary\"\n                onClick={clearCart}\n                disabled={cart.length === 0}\n                className=\"flex items-center gap-1 sm:gap-2 rounded-xl bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80 disabled:opacity-40 text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2\"\n              >\n                <TrashIcon className=\"h-3 w-3 sm:h-4 sm:w-4\" />\n                <span className=\"hidden sm:inline\">Clear Cart (F3)</span>\n                <span className=\"sm:hidden\">Clear</span>\n              </Button>\n              <Button\n                variant=\"secondary\"\n                onClick={() => setShowKeyboardShortcuts(true)}\n                className=\"flex items-center gap-1 sm:gap-2 rounded-xl bg-slate-900/80 text-slate-100 hover:bg-slate-800/80 text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2\"\n              >\n                <span className=\"hidden sm:inline\"> Shortcuts (F4)</span>\n                <span className=\"sm:hidden\"></span>\n              </Button>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div className=\"flex flex-1 overflow-hidden flex-col xl:flex-row min-h-0\">\n        <div className=\"flex flex-1 flex-col min-w-0 min-h-0 overflow-hidden\">\n          {isOrderingActive ? renderOrderingWorkspace() : renderPreOrderView()}\n        </div>\n        {renderQueuePanel()}\n      </div>\n      {/* Order Cart Modal */}\n      <Modal\n        isOpen={isCartModalOpen}\n        onClose={() => setIsCartModalOpen(false)}\n        title=\"Order Cart\"\n        size=\"xl\"\n      >\n        <div className=\"space-y-6\">\n          <div className=\"space-y-3\">\n            <div className=\"flex flex-wrap items-center gap-2\">\n              {ORDER_TYPE_OPTIONS.map(({ value, label, icon: Icon }) => {\n                const isActive = orderType === value;\n                return (\n                <Button\n                    key={value}\n                    size=\"sm\"\n                    variant={isActive ? 'primary' : 'secondary'}\n                    onClick={() => handleOrderTypeChange(value)}\n                    className={`flex items-center gap-2 rounded-full px-4 py-2 text-sm transition ${\n                      isActive ? 'bg-sky-600 hover:bg-sky-500 text-white shadow shadow-sky-700/30' : 'bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-200 hover:bg-gray-200 dark:hover:bg-slate-800/70'\n                    }`}\n                  >\n                    <Icon className=\"h-4 w-4\" />\n                    {label}\n                  </Button>\n                );\n              })}\n            </div>\n            <div className=\"grid gap-3 sm:grid-cols-2\">\n              <div className=\"space-y-1 rounded-xl border border-gray-300 dark:border-slate-800 bg-gray-50 dark:bg-slate-950/60 p-4\">\n                <p className=\"text-xs uppercase tracking-[0.3em] text-gray-600 dark:text-slate-500\">Table</p>\n                {orderType === 'dine-in' ? (\n                  <div className=\"space-y-3\">\n                    <select\n                      value={selectedTable}\n                      onChange={(event) => handleTableSelection(event.target.value)}\n                      disabled={tablesLoading || tables.length === 0}\n                      className=\"w-full rounded-lg border border-gray-300 dark:border-slate-800 bg-white dark:bg-slate-900/80 px-3 py-2 text-sm text-gray-900 dark:text-slate-100 focus:border-sky-500 focus:outline-none disabled:opacity-60 disabled:cursor-not-allowed\"\n                    >\n                      <option value=\"\">\n                        {tablesLoading ? 'Loading tables' : 'Select a table'}\n                      </option>\n                      {tables.map((table: any) => {\n                        const remainingSeats = table.orderDetails?.remainingSeats ?? table.capacity ?? 0;\n                        const isFullyOccupied = remainingSeats === 0 && table.status === 'occupied';\n                        const isReserved = table.status === 'reserved';\n                        return (\n                          <option \n                            key={table.id} \n                            value={table.id} \n                            disabled={isFullyOccupied || isReserved}\n                          >\n                            {table.number || table.tableNumber || table.name || table.id}\n                            {table.status ? `  ${getTableStatusText(table)}` : ''}\n                            {table.capacity ? `  ${table.capacity} seats` : ''}\n                            {table.orderDetails?.remainingSeats !== undefined && table.orderDetails.remainingSeats > 0 \n                              ? `  ${table.orderDetails.remainingSeats} remaining` \n                              : ''}\n                          </option>\n                        );\n                      })}\n                    </select>\n                    {selectedTable && activeTable && (\n                      <div className=\"space-y-2\">\n                        <label className=\"block text-xs text-gray-600 dark:text-slate-400\">\n                          Number of Guests\n                        </label>\n                        <input\n                          type=\"number\"\n                          min=\"1\"\n                          max={activeTable.orderDetails?.remainingSeats !== undefined \n                            ? activeTable.orderDetails.remainingSeats \n                            : (activeTable.capacity || 99)}\n                          value={guestCount}\n                          onChange={(e) => {\n                            // Calculate max seats correctly: use remaining seats if table has orders, otherwise use full capacity\n                            const maxSeats = activeTable.orderDetails?.remainingSeats !== undefined\n                              ? activeTable.orderDetails.remainingSeats // Don't add guestCount - remainingSeats already accounts for existing orders\n                              : (activeTable.capacity || 99);\n                            const inputValue = parseInt(e.target.value) || 0;\n                            const value = Math.max(1, Math.min(maxSeats, inputValue));\n                            setGuestCount(value);\n                            if (typeof window !== 'undefined') {\n                              localStorage.setItem('pos_guestCount', value.toString());\n                            }\n                          }}\n                          className=\"w-full rounded-lg border border-gray-300 dark:border-slate-800 bg-white dark:bg-slate-900/80 px-3 py-2 text-sm text-gray-900 dark:text-slate-100 focus:border-sky-500 focus:outline-none\"\n                          placeholder=\"Enter guest count\"\n                        />\n                        <p className=\"text-xs text-gray-600 dark:text-slate-500\">\n                          {activeTable.orderDetails?.remainingSeats \n                            ? `${activeTable.orderDetails.remainingSeats} seats available (${activeTable.orderDetails.usedSeats} already used)` \n                            : activeTable.capacity \n                              ? `${activeTable.capacity - guestCount} seats will remain available` \n                              : 'Enter guest count'}\n                        </p>\n                      </div>\n                    )}\n                    {tables.length === 0 && !tablesLoading ? (\n                      <p className=\"text-xs text-slate-400\">No tables available for this branch.</p>\n                    ) : (\n                      <div className=\"flex items-center justify-between text-xs text-gray-600 dark:text-slate-400\">\n                        <span>\n                          {selectedTable\n                            ? `Currently assigned to table ${activeTable?.number || activeTable?.tableNumber || selectedTable}`\n                            : 'Select a table to continue with a dine-in order.'}\n                        </span>\n                        {selectedTable && activeTable && (\n                          <Badge className={`${getTableStatus(activeTable)} border border-white/10`}>\n                            {getTableStatusText(activeTable)}\n                          </Badge>\n                        )}\n                      </div>\n                    )}\n                  </div>\n                ) : (\n                  <p className=\"text-sm text-gray-700 dark:text-slate-300\">Table not required for this order type.</p>\n                )}\n            </div>\n              <div className=\"space-y-1 rounded-xl border border-gray-300 dark:border-slate-800 bg-gray-50 dark:bg-slate-950/60 p-4\">\n                <p className=\"text-xs uppercase tracking-[0.3em] text-gray-600 dark:text-slate-500\">Assigned Waiter</p>\n                <select\n                  value={selectedWaiterId}\n                  onChange={(event) => setSelectedWaiterId(event.target.value)}\n                  disabled={staffLoading || !branchId}\n                  className=\"w-full rounded-lg border border-gray-300 dark:border-slate-800 bg-white dark:bg-slate-900/80 px-3 py-2 text-sm text-gray-900 dark:text-slate-100 focus:border-sky-500 focus:outline-none disabled:opacity-60 disabled:cursor-not-allowed\"\n                >\n                  {staffLoading ? (\n                    <option value=\"\">Loading waiters...</option>\n                  ) : staffError ? (\n                    <option value=\"\">Error loading waiters</option>\n                  ) : waiterOptions.length === 0 ? (\n                    <option value=\"\">No waiters found for this branch</option>\n                  ) : (\n                    waiterOptions.map((waiter) => (\n                      <option key={waiter.id} value={waiter.id} className=\"bg-slate-900\">\n                        {waiter.name}\n                        {waiter.activeOrdersCount > 0 ? ` (${waiter.activeOrdersCount} active order${waiter.activeOrdersCount > 1 ? 's' : ''})` : ''}\n                      </option>\n                    ))\n                  )}\n                </select>\n                {(() => {\n                  const selectedWaiter = waiterOptions.find(w => w.id === selectedWaiterId);\n                  return selectedWaiter && selectedWaiter.activeOrdersCount > 0 ? (\n                    <div className=\"mt-2 flex items-center gap-2 text-xs\">\n                      <div className=\"flex items-center gap-1\">\n                        <div className=\"h-2 w-2 rounded-full bg-amber-500 animate-pulse\"></div>\n                        <span className=\"text-amber-400\">\n                          Waiter has {selectedWaiter.activeOrdersCount} active order{selectedWaiter.activeOrdersCount > 1 ? 's' : ''}\n                        </span>\n                      </div>\n                    </div>\n                  ) : null;\n                })()}\n                {!branchId && (\n                  <p className=\"text-xs text-slate-400 mt-1\">Branch not selected</p>\n                )}\n              </div>\n              </div>\n            <div className=\"space-y-3 rounded-xl border border-gray-300 dark:border-slate-800 bg-gray-50 dark:bg-slate-950/60 p-4\">\n              <div className=\"flex flex-wrap items-center justify-between gap-2\">\n                <div className=\"space-y-1\">\n                  <p className=\"text-xs uppercase tracking-[0.3em] text-gray-600 dark:text-slate-500\">Customer</p>\n                  <div className=\"text-sm text-gray-900 dark:text-slate-200\">\n                    {customerInfo.name ? customerInfo.name : 'Guest customer'}\n                  </div>\n                  {customerInfo.phone && (\n                    <div className=\"text-xs text-gray-600 dark:text-slate-400\">{customerInfo.phone}</div>\n                        )}\n                      </div>\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  {selectedCustomerId && (\n                    <Badge className=\"bg-emerald-500/10 text-emerald-200 border border-emerald-500/30\">\n                      Linked\n                    </Badge>\n                  )}\n                  {selectedCustomer && (\n                    <Badge className=\"bg-amber-500/10 text-amber-200 border border-amber-500/30\">\n                      {selectedCustomer.loyaltyPoints || 0} Points\n                    </Badge>\n                  )}\n                  {loyaltyRedemption.pointsRedeemed > 0 && (\n                    <Badge className=\"bg-purple-500/10 text-purple-200 border border-purple-500/30\">\n                      -{formatCurrency(loyaltyRedemption.discount)} Discount\n                    </Badge>\n                  )}\n                        <Button\n                          size=\"sm\"\n                    variant=\"secondary\"\n                    onClick={() => {\n                      setCustomerSearchTerm('');\n                      setIsCustomerLookupOpen(true);\n                    }}\n                    className=\"bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80\"\n                        >\n                    Lookup\n                        </Button>\n                  {selectedCustomerId && (\n                    <Button\n                      size=\"sm\"\n                      variant=\"ghost\"\n                      onClick={clearCustomerSelection}\n                      className=\"text-gray-600 dark:text-slate-400 hover:text-gray-900 dark:hover:text-slate-100\"\n                    >\n                      Clear\n                    </Button>\n                  )}\n                      </div>\n              </div>\n              <div className=\"grid gap-3 sm:grid-cols-3\">\n                <Input\n                  value={customerInfo.name}\n                  onChange={(event) => setCustomerInfo({ ...customerInfo, name: event.target.value })}\n                  placeholder=\"Customer name\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                />\n                <Input\n                  value={customerInfo.phone}\n                  onChange={(event) => setCustomerInfo({ ...customerInfo, phone: event.target.value })}\n                  placeholder=\"Phone\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                />\n                <Input\n                  value={customerInfo.email}\n                  onChange={(event) => setCustomerInfo({ ...customerInfo, email: event.target.value })}\n                  placeholder=\"Email\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                />\n              </div>\n              {selectedCustomer && (\n                <div className=\"mt-3 p-3 rounded-lg bg-amber-500/10 border border-amber-500/30\">\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span className=\"text-amber-200\">Available Points:</span>\n                    <span className=\"font-semibold text-amber-100\">{selectedCustomer.loyaltyPoints || 0}</span>\n                  </div>\n                  {loyaltyRedemption.pointsRedeemed > 0 && (\n                    <div className=\"mt-2 pt-2 border-t border-amber-500/30\">\n                      <div className=\"flex items-center justify-between text-xs text-amber-300\">\n                        <span>Redeeming:</span>\n                        <span>{loyaltyRedemption.pointsRedeemed} points</span>\n                      </div>\n                      <div className=\"flex items-center justify-between text-xs text-amber-200 mt-1\">\n                        <span>Discount Applied:</span>\n                        <span className=\"font-semibold\">-{formatCurrency(loyaltyRedemption.discount)}</span>\n                      </div>\n                    </div>\n                  )}\n                  {cartSubtotal >= 1000 && loyaltyRedemption.pointsRedeemed === 0 && (selectedCustomer.loyaltyPoints || 0) >= 2000 && (\n                    <div className=\"mt-2 text-xs text-amber-300\">\n                       You can redeem {Math.floor((selectedCustomer.loyaltyPoints || 0) / 2000) * 2000} points for {formatCurrency(Math.floor((selectedCustomer.loyaltyPoints || 0) / 2000) * 20)} discount\n                    </div>\n                  )}\n                  {cartSubtotal < 1000 && (selectedCustomer.loyaltyPoints || 0) >= 2000 && (\n                    <div className=\"mt-2 text-xs text-amber-400\">\n                       Minimum order amount {formatCurrency(1000)} required for loyalty redemption\n                    </div>\n                  )}\n                </div>\n              )}\n          </div>\n          {/* Delivery Details Section */}\n          {orderType === 'delivery' && (\n            <div className=\"space-y-3 rounded-xl border border-gray-300 dark:border-slate-800 bg-gray-50 dark:bg-slate-950/60 p-4\">\n              <p className=\"text-xs uppercase tracking-[0.3em] text-gray-600 dark:text-slate-500\">Delivery Details</p>\n              <div className=\"grid gap-3 sm:grid-cols-2\">\n                <Input\n                  value={deliveryDetails.contactName}\n                  onChange={(e) => setDeliveryDetails({ ...deliveryDetails, contactName: e.target.value })}\n                  placeholder=\"Contact Name *\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                  required\n                />\n                <Input\n                  value={deliveryDetails.contactPhone}\n                  onChange={(e) => setDeliveryDetails({ ...deliveryDetails, contactPhone: e.target.value })}\n                  placeholder=\"Contact Phone *\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                  required\n                />\n                <Input\n                  value={deliveryDetails.addressLine1}\n                  onChange={(e) => setDeliveryDetails({ ...deliveryDetails, addressLine1: e.target.value })}\n                  placeholder=\"Address Line 1 *\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100 sm:col-span-2\"\n                  required\n                />\n                <Input\n                  value={deliveryDetails.addressLine2}\n                  onChange={(e) => setDeliveryDetails({ ...deliveryDetails, addressLine2: e.target.value })}\n                  placeholder=\"Address Line 2\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100 sm:col-span-2\"\n                />\n                <Input\n                  value={deliveryDetails.city}\n                  onChange={(e) => setDeliveryDetails({ ...deliveryDetails, city: e.target.value })}\n                  placeholder=\"City *\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                  required\n                />\n                <Input\n                  value={deliveryDetails.state}\n                  onChange={(e) => setDeliveryDetails({ ...deliveryDetails, state: e.target.value })}\n                  placeholder=\"State/Province\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                />\n                <Input\n                  value={deliveryDetails.postalCode}\n                  onChange={(e) => setDeliveryDetails({ ...deliveryDetails, postalCode: e.target.value })}\n                  placeholder=\"Postal Code\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                />\n                {/* Delivery Zone & Fee */}\n                <div className=\"sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-3\">\n                  <div>\n                    <label className=\"block text-xs text-gray-600 dark:text-slate-400 mb-1\">Delivery Zone</label>\n                    <select\n                      className=\"w-full rounded-md bg-white dark:bg-slate-950/60 border border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100 text-sm px-3 py-2\"\n                      value={(deliveryDetails as any).zoneId || ''}\n                      onChange={(e) => {\n                        const zoneId = e.target.value;\n                        const selectedZone = deliveryZones.find((z) => z.id === zoneId);\n                        setDeliveryDetails({\n                          ...deliveryDetails,\n                          ...(zoneId ? { zoneId } : {}),\n                        } as any);\n                        if (selectedZone) {\n                          const fee = selectedZone.deliveryCharge ?? 0;\n                          const feeStr = fee.toString();\n                          setDeliveryFee(feeStr);\n                          if (typeof window !== 'undefined') {\n                            localStorage.setItem('pos_deliveryFee', feeStr);\n                          }\n                        }\n                      }}\n                      disabled={zonesLoading || deliveryZones.length === 0}\n                    >\n                      <option value=\"\">\n                        {zonesLoading\n                          ? 'Loading zones...'\n                          : deliveryZones.length === 0\n                            ? 'No delivery zones configured'\n                            : 'Select delivery zone'}\n                      </option>\n                      {deliveryZones.map((zone) => (\n                        <option key={zone.id} value={zone.id}>\n                          {zone.name} ({formatCurrency(zone.deliveryCharge)})\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                  <div>\n                    <label className=\"block text-xs text-gray-600 dark:text-slate-400 mb-1\">Delivery Fee</label>\n                    <Input\n                      value={deliveryFee}\n                      onChange={(e) => {\n                        setDeliveryFee(e.target.value);\n                        if (typeof window !== 'undefined') {\n                          localStorage.setItem('pos_deliveryFee', e.target.value);\n                        }\n                      }}\n                      placeholder=\"0.00\"\n                      type=\"number\"\n                      min=\"0\"\n                      step=\"0.01\"\n                      className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                    />\n                  </div>\n                </div>\n                <Input\n                  value={deliveryDetails.instructions}\n                  onChange={(e) => setDeliveryDetails({ ...deliveryDetails, instructions: e.target.value })}\n                  placeholder=\"Delivery Instructions\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100 sm:col-span-2\"\n                />\n                <Input\n                  value={deliveryDetails.assignedDriver}\n                  onChange={(e) => setDeliveryDetails({ ...deliveryDetails, assignedDriver: e.target.value })}\n                  placeholder=\"Assigned Driver\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100 sm:col-span-2\"\n                />\n              </div>\n              {!deliveryIsValid && (\n                <p className=\"text-xs text-amber-400 mt-2\">\n                  * Required fields: {missingDeliveryFields.join(', ')}\n                </p>\n              )}\n            </div>\n          )}\n          {/* Takeaway Details Section */}\n          {orderType === 'takeaway' && (\n            <div className=\"space-y-3 rounded-xl border border-gray-300 dark:border-slate-800 bg-gray-50 dark:bg-slate-950/60 p-4\">\n              <p className=\"text-xs uppercase tracking-[0.3em] text-gray-600 dark:text-slate-500\">Takeaway Details</p>\n              <div className=\"grid gap-3 sm:grid-cols-2\">\n                <Input\n                  value={takeawayDetails.contactName}\n                  onChange={(e) => setTakeawayDetails({ ...takeawayDetails, contactName: e.target.value })}\n                  placeholder=\"Contact Name *\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                  required\n                />\n                <Input\n                  value={takeawayDetails.contactPhone}\n                  onChange={(e) => setTakeawayDetails({ ...takeawayDetails, contactPhone: e.target.value })}\n                  placeholder=\"Contact Phone *\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                  required\n                />\n                <Input\n                  value={takeawayDetails.instructions}\n                  onChange={(e) => setTakeawayDetails({ ...takeawayDetails, instructions: e.target.value })}\n                  placeholder=\"Pickup Instructions\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100 sm:col-span-2\"\n                />\n                <Input\n                  value={takeawayDetails.assignedDriver}\n                  onChange={(e) => setTakeawayDetails({ ...takeawayDetails, assignedDriver: e.target.value })}\n                  placeholder=\"Assigned Staff\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100 sm:col-span-2\"\n                />\n              </div>\n              {!takeawayIsValid && (\n                <p className=\"text-xs text-amber-400 mt-2\">\n                  * Required fields: {missingTakeawayFields.join(', ')}\n                </p>\n              )}\n            </div>\n          )}\n        </div>\n          <div className=\"space-y-3\">\n            <h3 className=\"text-sm font-semibold text-gray-900 dark:text-slate-100\">Items in Cart</h3>\n            <div className=\"max-h-72 overflow-y-auto rounded-xl border border-gray-300 dark:border-slate-850 bg-white dark:bg-slate-950/70\">\n            {cart.length === 0 ? (\n                <div className=\"py-12 text-center text-gray-600 dark:text-slate-500\">\n                  <ShoppingCartIcon className=\"mx-auto mb-3 h-10 w-10 opacity-40\" />\n                  <p>No items yet. Add menu items to begin.</p>\n              </div>\n            ) : (\n                cart.map((item) => {\n                  const itemDiscount = discountMode === 'item' ? itemDiscounts[item.id] : undefined;\n                  const itemDiscountAmount = discountMode === 'item' ? getItemDiscountAmount(item) : 0;\n                  return (\n                    <div key={item.id} className=\"border-b border-gray-300 dark:border-slate-900 last:border-b-0 px-4 py-4\">\n                      <div className=\"flex items-start justify-between gap-4\">\n                        <div className=\"flex-1 space-y-1\">\n                          <div className=\"flex items-center gap-2\">\n                            <h4 className=\"font-semibold text-gray-900 dark:text-slate-100\">{item.name}</h4>\n                            <Badge className=\"bg-gray-100 dark:bg-slate-900/70 text-gray-700 dark:text-slate-300 border border-gray-300 dark:border-slate-800\">\n                              {formatCurrency(item.price)}\n                            </Badge>\n                          </div>\n                          <p className=\"text-xs text-gray-600 dark:text-slate-500\">{item.category}</p>\n                          {item.modifiersNote ? (\n                            <p className=\"text-xs text-gray-600 dark:text-slate-400\">{item.modifiersNote}</p>\n                          ) : null}\n                          {item.notes ? (\n                            <p className=\"text-xs text-gray-600 dark:text-slate-400\">Note: {item.notes}</p>\n                          ) : null}\n                          {itemDiscountAmount > 0 && (\n                            <p className=\"text-xs text-emerald-300\">\n                              Discount: {formatCurrency(itemDiscountAmount)}{' '}\n                              {itemDiscount?.type === 'percent' ? `(${itemDiscount?.value}% )` : ''}\n                          </p>\n                        )}\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={() => updateQuantity(item.id, item.quantity - 1)}\n                            className=\"h-8 w-8 p-0 text-gray-700 dark:text-slate-300 hover:text-gray-900 dark:hover:text-slate-100\"\n                        >\n                          <MinusIcon className=\"h-4 w-4\" />\n                        </Button>\n                          <span className=\"w-8 text-center text-sm font-semibold text-gray-900 dark:text-slate-200\">{item.quantity}</span>\n                        <Button\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={() => updateQuantity(item.id, item.quantity + 1)}\n                            className=\"h-8 w-8 p-0 text-gray-700 dark:text-slate-300 hover:text-gray-900 dark:hover:text-slate-100\"\n                        >\n                          <PlusIcon className=\"h-4 w-4\" />\n                        </Button>\n                          <Button\n                            size=\"sm\"\n                            variant=\"ghost\"\n                            onClick={() => setNoteEditor({ itemId: item.id, value: item.notes || '' })}\n                            className=\"h-8 w-8 p-0 text-sky-300 hover:text-sky-100\"\n                            title=\"Add note\"\n                          >\n                            <PencilSquareIcon className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          onClick={() => removeFromCart(item.id)}\n                            className=\"h-8 w-8 p-0 text-rose-400 hover:text-rose-200\"\n                        >\n                          <TrashIcon className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                      <div className=\"mt-3 flex items-center justify-between text-sm text-gray-700 dark:text-slate-300\">\n                        <span>Line total</span>\n                        <span className=\"font-semibold text-gray-900 dark:text-slate-100\">\n                          {formatCurrency(item.price * item.quantity - itemDiscountAmount)}\n                      </span>\n                    </div>\n              </div>\n                  );\n                })\n            )}\n            </div>\n          </div>\n          <div className=\"space-y-3 rounded-xl border border-gray-300 dark:border-slate-850 bg-gray-50 dark:bg-slate-950/70 p-4\">\n            <div className=\"flex flex-wrap items-center gap-4 text-sm\">\n              <span className=\"font-semibold text-gray-900 dark:text-slate-100\">Discount</span>\n              <label className=\"flex items-center gap-2 text-gray-700 dark:text-slate-300\">\n                <input\n                  type=\"radio\"\n                  name=\"discount-mode\"\n                  value=\"full\"\n                  checked={discountMode === 'full'}\n                  onChange={() => setDiscountMode('full')}\n                  className=\"h-4 w-4 text-sky-500\"\n                />\n                Full order\n              </label>\n              <label className=\"flex items-center gap-2 text-gray-700 dark:text-slate-300\">\n                <input\n                  type=\"radio\"\n                  name=\"discount-mode\"\n                  value=\"item\"\n                  checked={discountMode === 'item'}\n                  onChange={() => setDiscountMode('item')}\n                  className=\"h-4 w-4 text-sky-500\"\n                />\n                Item wise\n              </label>\n                </div>\n            {discountMode === 'full' ? (\n              <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center\">\n                <Input\n                  value={discountValue}\n                  onChange={(event) => setDiscountValue(event.target.value)}\n                  placeholder=\"0\"\n                  type=\"number\"\n                  min=\"0\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                />\n                <select\n                  value={discountType}\n                  onChange={(event) => setDiscountType(event.target.value as 'percent' | 'amount')}\n                  className=\"rounded-lg border border-gray-300 dark:border-slate-800 bg-white dark:bg-slate-900/80 px-3 py-2 text-sm text-gray-900 dark:text-slate-100 focus:border-sky-500 focus:outline-none\"\n                >\n                  <option value=\"percent\">Percent</option>\n                  <option value=\"amount\">Amount</option>\n                </select>\n                </div>\n            ) : (\n              <div className=\"flex flex-wrap items-center gap-3\">\n                <Button\n                  variant=\"secondary\"\n                  size=\"sm\"\n                  onClick={() => setIsItemDiscountModalOpen(true)}\n                  className=\"bg-gray-100 dark:bg-slate-900/80 text-gray-900 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80\"\n                >\n                  Manage item discounts\n                </Button>\n                <span className=\"text-xs text-gray-600 dark:text-slate-400\">\n                  Discounts apply per item; open the editor to adjust amounts.\n                  </span>\n                </div>\n            )}\n              </div>\n              <div className=\"space-y-2\">\n            <label className=\"text-sm font-semibold text-gray-900 dark:text-slate-100\">Order Notes</label>\n            <textarea\n              value={orderNotes}\n              onChange={(event) => setOrderNotes(event.target.value)}\n              placeholder=\"Kitchen or cashier notes, customer requests, etc.\"\n              className=\"w-full min-h-[100px] rounded-xl border border-gray-300 dark:border-slate-850 bg-white dark:bg-slate-950/70 px-3 py-2 text-sm text-gray-900 dark:text-slate-100 placeholder:text-gray-400 dark:placeholder:text-slate-500 focus:border-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-600/40\"\n            />\n          </div>\n          <div className=\"rounded-xl border border-gray-300 dark:border-slate-850 bg-gray-50 dark:bg-slate-950/75 p-4 space-y-2 text-sm\">\n            <div className=\"flex items-center justify-between text-gray-700 dark:text-slate-300\">\n              <span>Subtotal</span>\n              <span className=\"text-gray-900 dark:text-slate-100\">{formatCurrency(orderSummary.subtotal)}</span>\n            </div>\n            {orderSummary.discount > 0 && (\n              <div className=\"flex items-center justify-between text-emerald-600 dark:text-emerald-300\">\n                <span>Discount</span>\n                <span>-{formatCurrency(orderSummary.discount)}</span>\n              </div>\n            )}\n            <div className=\"flex items-center justify-between text-gray-700 dark:text-slate-300\">\n              <span>Tax ({taxRate}%)</span>\n              <span className=\"text-gray-900 dark:text-slate-100\">{formatCurrency(orderSummary.tax)}</span>\n            </div>\n            {orderSummary.deliveryFee > 0 && (\n              <div className=\"flex items-center justify-between text-gray-700 dark:text-slate-300\">\n                <span>Delivery Fee</span>\n                <span className=\"text-gray-900 dark:text-slate-100\">{formatCurrency(orderSummary.deliveryFee)}</span>\n              </div>\n            )}\n            <div className=\"flex items-center justify-between border-t border-gray-300 dark:border-slate-800 pt-3 text-base font-semibold text-emerald-600 dark:text-emerald-400\">\n              <span>Total Due</span>\n              <span>{formatCurrency(orderSummary.total)}</span>\n            </div>\n          </div>\n          {/* Payment Method Selection - Quick Access */}\n          <div className=\"rounded-xl border border-gray-300 dark:border-slate-800 bg-gray-50 dark:bg-slate-950/60 p-4 space-y-3\">\n            <div className=\"flex items-center justify-between\">\n              <label className=\"text-sm font-semibold text-gray-900 dark:text-slate-200\">Payment Method</label>\n              <Button\n                size=\"sm\"\n                variant=\"ghost\"\n                onClick={() => setIsPaymentModalOpen(true)}\n                className=\"text-xs text-sky-400 hover:text-sky-300\"\n              >\n                Change\n              </Button>\n            </div>\n            <div className=\"grid grid-cols-2 sm:grid-cols-3 gap-2\">\n              {paymentMethodsLoading ? (\n                <div className=\"col-span-full text-center text-gray-600 dark:text-slate-400 py-2 text-xs\">Loading payment methods...</div>\n              ) : paymentMethods.length > 0 ? (\n                paymentMethods.slice(0, 6).map((method) => {\n                  const isSelected = fullPaymentMethod === method.code;\n                  return (\n                    <Button\n                      key={method.id}\n                      size=\"sm\"\n                      variant={isSelected ? 'primary' : 'secondary'}\n                      onClick={() => setFullPaymentMethod(method.code)}\n                      className={`flex items-center justify-center gap-2 text-xs ${\n                        isSelected\n                          ? 'bg-emerald-600 hover:bg-emerald-500 text-white'\n                          : 'bg-gray-100 dark:bg-slate-900/80 text-gray-900 dark:text-slate-200 hover:bg-gray-200 dark:hover:bg-slate-800/80'\n                      }`}\n                    >\n                      {method.icon ? (\n                        <span>{method.icon}</span>\n                      ) : method.type === 'cash' ? (\n                        ''\n                      ) : (\n                        <CreditCardIcon className=\"h-3 w-3\" />\n                      )}\n                      <span className=\"truncate\">{method.displayName || method.name}</span>\n                    </Button>\n                  );\n                })\n              ) : (\n                <div className=\"col-span-full text-center text-gray-600 dark:text-slate-400 py-2 text-xs\">\n                  No payment methods available\n                </div>\n              )}\n            </div>\n            {fullPaymentMethod && (\n              <div className=\"text-xs text-gray-600 dark:text-slate-400\">\n                Selected: <span className=\"font-semibold text-gray-900 dark:text-slate-200\">\n                  {paymentMethods.find(m => m.code === fullPaymentMethod)?.displayName || fullPaymentMethod}\n                </span>\n              </div>\n            )}\n          </div>\n          <div className=\"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\n            <div className=\"text-xs text-gray-600 dark:text-slate-500\">\n              {selectedWaiterName ? `Assigned waiter: ${selectedWaiterName}` : 'Waiter not set'}\n            </div>\n            <div className=\"flex flex-col gap-2\">\n              {checkoutBlocked && (\n                <div className=\"text-xs text-rose-400\">\n                  {requiresTable && !selectedTable && 'Please select a table'}\n                  {requiresDeliveryDetails && !deliveryIsValid && `Missing: ${missingDeliveryFields.join(', ')}`}\n                  {requiresTakeawayDetails && !takeawayIsValid && `Missing: ${missingTakeawayFields.join(', ')}`}\n                </div>\n              )}\n              <div className=\"flex flex-wrap gap-2\">\n                <Button\n                  variant=\"secondary\"\n                  onClick={() => setIsCalculatorOpen(true)}\n                  className=\"flex items-center gap-2 bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80\"\n                  title=\"Calculator (F5)\"\n                >\n                  <CurrencyDollarIcon className=\"h-4 w-4\" />\n                  Calculator\n                </Button>\n                {paymentMode === 'pay-later' && (\n                  <Button \n                    variant=\"secondary\" \n                    onClick={handleCreateOrder} \n                    disabled={\n                      checkoutBlocked \n                      || (orderType !== 'room-booking' && cart.length === 0)\n                      || (orderType === 'room-booking' && !roomBookingIsValid)\n                    }\n                    title={\n                      checkoutBlocked \n                        ? (requiresTable && !selectedTable ? 'Select a table first' \n                          : requiresDeliveryDetails && !deliveryIsValid ? `Complete delivery details: ${missingDeliveryFields.join(', ')}` \n                          : requiresTakeawayDetails && !takeawayIsValid ? `Complete takeaway details: ${missingTakeawayFields.join(', ')}` \n                          : requiresRoomService && !roomServiceIsValid ? 'Select a booking/room for room service' \n                          : requiresRoomBooking && !roomBookingIsValid ? 'Complete room booking details (select room, dates, and guest info)' \n                          : '') \n                        : (orderType === 'room-booking' && !roomBookingIsValid) \n                          ? 'Complete room booking details' \n                          : (orderType !== 'room-booking' && cart.length === 0) \n                            ? 'Add items to cart first' \n                            : ''\n                    }\n                  >\n                    <ClockIcon className=\"mr-2 h-4 w-4\" />\n                    Create Order\n                  </Button>\n                )}\n                <Button\n                  variant=\"primary\"\n                  onClick={() => {\n                    // If payment method is selected and it's not cash, open payment modal for amount entry\n                    const selectedMethod = paymentMethods.find(m => m.code === fullPaymentMethod);\n                    const needsAmountEntry = selectedMethod?.code !== 'cash' || paymentMode === 'pay-first';\n                    if (needsAmountEntry) {\n                      setIsPaymentModalOpen(true);\n                    } else {\n                      handlePayment();\n                    }\n                  }}\n                  disabled={\n                    (orderType !== 'room-booking' && orderType !== 'room-service' && cart.length === 0) \n                    || (orderType === 'room-booking' && checkoutBlocked)\n                    || (orderType === 'room-service' && checkoutBlocked)\n                    || (orderType !== 'room-booking' && orderType !== 'room-service' && checkoutBlocked)\n                  }\n                  className=\"bg-emerald-600 hover:bg-emerald-500\"\n                  title={checkoutBlocked ? (requiresTable && !selectedTable ? 'Select a table first' : requiresDeliveryDetails && !deliveryIsValid ? `Complete delivery details: ${missingDeliveryFields.join(', ')}` : requiresTakeawayDetails && !takeawayIsValid ? `Complete takeaway details: ${missingTakeawayFields.join(', ')}` : requiresRoomService && !roomServiceIsValid ? 'Select a booking/room for room service' : requiresRoomBooking && !roomBookingIsValid ? 'Complete room booking details' : '') : (orderType === 'room-booking' || orderType === 'room-service') ? '' : cart.length === 0 ? 'Add items to cart first' : paymentMode === 'pay-first' ? 'Pay-first mode: Payment required before order creation' : ''}\n                >\n                  <CreditCardIcon className=\"mr-2 h-4 w-4\" />\n                  {paymentMode === 'pay-first' ? 'Checkout' : 'Checkout'}\n                </Button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </Modal>\n      {/* Item Discount Modal */}\n      <Modal\n        isOpen={isItemDiscountModalOpen}\n        onClose={() => setIsItemDiscountModalOpen(false)}\n        title=\"Item Discounts\"\n      >\n        <div className=\"space-y-4\">\n          {cart.length === 0 ? (\n            <p className=\"text-sm text-slate-400\">Add items to the cart to configure item-level discounts.</p>\n          ) : (\n            cart.map((item) => {\n              const entry = itemDiscounts[item.id] || { type: 'percent', value: '0' };\n              return (\n                <div key={item.id} className=\"rounded-lg border border-gray-300 dark:border-slate-850 bg-gray-50 dark:bg-slate-950/70 p-4 space-y-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <h4 className=\"text-sm font-semibold text-gray-900 dark:text-slate-100\">{item.name}</h4>\n                      <p className=\"text-xs text-gray-600 dark:text-slate-500\">{formatCurrency(item.price)}  Qty {item.quantity}</p>\n                    </div>\n                <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => updateItemDiscountEntry(item.id, { type: 'percent', value: '0' })}\n                      className=\"text-xs text-gray-600 dark:text-slate-400 hover:text-gray-900 dark:hover:text-slate-100\"\n                    >\n                      Reset\n                </Button>\n              </div>\n                  <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-3\">\n                    <select\n                      value={entry.type}\n                      onChange={(event) =>\n                        updateItemDiscountEntry(item.id, { type: event.target.value as 'percent' | 'amount', value: entry.value })\n                      }\n                      className=\"rounded-lg border border-gray-300 dark:border-slate-800 bg-white dark:bg-slate-900/80 px-3 py-2 text-sm text-gray-900 dark:text-slate-100 focus:border-sky-500 focus:outline-none\"\n                    >\n                      <option value=\"percent\">Percent</option>\n                      <option value=\"amount\">Amount</option>\n                    </select>\n                    <Input\n                      value={entry.value}\n                      onChange={(event) =>\n                        updateItemDiscountEntry(item.id, { type: entry.type, value: event.target.value })\n                      }\n                      placeholder=\"0\"\n                      type=\"number\"\n                      min=\"0\"\n                      className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100 placeholder:text-gray-400 dark:placeholder:text-slate-500\"\n                    />\n                    <div className=\"rounded-lg border border-gray-300 dark:border-slate-800 bg-gray-50 dark:bg-slate-950/60 px-3 py-2 text-sm text-gray-700 dark:text-slate-300\">\n                      Savings: {formatCurrency(getItemDiscountAmount(item))}\n            </div>\n                  </div>\n                </div>\n              );\n            })\n          )}\n        </div>\n      </Modal>\n      {/* Item Note Modal */}\n      <Modal\n        isOpen={Boolean(noteEditor)}\n        onClose={() => setNoteEditor(null)}\n        title=\"Edit Item Note\"\n      >\n        {noteEditor && (\n          <div className=\"space-y-4\">\n            <textarea\n              value={noteEditor.value}\n              onChange={(event) => setNoteEditor({ ...noteEditor, value: event.target.value })}\n              placeholder=\"Add special instructions for this item\"\n              className=\"w-full min-h-[120px] rounded-xl border border-gray-300 dark:border-slate-850 bg-white dark:bg-slate-950/60 px-3 py-2 text-sm text-gray-900 dark:text-slate-100 placeholder:text-gray-400 dark:placeholder:text-slate-500 focus:border-sky-600 focus:outline-none focus:ring-2 focus:ring-sky-600/40\"\n            />\n            <div className=\"flex justify-end gap-2\">\n              <Button variant=\"secondary\" onClick={() => setNoteEditor(null)}>\n                Cancel\n              </Button>\n              <Button\n                onClick={() => {\n                  updateItemNote(noteEditor.itemId, noteEditor.value);\n                  setNoteEditor(null);\n                }}\n                className=\"bg-sky-600 hover:bg-sky-500\"\n              >\n                Save Note\n              </Button>\n      </div>\n          </div>\n        )}\n      </Modal>\n      {/* Customer Lookup Modal */}\n      <Modal\n        isOpen={isCustomerLookupOpen}\n        onClose={() => setIsCustomerLookupOpen(false)}\n        title=\"Customer Lookup\"\n        size=\"lg\"\n      >\n        <div className=\"space-y-4\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2\">Search customers</label>\n            <Input\n              value={customerSearchTerm}\n              onChange={(event) => setCustomerSearchTerm(event.target.value)}\n              placeholder=\"Search by name, phone, or email\"\n              className=\"bg-white dark:bg-slate-950/70 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n            />\n          </div>\n          {customerSearchTerm.trim().length < 2 ? (\n            <p className=\"text-sm text-gray-600 dark:text-slate-400\">\n              Enter at least two characters to search your customer list.\n            </p>\n          ) : isCustomerSearchLoading ? (\n            <div className=\"space-y-3\">\n              {[...Array(3)].map((_, index) => (\n                <div key={index} className=\"h-16 animate-pulse rounded-xl bg-gray-100 dark:bg-slate-900/60\" />\n              ))}\n            </div>\n          ) : resolvedCustomerResults.length > 0 ? (\n            <div className=\"max-h-80 space-y-2 overflow-y-auto pr-1\">\n              {resolvedCustomerResults.map((customer: any) => {\n                const fullName = `${customer.firstName || ''} ${customer.lastName || ''}`.trim() || customer.name || 'Unnamed Customer';\n                const phone = customer.phoneNumber || customer.phone || '';\n                const isActive = selectedCustomerId && (selectedCustomerId === customer.id || selectedCustomerId === customer._id);\n                return (\n                  <button\n                    key={customer.id || customer._id}\n                    onClick={() => applyCustomerSelection(customer)}\n                    className={`w-full rounded-xl border px-4 py-3 text-left transition ${\n                      isActive\n                        ? 'border-emerald-500 bg-emerald-500/10 text-emerald-700 dark:text-emerald-100'\n                        : 'border-gray-300 dark:border-slate-850 bg-white dark:bg-slate-950/70 text-gray-900 dark:text-slate-200 hover:bg-gray-100 dark:hover:bg-slate-900/70'\n                    }`}\n                  >\n                    <div className=\"flex items-center justify-between gap-2\">\n                      <div>\n                        <p className=\"font-semibold\">{fullName}</p>\n                        {phone && <p className=\"text-xs text-slate-400\">{phone}</p>}\n                      </div>\n                      <Badge className=\"bg-gray-100 dark:bg-slate-900/60 text-gray-700 dark:text-slate-300 border border-gray-300 dark:border-slate-800\">\n                        {customer.totalOrders ? `${customer.totalOrders} orders` : 'Customer'}\n                      </Badge>\n                    </div>\n                  </button>\n                );\n              })}\n            </div>\n          ) : (\n            <p className=\"text-sm text-gray-600 dark:text-slate-400\">No customers found for that search.</p>\n          )}\n        </div>\n      </Modal>\n      {/* Payment Modal */}\n      <Modal\n        isOpen={isPaymentModalOpen}\n        onClose={() => setIsPaymentModalOpen(false)}\n        title=\"Checkout Payment\"\n        size=\"lg\"\n      >\n        <div className=\"space-y-6\">\n          <div className=\"flex items-center gap-2 rounded-2xl border border-gray-300 dark:border-slate-800 bg-gray-50 dark:bg-slate-950/60 p-1\">\n              <Button\n              size=\"sm\"\n              variant={paymentTab === 'full' ? 'primary' : 'secondary'}\n              onClick={() => setPaymentTab('full')}\n              className={`flex-1 rounded-xl ${paymentTab === 'full' ? 'bg-emerald-600 hover:bg-emerald-500' : 'bg-transparent text-gray-700 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-900/70'}`}\n              >\n              Full Amount\n              </Button>\n              <Button\n              size=\"sm\"\n              variant={paymentTab === 'multi' ? 'primary' : 'secondary'}\n              onClick={() => setPaymentTab('multi')}\n              className={`flex-1 rounded-xl ${paymentTab === 'multi' ? 'bg-sky-600 hover:bg-sky-500' : 'bg-transparent text-gray-700 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-900/70'}`}\n            >\n              Split Tender\n              </Button>\n          </div>\n          {paymentTab === 'full' ? (\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2\">Select Payment Method</label>\n                <div className=\"grid grid-cols-2 sm:grid-cols-3 gap-2\">\n                  {paymentMethodsLoading ? (\n                    <div className=\"col-span-full text-center text-gray-600 dark:text-slate-400 py-4\">Loading payment methods...</div>\n                  ) : paymentMethods.length > 0 ? (\n                    paymentMethods.map((method) => {\n                      const isSelected = fullPaymentMethod === method.code;\n                      const getIcon = () => {\n                        if (method.icon) return method.icon;\n                        if (method.type === 'cash') return '';\n                        if (method.type === 'card') return <CreditCardIcon className=\"h-4 w-4\" />;\n                        return <CurrencyDollarIcon className=\"h-4 w-4\" />;\n                      };\n                      return (\n                        <Button\n                          key={method.id}\n                          variant={isSelected ? 'primary' : 'secondary'}\n                          onClick={() => setFullPaymentMethod(method.code)}\n                          className={`flex items-center justify-center gap-2 ${\n                            isSelected\n                              ? method.color\n                                ? `bg-[${method.color}] hover:opacity-90`\n                                : 'bg-emerald-600 hover:bg-emerald-500'\n                              : 'bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-200 hover:bg-gray-200 dark:hover:bg-slate-800/80'\n                          }`}\n                        >\n                          {typeof getIcon() === 'string' ? (\n                            <span>{getIcon()}</span>\n                          ) : (\n                            getIcon()\n                          )}\n                          <span className=\"text-xs sm:text-sm\">{method.displayName || method.name}</span>\n                        </Button>\n                      );\n                    })\n                  ) : (\n                    <div className=\"col-span-full text-center text-gray-600 dark:text-slate-400 py-4\">\n                      No payment methods available. Please configure payment methods in settings.\n                    </div>\n                  )}\n                </div>\n              </div>\n          <div>\n                <label className=\"block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2\">Amount received</label>\n            <Input\n                  type=\"number\"\n                  min=\"0\"\n                  step=\"0.01\"\n                  value={fullPaymentReceived}\n                  onChange={(event) => setFullPaymentReceived(event.target.value)}\n                  className=\"bg-white dark:bg-slate-950/70 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                  placeholder=\"0.00\"\n            />\n          </div>\n              {quickCashSuggestions.length > 0 && (\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  {quickCashSuggestions.map((suggestion) => (\n                    <Button\n                      key={suggestion}\n                      size=\"sm\"\n                      variant=\"secondary\"\n                      onClick={() => setFullPaymentReceived(suggestion.toFixed(2))}\n                      className=\"rounded-full bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-200 hover:bg-gray-200 dark:hover:bg-slate-800/80\"\n                    >\n                      {formatCurrency(suggestion)}\n                    </Button>\n                  ))}\n                </div>\n              )}\n              {(() => {\n                const selectedMethod = paymentMethods.find(m => m.code === fullPaymentMethod);\n                const allowsChange = selectedMethod?.allowsChangeDue ?? (fullPaymentMethod === 'cash');\n                return allowsChange && (\n                  <div className=\"text-sm text-gray-700 dark:text-slate-300\">\n                    Change due:{' '}\n                    <span className=\"font-semibold text-emerald-600 dark:text-emerald-300\">{formatCurrency(fullPaymentChange)}</span>\n                  </div>\n                );\n              })()}\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              <div className=\"space-y-3\">\n                {multiPayments.map((row) => {\n                  return (\n                    <div\n                      key={row.id}\n                      className=\"grid gap-3 sm:grid-cols-[160px_1fr_auto] items-center rounded-xl border border-gray-300 dark:border-slate-850 bg-gray-50 dark:bg-slate-950/60 p-3\"\n                    >\n                      <select\n                        value={row.method}\n                        onChange={(event) =>\n                          updateMultiPaymentRow(row.id, { method: event.target.value })\n                        }\n                        className=\"rounded-lg border border-gray-300 dark:border-slate-800 bg-white dark:bg-slate-900/80 px-3 py-2 text-sm text-gray-900 dark:text-slate-100 focus:border-sky-500 focus:outline-none\"\n                        disabled={paymentMethodsLoading}\n                      >\n                        {paymentMethodsLoading ? (\n                          <option>Loading...</option>\n                        ) : paymentMethods.length > 0 ? (\n                          paymentMethods\n                            .filter(method => method.allowsPartialPayment !== false)\n                            .map((method) => (\n                              <option key={method.id} value={method.code} className=\"bg-slate-900\">\n                                {method.displayName || method.name}\n                              </option>\n                            ))\n                        ) : (\n                          <option value=\"\">No methods available</option>\n                        )}\n                      </select>\n                      <Input\n                        type=\"number\"\n                        min=\"0\"\n                        step=\"0.01\"\n                        value={row.amount}\n                        onChange={(event) => updateMultiPaymentRow(row.id, { amount: event.target.value })}\n                        className=\"bg-white dark:bg-slate-950/70 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                        placeholder=\"0.00\"\n                      />\n                      <Button\n                        size=\"sm\"\n                        variant=\"ghost\"\n                        onClick={() => removeMultiPaymentRow(row.id)}\n                        disabled={multiPayments.length === 1}\n                        className=\"text-rose-400 hover:text-rose-200 disabled:opacity-40\"\n                        title={multiPayments.length === 1 ? 'At least one payment row is required' : 'Remove row'}\n                      >\n                        <TrashIcon className=\"h-4 w-4\" />\n                      </Button>\n          </div>\n                  );\n                })}\n            </div>\n            <Button\n              variant=\"secondary\"\n                onClick={addMultiPaymentRow}\n                className=\"w-full rounded-xl bg-gray-100 dark:bg-slate-900/80 text-gray-900 dark:text-slate-200 hover:bg-gray-200 dark:hover:bg-slate-800/80\"\n              >\n                + Add another payment\n              </Button>\n              <div className=\"flex items-center justify-between rounded-xl border border-gray-300 dark:border-slate-850 bg-gray-50 dark:bg-slate-950/70 p-3 text-sm text-gray-700 dark:text-slate-300\">\n                <span>Applied</span>\n                <span className=\"font-semibold text-gray-900 dark:text-slate-100\">{formatCurrency(splitTotals.applied)}</span>\n              </div>\n              <div\n                className={`text-sm ${\n                  splitTotals.remaining > 0\n                    ? 'text-amber-600 dark:text-amber-300'\n                    : splitTotals.remaining < 0\n                    ? 'text-emerald-600 dark:text-emerald-300'\n                    : 'text-gray-700 dark:text-slate-300'\n                }`}\n              >\n                {splitTotals.remaining > 0 && `${formatCurrency(Math.abs(splitTotals.remaining))} remaining`}\n                {splitTotals.remaining < 0 && `${formatCurrency(Math.abs(splitTotals.remaining))} change expected`}\n                {splitTotals.remaining === 0 && 'Ready to settle'}\n              </div>\n            </div>\n          )}\n          <div className=\"rounded-xl border border-gray-300 dark:border-slate-850 bg-gray-50 dark:bg-slate-950/70 p-4 space-y-2 text-sm\">\n            <div className=\"flex items-center justify-between text-gray-700 dark:text-slate-300\">\n              <span>Subtotal</span>\n              <span className=\"text-gray-900 dark:text-slate-100\">{formatCurrency(orderSummary.subtotal)}</span>\n            </div>\n            {orderSummary.discount > 0 && (\n              <div className=\"flex items-center justify-between text-emerald-600 dark:text-emerald-300\">\n                <span>Discount</span>\n                <span>-{formatCurrency(orderSummary.discount)}</span>\n              </div>\n            )}\n            <div className=\"flex items-center justify-between text-gray-700 dark:text-slate-300\">\n              <span>Tax ({taxRate}%)</span>\n              <span className=\"text-gray-900 dark:text-slate-100\">{formatCurrency(orderSummary.tax)}</span>\n            </div>\n            {orderSummary.deliveryFee > 0 && (\n              <div className=\"flex items-center justify-between text-gray-700 dark:text-slate-300\">\n                <span>Delivery Fee</span>\n                <span className=\"text-gray-900 dark:text-slate-100\">{formatCurrency(orderSummary.deliveryFee)}</span>\n              </div>\n            )}\n            <div className=\"flex items-center justify-between border-t border-gray-300 dark:border-slate-800 pt-3 text-base font-semibold text-emerald-600 dark:text-emerald-400\">\n              <span>Total Due</span>\n              <span>{formatCurrency(orderSummary.total)}</span>\n            </div>\n          </div>\n          <div className=\"flex justify-between gap-2\">\n            <Button\n              variant=\"secondary\"\n              onClick={() => setIsCalculatorOpen(true)}\n              className=\"flex items-center gap-2 bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80\"\n              title=\"Calculator (F5)\"\n            >\n              <CurrencyDollarIcon className=\"h-4 w-4\" />\n              Calculator\n            </Button>\n            <div className=\"flex gap-2\">\n              <Button variant=\"secondary\" onClick={() => setIsPaymentModalOpen(false)}>\n                Cancel\n              </Button>\n              <Button\n                onClick={handlePayment}\n                className=\"bg-emerald-600 hover:bg-emerald-500\"\n                disabled={checkoutBlocked || cart.length === 0}\n              >\n                <CheckIcon className=\"h-4 w-4 mr-2\" />\n                Complete Payment\n              </Button>\n            </div>\n          </div>\n        </div>\n      </Modal>\n      {/* Keyboard Shortcuts Modal */}\n      <Modal\n        isOpen={showKeyboardShortcuts}\n        onClose={() => setShowKeyboardShortcuts(false)}\n        title=\"Keyboard Shortcuts\"\n      >\n        <div className=\"space-y-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <h3 className=\"font-semibold text-gray-900 dark:text-white\">Navigation</h3>\n              <div className=\"space-y-1 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span>Toggle Orders Queue</span>\n                  <kbd className=\"px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs\">F1</kbd>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Payment Modal</span>\n                  <kbd className=\"px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs\">F2</kbd>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Clear Cart</span>\n                  <kbd className=\"px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs\">F3</kbd>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Show Shortcuts</span>\n                  <kbd className=\"px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs\">F4</kbd>\n                </div>\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <h3 className=\"font-semibold text-gray-900 dark:text-white\">Actions</h3>\n              <div className=\"space-y-1 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span>Create Order</span>\n                  <kbd className=\"px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs\">Enter</kbd>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Close Modals</span>\n                  <kbd className=\"px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs\">Esc</kbd>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Search Menu</span>\n                  <kbd className=\"px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs\">Ctrl+F</kbd>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span>Quick Add</span>\n                  <kbd className=\"px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs\">Space</kbd>\n                </div>\n              </div>\n            </div>\n          </div>\n          <div className=\"pt-4 border-t border-gray-200 dark:border-gray-700\">\n            <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n               <strong>Tip:</strong> Use keyboard shortcuts to speed up order processing. \n              Focus on menu items and press Space to quickly add to cart.\n            </p>\n          </div>\n        </div>\n      </Modal>\n      {/* Order Detail Modal */}\n      <Modal\n        isOpen={Boolean(queueDetailId)}\n        onClose={() => setQueueDetailId(null)}\n        title=\"Order Details\"\n        size=\"lg\"\n      >\n        {queueDetailLoading ? (\n          <div className=\"py-10 text-center text-slate-400\">Loading order details</div>\n        ) : queueDetail ? (\n          (() => {\n            const detailId = resolveOrderId(queueDetail);\n            const statusKey = (queueDetail.status as 'pending' | 'paid' | 'cancelled') || 'pending';\n            const canActOnOrder = Boolean(detailId);\n            return (\n              <div className=\"space-y-6\">\n                <div className=\"flex flex-wrap items-start justify-between gap-3\">\n                  <div>\n                    <h3 className=\"text-lg font-semibold text-gray-900 dark:text-slate-100\">\n                      {queueDetail.orderNumber || (detailId ? `Order ${String(detailId).slice(-6)}` : 'Order')}\n                    </h3>\n                    <p className=\"text-xs text-gray-600 dark:text-slate-400\">\n                      {queueDetail.createdAt ? formatDateTime(queueDetail.createdAt) : 'N/A'}\n                    </p>\n                  </div>\n                  <Badge className={ORDER_STATUS_STYLES[statusKey] || ORDER_STATUS_STYLES.pending}>\n                    {ORDER_STATUS_LABELS[statusKey] || queueDetail.status}\n                  </Badge>\n                </div>\n                <div className=\"grid gap-3 sm:grid-cols-2\">\n                  <div className=\"rounded-xl border border-gray-300 dark:border-slate-900 bg-gray-50 dark:bg-slate-950/70 px-4 py-3\">\n                    <p className=\"text-xs uppercase tracking-[0.3em] text-gray-600 dark:text-slate-500 mb-1\">Order Type</p>\n                    <p className=\"text-sm font-semibold text-gray-900 dark:text-slate-100\">\n                      {getOrderTypeLabel(queueDetail.orderType as OrderType)}\n                    </p>\n                  </div>\n                  <div className=\"rounded-xl border border-slate-900 bg-slate-950/70 px-4 py-3\">\n                    <p className=\"text-xs uppercase tracking-[0.3em] text-slate-500 mb-1\">Payment</p>\n                    <p className=\"text-sm font-semibold text-slate-100\">\n                      {queueDetail.paymentMethod ? queueDetail.paymentMethod : 'Not recorded'}\n                    </p>\n                  </div>\n                  {queueDetail.customerInfo && (\n                    <div className=\"rounded-xl border border-slate-900 bg-slate-950/70 px-4 py-3 sm:col-span-2\">\n                      <p className=\"text-xs uppercase tracking-[0.3em] text-slate-500 mb-1\">Customer</p>\n                      <div className=\"space-y-1 text-sm text-gray-900 dark:text-slate-200\">\n                        {queueDetail.customerInfo.name && <p>{queueDetail.customerInfo.name}</p>}\n                        {queueDetail.customerInfo.phone && <p>{queueDetail.customerInfo.phone}</p>}\n                        {queueDetail.customerInfo.email && <p>{queueDetail.customerInfo.email}</p>}\n                        {!queueDetail.customerInfo.name &&\n                          !queueDetail.customerInfo.phone &&\n                          !queueDetail.customerInfo.email && <p>No customer details captured.</p>}\n                      </div>\n                    </div>\n                  )}\n                </div>\n                <div>\n                  <h4 className=\"text-sm font-semibold text-gray-900 dark:text-slate-200 uppercase tracking-[0.25em]\">Items</h4>\n                  <div className=\"mt-3 space-y-3\">\n                    {Array.isArray(queueDetail.items) && queueDetail.items.length > 0 ? (\n                      queueDetail.items.map((item: any, index: number) => {\n                        const lookup = menuItemNameById.get(item.menuItemId);\n                        const itemLabel =\n                          lookup?.name ||\n                          item.name ||\n                          item.menuItemName ||\n                          `Item ${index + 1}`;\n                        const itemTotal = Number(item.price || 0) * Number(item.quantity || 0);\n                        return (\n                          <div\n                            key={`${item.menuItemId || index}-${index}`}\n                            className=\"rounded-xl border border-gray-300 dark:border-slate-900 bg-gray-50 dark:bg-slate-950/70 px-4 py-3 text-sm text-gray-900 dark:text-slate-200\"\n                          >\n                            <div className=\"flex items-start justify-between gap-3\">\n                              <div>\n                                <p className=\"font-semibold text-gray-900 dark:text-slate-100\">{itemLabel}</p>\n                                <p className=\"text-xs text-gray-600 dark:text-slate-400\">\n                                  Qty {item.quantity || 0}  {formatCurrency(Number(item.price || 0))}\n                                </p>\n                                {item.notes && (\n                                  <p className=\"mt-2 rounded-lg bg-gray-100 dark:bg-slate-900/60 px-3 py-2 text-xs text-gray-700 dark:text-slate-300 whitespace-pre-line\">\n                                    {item.notes}\n                                  </p>\n                                )}\n                              </div>\n                              <span className=\"text-sm font-semibold text-gray-900 dark:text-slate-100\">\n                                {formatCurrency(itemTotal)}\n                              </span>\n                            </div>\n                          </div>\n                        );\n                      })\n                    ) : (\n                      <div className=\"rounded-xl border border-slate-900 bg-slate-950/70 px-4 py-6 text-center text-xs text-slate-400\">\n                        No line items recorded for this order.\n                      </div>\n                    )}\n                  </div>\n                </div>\n                {queueDetail.notes && (\n                  <div className=\"rounded-xl border border-slate-900 bg-slate-950/70 px-4 py-3 text-sm text-slate-200\">\n                    <p className=\"text-xs uppercase tracking-[0.3em] text-slate-500 mb-1\">Order Notes</p>\n                    <p className=\"whitespace-pre-line\">{queueDetail.notes}</p>\n                  </div>\n                )}\n                <div className=\"flex flex-wrap items-center justify-between gap-3\">\n                  <div className=\"space-y-1 text-sm text-slate-300\">\n                    <div className=\"flex items-center gap-2\">\n                      <CurrencyDollarIcon className=\"h-4 w-4 text-emerald-300\" />\n                      <span className=\"font-semibold text-emerald-300\">\n                        {formatCurrency(Number(queueDetail.totalAmount || 0))}\n                      </span>\n                    </div>\n                    {queueDetail.deliveryFee ? (\n                      <p className=\"text-xs text-slate-400\">\n                        Includes delivery fee of {formatCurrency(Number(queueDetail.deliveryFee || 0))}\n                      </p>\n                    ) : null}\n                  </div>\n                  <div className=\"flex flex-wrap items-center gap-2\">\n                    <Button\n                      variant=\"secondary\"\n                      onClick={() => canActOnOrder && handleViewReceipt(detailId)}\n                      disabled={!canActOnOrder}\n                      className=\"rounded-lg bg-gray-100 dark:bg-slate-900/80 text-gray-900 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80 disabled:opacity-40\"\n                    >\n                      View Receipt\n                    </Button>\n                    <Button\n                      variant=\"secondary\"\n                      onClick={() => canActOnOrder && handlePrintReceipt(detailId, false)}\n                      disabled={!canActOnOrder}\n                      className=\"rounded-lg bg-gray-100 dark:bg-slate-900/80 text-gray-900 dark:text-slate-100 hover:bg-gray-200 dark:hover:bg-slate-800/80 disabled:opacity-40\"\n                    >\n                      Print\n                    </Button>\n                    {queueDetail.status === 'pending' && (\n                      <Button\n                        variant=\"secondary\"\n                        onClick={() => canActOnOrder && handleQueueCancel(detailId)}\n                        disabled={!canActOnOrder || queueActionOrderId === detailId}\n                        className=\"rounded-lg bg-rose-500/15 text-rose-200 hover:bg-rose-500/25 disabled:opacity-60\"\n                      >\n                        {queueActionOrderId === detailId ? 'Cancelling' : 'Cancel Order'}\n                      </Button>\n                    )}\n                  </div>\n                </div>\n              </div>\n            );\n          })()\n        ) : (\n          <div className=\"py-10 text-center text-slate-400\">Order details unavailable.</div>\n        )}\n      </Modal>\n      {/* Receipt Modal - Higher z-index to appear above payment success modal */}\n      <Modal\n        isOpen={isReceiptModalOpen}\n        onClose={() => setIsReceiptModalOpen(false)}\n        title=\"Receipt Preview\"\n        size=\"lg\"\n        className=\"z-[100]\"\n      >\n        <div className=\"space-y-4\">\n          {receiptLoading ? (\n            <div className=\"text-center py-8 text-gray-500\">\n              <ClockIcon className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n              <p>Loading receipt...</p>\n            </div>\n          ) : receiptError ? (\n            <div className=\"rounded-xl border border-slate-800 bg-slate-950/70 px-6 py-5 text-center text-sm text-slate-300 space-y-3\">\n              <p>We couldn't load the receipt for this order.</p>\n              {receiptErrorDetails && 'status' in (receiptErrorDetails as Record<string, unknown>) && (\n                <p className=\"text-xs text-slate-500\">\n                  Error {(receiptErrorDetails as any).status}: {receiptErrorMessage || 'Unexpected error'}\n                </p>\n              )}\n              <Button\n                variant=\"secondary\"\n                onClick={() => currentOrderId && refetchReceipt()}\n                className=\"rounded-full bg-slate-900/80 text-slate-100 hover:bg-slate-800/80\"\n              >\n                Try Again\n              </Button>\n            </div>\n          ) : receiptHTML?.html ? (\n            <div className=\"border rounded-lg p-4 bg-white\">\n              <div \n                dangerouslySetInnerHTML={{ __html: receiptHTML.html }}\n                className=\"receipt-preview\"\n                style={{\n                  fontFamily: 'Courier New, monospace',\n                  fontSize: '12px',\n                  lineHeight: '1.3',\n                  maxWidth: '300px',\n                  margin: '0 auto',\n                }}\n              />\n            </div>\n          ) : (\n            <div className=\"text-center py-8 text-gray-500\">\n              <ClockIcon className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n              <p>No receipt content available for this order.</p>\n            </div>\n          )}\n          <div className=\"flex flex-wrap gap-2 justify-center\">\n            <Button\n              onClick={() => handlePrintReceipt(currentOrderId, false)}\n              variant=\"secondary\"\n              className=\"flex items-center gap-2\"\n            >\n              <PrinterIcon className=\"w-4 h-4\" />\n              Print Receipt\n            </Button>\n            <Button\n              onClick={() => handlePrintReceipt(currentOrderId, true)}\n              variant=\"secondary\"\n              className=\"flex items-center gap-2\"\n            >\n              <PrinterIcon className=\"w-4 h-4\" />\n              Print PDF\n            </Button>\n            <Button\n              onClick={() => handleDownloadReceiptPDF(currentOrderId)}\n              variant=\"secondary\"\n              className=\"flex items-center gap-2\"\n            >\n              <DocumentArrowDownIcon className=\"w-4 h-4\" />\n              Download PDF\n            </Button>\n          </div>\n          {printers && Array.isArray(printers) && printers.length > 0 && (\n            <div className=\"border-t pt-4\">\n              <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                Select Printer (Optional)\n              </label>\n              <select\n                value={selectedPrinter}\n                onChange={(e) => setSelectedPrinter(e.target.value)}\n                className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500\"\n              >\n                <option value=\"\">Default Printer</option>\n                {printers.map((printer) => (\n                  <option key={printer.name} value={printer.name}>\n                    {printer.name} ({printer.type}) - {printer.isOnline ? 'Online' : 'Offline'}\n                  </option>\n                ))}\n              </select>\n            </div>\n          )}\n        </div>\n      </Modal>\n      {/* Modifier Modal */}\n      <Modal\n        isOpen={Boolean(modifierEditor)}\n        onClose={closeModifierEditor}\n        title={modifierEditor ? `Customize ${modifierEditor.item?.name ?? ''}` : 'Customize Item'}\n        size=\"lg\"\n      >\n        {modifierEditor && modifierPreview && (\n          <div className=\"space-y-6\">\n            <div className=\"flex flex-wrap items-center justify-between gap-3 rounded-xl border border-slate-850 bg-slate-950/70 p-4\">\n              <div>\n                <p className=\"text-xs uppercase tracking-[0.3em] text-slate-500\">Unit price</p>\n                <p className=\"text-2xl font-semibold text-emerald-300\">{formatCurrency(modifierPreview.price)}</p>\n                {modifierPreview.modifiersNote && (\n                  <p className=\"mt-1 text-xs text-slate-400\">{modifierPreview.modifiersNote}</p>\n                )}\n    </div>\n              <div className=\"flex items-center gap-3\">\n                <label className=\"text-sm font-medium text-slate-300\">Quantity</label>\n                <Input\n                  type=\"number\"\n                  min=\"1\"\n                  value={modifierEditor.quantity}\n                  onChange={(event) => {\n                    const next = Math.max(1, Number(event.target.value) || 1);\n                    setModifierEditor((prev) => (prev ? { ...prev, quantity: next } : prev));\n                  }}\n                  className=\"w-20 bg-slate-950/70 border-slate-850 text-slate-100\"\n                />\n              </div>\n            </div>\n            {Array.isArray(modifierEditor.item?.variants) && modifierEditor.item.variants.length > 0 && (\n              <div className=\"space-y-3\">\n                <h3 className=\"text-sm font-semibold text-slate-100\">Variants</h3>\n                {modifierEditor.item.variants.map((variant: any) => (\n                  <div key={variant.name} className=\"space-y-2\">\n                    <p className=\"text-xs uppercase tracking-[0.3em] text-slate-500\">{variant.name}</p>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {Array.isArray(variant.options) && variant.options.length > 0 ? (\n                        variant.options.map((option: any) => {\n                          const isActive = modifierEditor.variantSelections[variant.name] === option.name;\n                          const priceLabel = Number(option.priceModifier || 0);\n                          return (\n                            <Button\n                              key={option.name}\n                              size=\"sm\"\n                              variant={isActive ? 'primary' : 'secondary'}\n                              onClick={() =>\n                                setModifierEditor((prev) =>\n                                  prev\n                                    ? {\n                                        ...prev,\n                                        variantSelections: {\n                                          ...prev.variantSelections,\n                                          [variant.name]: option.name,\n                                        },\n                                      }\n                                    : prev\n                                )\n                              }\n                              className={`rounded-full ${\n                                isActive\n                                  ? 'bg-sky-600 hover:bg-sky-500'\n                                  : 'bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-200 hover:bg-gray-200 dark:hover:bg-slate-800/80'\n                              }`}\n                            >\n                              {option.name}\n                              {priceLabel ? ` (+${formatCurrency(priceLabel)})` : ''}\n                            </Button>\n                          );\n                        })\n                      ) : (\n                        <p className=\"text-sm text-slate-400\">No options configured</p>\n                      )}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n            {Array.isArray(modifierEditor.item?.selections) && modifierEditor.item.selections.length > 0 && (\n              <div className=\"space-y-4\">\n                <h3 className=\"text-sm font-semibold text-slate-100\">Selections</h3>\n                {modifierEditor.item.selections.map((selection: any) => {\n                  const currentChoices = modifierEditor.selectionChoices[selection.name] || [];\n                  const selectionType = selection.type || 'single';\n                  return (\n                    <div key={selection.name} className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2 text-xs uppercase tracking-[0.3em] text-slate-500\">\n                        <span>{selection.name}</span>\n                        <Badge className=\"bg-slate-900/70 text-slate-300 border border-slate-800\">\n                          {selectionType === 'multi' ? 'Multiple' : selectionType === 'optional' ? 'Optional' : 'Single'}\n                        </Badge>\n                      </div>\n                      <div className=\"flex flex-wrap gap-2\">\n                        {Array.isArray(selection.options) && selection.options.length > 0 ? (\n                          selection.options.map((option: any) => {\n                            const isActive = currentChoices.includes(option.name);\n                            const priceLabel = Number(option.price || 0);\n                            return (\n                              <Button\n                                key={option.name}\n                                size=\"sm\"\n                                variant={isActive ? 'primary' : 'secondary'}\n                                onClick={() =>\n                                  setModifierEditor((prev) => {\n                                    if (!prev) return prev;\n                                    const previous = prev.selectionChoices[selection.name] || [];\n                                    let nextChoices: string[] = [];\n                                    if (selectionType === 'single') {\n                                      nextChoices = [option.name];\n                                    } else {\n                                      const buffer = new Set(previous);\n                                      if (buffer.has(option.name)) {\n                                        buffer.delete(option.name);\n                                      } else {\n                                        buffer.add(option.name);\n                                      }\n                                      nextChoices = Array.from(buffer);\n                                    }\n                                    return {\n                                      ...prev,\n                                      selectionChoices: {\n                                        ...prev.selectionChoices,\n                                        [selection.name]: nextChoices,\n                                      },\n                                    };\n                                  })\n                                }\n                                className={`rounded-full ${\n                                  isActive\n                                    ? 'bg-amber-500 hover:bg-amber-400'\n                                    : 'bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-200 hover:bg-gray-200 dark:hover:bg-slate-800/80'\n                                }`}\n                              >\n                                {option.name}\n                                {priceLabel ? ` (+${formatCurrency(priceLabel)})` : ''}\n                              </Button>\n                            );\n                          })\n                        ) : (\n                          <p className=\"text-sm text-slate-400\">No options configured</p>\n                        )}\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            )}\n            {Array.isArray(modifierEditor.item?.addons) && modifierEditor.item.addons.some((addon: any) => addon?.isAvailable !== false) && (\n              <div className=\"space-y-3\">\n                <h3 className=\"text-sm font-semibold text-slate-100\">Add-ons</h3>\n                <div className=\"flex flex-wrap gap-2\">\n                  {modifierEditor.item.addons\n                    .filter((addon: any) => addon?.isAvailable !== false)\n                    .map((addon: any) => {\n                      const isActive = Boolean(modifierEditor.addonSelections[addon.name]);\n                      const addonPrice = Number(addon.price || 0);\n                      return (\n                        <Button\n                          key={addon.name}\n                          size=\"sm\"\n                          variant={isActive ? 'primary' : 'secondary'}\n                          onClick={() =>\n                            setModifierEditor((prev) =>\n                              prev\n                                ? {\n                                    ...prev,\n                                    addonSelections: {\n                                      ...prev.addonSelections,\n                                      [addon.name]: !prev.addonSelections[addon.name],\n                                    },\n                                  }\n                                : prev\n                            )\n                          }\n                          className={`rounded-full ${\n                            isActive\n                              ? 'bg-emerald-600 hover:bg-emerald-500'\n                              : 'bg-gray-100 dark:bg-slate-900/80 text-gray-700 dark:text-slate-200 hover:bg-gray-200 dark:hover:bg-slate-800/80'\n                          }`}\n                        >\n                          {addon.name}\n                          {addonPrice ? ` (+${formatCurrency(addonPrice)})` : ''}\n                        </Button>\n                      );\n                    })}\n                </div>\n              </div>\n            )}\n            <div className=\"flex justify-end gap-2\">\n              <Button variant=\"secondary\" onClick={closeModifierEditor}>\n                Cancel\n              </Button>\n              <Button onClick={handleModifierConfirm} className=\"bg-sky-600 hover:bg-sky-500\">\n                Add to Cart\n              </Button>\n            </div>\n          </div>\n        )}\n      </Modal>\n      {/* Occupied Table Modal */}\n      <Modal\n        isOpen={Boolean(occupiedTableModal)}\n        onClose={() => setOccupiedTableModal(null)}\n        title=\"Table is Occupied\"\n        size=\"md\"\n      >\n        {occupiedTableModal && (\n          <div className=\"space-y-4\">\n            <div className=\"rounded-xl border border-orange-500/40 bg-orange-500/10 p-4\">\n              <p className=\"text-sm text-orange-200\">\n                This table has an active order. Choose an action below:\n              </p>\n            </div>\n            {occupiedTableModal.orderDetails && (\n              <div className=\"space-y-3 rounded-xl border border-slate-800 bg-slate-950/60 p-4\">\n                <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                  <div>\n                    <p className=\"text-xs text-slate-400\">Token Number</p>\n                    <p className=\"font-semibold text-slate-100\">{occupiedTableModal.orderDetails.tokenNumber || occupiedTableModal.orderDetails.orderNumber}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-slate-400\">Order Amount</p>\n                    <p className=\"font-semibold text-emerald-400\">{formatCurrency(occupiedTableModal.orderDetails.totalAmount || 0)}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-slate-400\">Order Status</p>\n                    {(() => {\n                      // Get order status from multiple possible locations\n                      const orderDetails = occupiedTableModal.orderDetails;\n                      const orderStatus = orderDetails?.orderStatus \n                        || orderDetails?.status \n                        || orderDetails?.allOrders?.[0]?.status \n                        || 'pending';\n                      const statusLabel = orderStatus === 'paid' ? 'Paid' \n                        : orderStatus === 'pending' ? 'Pending' \n                        : orderStatus === 'cancelled' ? 'Cancelled'\n                        : orderStatus || 'Unknown';\n                      const badgeClass = orderStatus === 'paid' \n                        ? 'bg-emerald-500/10 text-emerald-200 border border-emerald-500/30'\n                        : orderStatus === 'pending'\n                        ? 'bg-amber-500/10 text-amber-200 border border-amber-500/30'\n                        : orderStatus === 'cancelled'\n                        ? 'bg-rose-500/10 text-rose-200 border border-rose-500/30'\n                        : 'bg-slate-500/10 text-slate-200 border border-slate-500/30';\n                      return (\n                        <Badge className={badgeClass}>\n                          {statusLabel}\n                        </Badge>\n                      );\n                    })()}\n                  </div>\n                  {occupiedTableModal.orderDetails.waiterName && (\n                    <div>\n                      <p className=\"text-xs text-slate-400\">Waiter</p>\n                      <p className=\"font-semibold text-slate-100\">{occupiedTableModal.orderDetails.waiterName}</p>\n                    </div>\n                  )}\n                  {occupiedTableModal.orderDetails.holdCount > 0 && (\n                    <div>\n                      <p className=\"text-xs text-slate-400\">Times Held</p>\n                      <p className=\"font-semibold text-orange-400\">{occupiedTableModal.orderDetails.holdCount}x</p>\n                    </div>\n                  )}\n                  <div className=\"col-span-2\">\n                    <p className=\"text-xs text-slate-400\">Used Seats</p>\n                    <p className=\"font-semibold text-slate-100\">\n                      {occupiedTableModal.orderDetails.usedSeats || 0} / {tables.find((t: any) => t.id === occupiedTableModal.tableId)?.capacity || 0}\n                    </p>\n                  </div>\n                  {occupiedTableModal.orderDetails.remainingSeats > 0 && (\n                    <div className=\"col-span-2\">\n                      <p className=\"text-xs text-sky-400\">Remaining Seats</p>\n                      <p className=\"font-semibold text-sky-300\">{occupiedTableModal.orderDetails.remainingSeats} seats available</p>\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n            <div className=\"flex flex-col gap-2\">\n              {(() => {\n                const orderDetails = occupiedTableModal.orderDetails;\n                const currentStatus = orderDetails?.orderStatus \n                  || orderDetails?.status \n                  || orderDetails?.allOrders?.[0]?.status \n                  || 'pending';\n                return (\n                  <>\n                    {currentStatus !== 'paid' && (\n                      <Button\n                        onClick={handleResumeOrder}\n                        className=\"w-full bg-sky-600 hover:bg-sky-500\"\n                      >\n                        Resume & Edit Order\n                      </Button>\n                    )}\n                    {currentStatus === 'pending' && (\n                      <Button\n                        onClick={() => {\n                          if (!occupiedTableModal.orderDetails?.currentOrderId) return;\n                          const orderAmount = occupiedTableModal.orderDetails.totalAmount || 0;\n                          setPendingOrderPaymentReceived(orderAmount.toFixed(2));\n                          // Set default payment method\n                          const defaultMethod = paymentMethods.find(m => m.code === 'cash')?.code || paymentMethods[0]?.code || 'cash';\n                          setPendingOrderPaymentMethod(defaultMethod);\n                          setIsPendingOrderPaymentModalOpen(true);\n                        }}\n                        disabled={paymentMode === 'pay-first'}\n                        className=\"w-full bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed\"\n                        title={paymentMode === 'pay-first' ? 'Pay-first mode is enabled. Pending orders cannot be created or processed.' : ''}\n                      >\n                        Process Payment\n                      </Button>\n                    )}\n                    {currentStatus === 'paid' && (\n                      <>\n                        <Button\n                          onClick={async () => {\n                            if (!occupiedTableModal.tableId) return;\n                            try {\n                              await updateTableStatus({\n                                id: occupiedTableModal.tableId,\n                                status: 'available'\n                              }).unwrap();\n                              toast.success('Table released successfully');\n                              setOccupiedTableModal(null);\n                              refetchTables();\n                            } catch (error: any) {\n                              toast.error(error?.data?.message || 'Failed to release table');\n                            }\n                          }}\n                          className=\"w-full bg-green-600 hover:bg-green-500\"\n                        >\n                          Release Table\n                        </Button>\n                        <Button\n                          onClick={async () => {\n                            if (!occupiedTableModal.orderDetails?.currentOrderId) return;\n                            try {\n                              await updateOrder({\n                                id: occupiedTableModal.orderDetails.currentOrderId,\n                                data: { status: 'pending' }\n                              }).unwrap();\n                              toast.success('Order marked as pending');\n                              setOccupiedTableModal(null);\n                              refetchTables();\n                              refetchQueue();\n                            } catch (error: any) {\n                              toast.error(error?.data?.message || 'Failed to update order status');\n                            }\n                          }}\n                          disabled={true}\n                          variant=\"secondary\"\n                          className=\"w-full disabled:opacity-50 disabled:cursor-not-allowed\"\n                          title=\"Cannot mark paid orders as pending. Use 'Release Table' to free the table.\"\n                        >\n                          Mark as Pending\n                        </Button>\n                      </>\n                    )}\n                  </>\n                );\n              })()}\n              {occupiedTableModal.orderDetails?.remainingSeats > 0 && (\n                <Button\n                  onClick={handleStartNewOrderOnTable}\n                  variant=\"secondary\"\n                  className=\"w-full\"\n                >\n                  Start New Order ({occupiedTableModal.orderDetails.remainingSeats} seats)\n                </Button>\n              )}\n              {(() => {\n                const orderDetails = occupiedTableModal.orderDetails;\n                const currentStatus = orderDetails?.orderStatus \n                  || orderDetails?.status \n                  || orderDetails?.allOrders?.[0]?.status \n                  || 'pending';\n                return currentStatus !== 'paid' ? (\n                  <Button\n                    onClick={handleCancelOccupiedOrder}\n                    variant=\"ghost\"\n                    className=\"w-full text-rose-400 hover:text-rose-300 hover:bg-rose-500/10\"\n                  >\n                    Cancel Order & Free Table\n                  </Button>\n                ) : null;\n              })()}\n              <Button\n                onClick={() => setOccupiedTableModal(null)}\n                variant=\"secondary\"\n                className=\"w-full\"\n              >\n                Close\n              </Button>\n            </div>\n          </div>\n        )}\n      </Modal>\n      {/* Payment Success Modal */}\n      <Modal\n        isOpen={Boolean(paymentSuccessOrder)}\n        onClose={() => setPaymentSuccessOrder(null)}\n        title=\"Payment Completed\"\n        size=\"lg\"\n      >\n        {paymentSuccessOrder && (\n          <div className=\"space-y-5\">\n            <div className=\"rounded-2xl border border-emerald-600/40 bg-emerald-500/10 p-6 text-emerald-100\">\n              <p className=\"text-sm uppercase tracking-[0.3em] text-emerald-200\">Order</p>\n              <h3 className=\"text-2xl font-semibold\">\n                {paymentSuccessOrder.orderNumber ? `Order #${paymentSuccessOrder.orderNumber}` : paymentSuccessOrder.orderId}\n              </h3>\n              <p className=\"mt-2 text-sm text-emerald-100/80\">\n                {paymentSuccessOrder.summary || 'Payment recorded successfully.'}\n              </p>\n            </div>\n            <div className=\"grid gap-4 sm:grid-cols-2\">\n              <div className=\"rounded-xl border border-slate-850 bg-slate-950/70 p-4\">\n                <p className=\"text-xs uppercase tracking-[0.3em] text-slate-500\">Total Paid</p>\n                <p className=\"text-xl font-semibold text-emerald-300\">\n                  {formatCurrency(paymentSuccessOrder.totalPaid)}\n                </p>\n              </div>\n              {paymentSuccessOrder.changeDue !== undefined && (\n                <div className=\"rounded-xl border border-slate-850 bg-slate-950/70 p-4\">\n                  <p className=\"text-xs uppercase tracking-[0.3em] text-slate-500\">Change Due</p>\n                  <p className=\"text-xl font-semibold text-amber-300\">\n                    {formatCurrency(paymentSuccessOrder.changeDue)}\n                  </p>\n                </div>\n              )}\n            </div>\n            {paymentSuccessOrder.breakdown && paymentSuccessOrder.breakdown.length > 0 && (\n              <div className=\"rounded-xl border border-slate-850 bg-slate-950/70 p-4 space-y-2\">\n                <p className=\"text-sm font-semibold text-slate-100\">Payment Breakdown</p>\n                <div className=\"space-y-1 text-sm text-slate-300\">\n                  {paymentSuccessOrder.breakdown.map((row) => (\n                    <div key={`${row.method}-${row.amount}`} className=\"flex items-center justify-between\">\n                      <span className=\"capitalize\">{row.method}</span>\n                      <span className=\"font-semibold text-slate-100\">{formatCurrency(row.amount)}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n            <div className=\"flex flex-wrap justify-end gap-2\">\n              <Button\n                variant=\"secondary\"\n                onClick={() => handleViewReceipt(paymentSuccessOrder.orderId)}\n                className=\"flex items-center gap-2\"\n              >\n                <ClipboardDocumentListIcon className=\"h-4 w-4\" />\n                View Receipt\n              </Button>\n              <Button\n                variant=\"secondary\"\n                onClick={() => handlePrintReceipt(paymentSuccessOrder.orderId, false)}\n                className=\"flex items-center gap-2\"\n              >\n                <PrinterIcon className=\"h-4 w-4\" />\n                Print Receipt\n              </Button>\n              <Button\n                variant=\"secondary\"\n                onClick={() => handlePrintReceipt(paymentSuccessOrder.orderId, true)}\n                className=\"flex items-center gap-2\"\n              >\n                <PrinterIcon className=\"h-4 w-4\" />\n                Print PDF\n              </Button>\n              <Button\n                variant=\"secondary\"\n                onClick={() => handleDownloadReceiptPDF(paymentSuccessOrder.orderId)}\n                className=\"flex items-center gap-2\"\n              >\n                <DocumentArrowDownIcon className=\"h-4 w-4\" />\n                Download PDF\n              </Button>\n              <Button\n                onClick={() => setPaymentSuccessOrder(null)}\n                className=\"bg-emerald-600 hover:bg-emerald-500\"\n              >\n                Done\n              </Button>\n            </div>\n          </div>\n        )}\n      </Modal>\n      {/* Payment Modal for Pending Orders */}\n      <Modal\n        isOpen={isPendingOrderPaymentModalOpen}\n        onClose={() => setIsPendingOrderPaymentModalOpen(false)}\n        title=\"Process Payment\"\n        size=\"md\"\n      >\n        {occupiedTableModal && occupiedTableModal.orderDetails && (\n          <div className=\"space-y-4\">\n            <div className=\"rounded-xl border border-slate-800 bg-slate-950/60 p-4\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <span className=\"text-sm text-slate-400\">Order Amount</span>\n                <span className=\"text-xl font-bold text-emerald-400\">\n                  {formatCurrency(occupiedTableModal.orderDetails.totalAmount || 0)}\n                </span>\n              </div>\n            </div>\n            <div className=\"space-y-3\">\n              <label className=\"block text-sm font-semibold text-slate-200\">Payment Method</label>\n              <div className=\"grid grid-cols-2 gap-2\">\n                {paymentMethods.map((method) => (\n                  <Button\n                    key={method.code}\n                    variant={pendingOrderPaymentMethod === method.code ? 'primary' : 'secondary'}\n                    onClick={() => setPendingOrderPaymentMethod(method.code)}\n                    className={`${\n                      pendingOrderPaymentMethod === method.code\n                        ? 'bg-emerald-600 hover:bg-emerald-500'\n                        : 'bg-slate-900/80 text-slate-200 hover:bg-slate-800/80'\n                    }`}\n                  >\n                    {method.icon && <span className=\"mr-2\">{method.icon}</span>} {method.name}\n                  </Button>\n                ))}\n              </div>\n            </div>\n            {pendingOrderPaymentMethod === 'cash' && (\n              <div className=\"space-y-2\">\n                <label className=\"block text-sm font-semibold text-slate-200\">Amount Received</label>\n                <Input\n                  type=\"number\"\n                  value={pendingOrderPaymentReceived}\n                  onChange={(e) => setPendingOrderPaymentReceived(e.target.value)}\n                  placeholder=\"0.00\"\n                  min=\"0\"\n                  step=\"0.01\"\n                  className=\"bg-white dark:bg-slate-950/60 border-gray-300 dark:border-slate-850 text-gray-900 dark:text-slate-100\"\n                />\n                {parseFloat(pendingOrderPaymentReceived || '0') > (occupiedTableModal.orderDetails.totalAmount || 0) && (\n                  <p className=\"text-sm text-amber-400\">\n                    Change: {formatCurrency(parseFloat(pendingOrderPaymentReceived || '0') - (occupiedTableModal.orderDetails.totalAmount || 0))}\n                  </p>\n                )}\n              </div>\n            )}\n            <div className=\"flex gap-2 pt-4\">\n              <Button\n                variant=\"secondary\"\n                onClick={() => setIsPendingOrderPaymentModalOpen(false)}\n                className=\"flex-1\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={async () => {\n                  if (!occupiedTableModal.orderDetails?.currentOrderId) return;\n                  try {\n                    const orderAmount = occupiedTableModal.orderDetails.totalAmount || 0;\n                    const received = parseFloat(pendingOrderPaymentReceived || '0');\n                    if (pendingOrderPaymentMethod === 'cash' && received < orderAmount) {\n                      toast.error('Amount received must be at least the order amount');\n                      return;\n                    }\n                    // Map payment method code to backend expected format\n                    // Backend accepts 'cash', 'card', or 'split', but we use paymentBreakdown for actual method\n                    const backendMethod = pendingOrderPaymentMethod === 'cash' ? 'cash' : \n                                         pendingOrderPaymentMethod === 'card' || pendingOrderPaymentMethod.includes('CARD') ? 'card' : \n                                         'split';\n                    await processPayment({\n                      orderId: occupiedTableModal.orderDetails.currentOrderId,\n                      amount: orderAmount,\n                      method: backendMethod,\n                      transactionId: undefined,\n                    }).unwrap();\n                    toast.success('Payment processed successfully');\n                    setIsPendingOrderPaymentModalOpen(false);\n                    setOccupiedTableModal(null);\n                    refetchTables();\n                    refetchQueue();\n                  } catch (error: any) {\n                    toast.error(error?.data?.message || 'Failed to process payment');\n                  }\n                }}\n                className=\"flex-1 bg-emerald-600 hover:bg-emerald-500\"\n                disabled={pendingOrderPaymentMethod === 'cash' && parseFloat(pendingOrderPaymentReceived || '0') < (occupiedTableModal.orderDetails.totalAmount || 0)}\n              >\n                Process Payment\n              </Button>\n            </div>\n          </div>\n        )}\n      </Modal>\n      {/* Calculator Modal */}\n      <Calculator\n        isOpen={isCalculatorOpen}\n        onClose={() => setIsCalculatorOpen(false)}\n      />\n    </div>\n    )\n  );\n}\n","usedDeprecatedRules":[]}]
